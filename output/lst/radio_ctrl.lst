C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 21:03:22 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE RADIO_CTRL
OBJECT MODULE PLACED IN .\output\obj\radio_ctrl.obj
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE radio\radio_ctrl.c LARGE OBJECTADVANCED OPTIMIZE(9,SIZE) BROWSE INCDIR(.\co
                    -nfig;.\device;.\display;.\fs;.\key;.\lib_if;.\play;.\system;.\library;.\power;.\radio;.\eeprom;.\spi_flash;.\slave;.\blu
                    -etooth;.\i2c) DEBUG PRINT(.\output\lst\radio_ctrl.lst) OBJECT(.\output\obj\radio_ctrl.obj)

line level    source

   1          #include <string.h>
   2          #include "syscfg.h"
   3          #include "utility.h"
   4          #include "sysctrl.h"
   5          #include "radio_ctrl.h"
   6          #include "mv_fm.h"
   7          #include "radio_app_interface.h"
   8          #include "message.h"
   9          #include "key.h"
  10          #include "gpio.h"
  11          #include "display.h"
  12          #include "24cxx.h"
  13          #include "breakpoint.h"
  14          #include "user_interface.h"
  15          #include "seg_panel.h"
  16          #include "sys_on_off.h"
  17          #include "rtc_ctrl.h"
  18          #include "debug.h"
  19          #include "otp_play.h"
  20          #include "slave_ctrl.h"
  21          #include "pt231x.h"
  22          
  23          #ifdef FUNC_RADIO_EN
  24          
  25          RADIO_CTRL      gRadioCtrl;
  26          BYTE RadioDisFlag;
  27          static BYTE RadioDisCount = 0;
  28          
  29          #ifndef FUNC_BREAK_POINT_EN
              RADIO_DATA        gRadioData2Store;
              #endif
  32          
  33          #ifdef FUNC_RADIO_ESD_AUTO_RESUME
  34          static TIMER RadioStateCheckTimer;
  35          static BYTE RadioStateCheckCount;
  36          WORD gRadioCurrFreqBack;
  37          #endif
  38          
  39          //区分FM的型号
  40          RADIO_NAME      Radio_Name = RADIO_NONE;
  41          #ifdef  FUNC_NUMBER_KEY_EN
  42          extern WORD     gRecvNum;
  43          extern BOOL NumKeyRadioFreqErrorFlag;
  44          extern BOOL NumKeyErrorDispFlag;
  45          #endif
  46          
  47          #ifdef AU6210K_BOOMBOX_DEMO
              BOOL gRadioMonoEnableFlag = FALSE;      
              #endif
  50          
  51          #ifdef  FUNC_DEVICE_FORCEPAUSE_EN
              extern BOOL gDevicePlayForcePauseFlag;
              #endif
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 21:03:22 PAGE 2   

  54          
  55          
  56          #ifdef __RADIOCTRL_DEBUG__
              VOID RadioShowDebug(BYTE Index)
              {
                      BYTE i = 0;
              
                      switch(Index)
                      {
                              case RadioShowPowerOn:
                                      DBG(("Read Data Form EEPROM\n"));
                                      break;  
                                                      
                              case RadioShowCancelSearch:
                                      DBG(("搜台中途退出\n"));        
                                      break;
                      
                              case RadioShowSearchEndOverflow:
                                      DBG(("搜到台数量大于MAX_RADIO_STATION_NUM\n"));
                                      break;
                      
                              case RadioShowSearchEndBufferEnough:
                                      DBG(("0<搜到台数量<buffer长度\n"));
                                      break;
                      
                              case RadioShowSearchUpDown:
                                      DBG(("SCANUP,SCANDOWN:find a channel\n"));
                                      break;
                      
                              case RadioShowSaveCurFreToCurChannle:
                                      DBG(("当前频率保存到当前通道\n"));
                                      break;
                      
                              case RadioShowSaveFre:
                                      DBG(("当前频率保存到某个频道\n"));
                                      break;
                      
                              case RadioShowCurStationChange:
                                      DBG(("通道切换\n"));
                                      break;
                      
                              case RadioShowFreChange:        
                                      DBG(("当前频率改变\n"));
                                      break;
                      }
                      
                      DBG(("频道760~874(start form 1):%2BX\n", gRadioData.Area1StationSum));  
                      DBG(("频道875~1080(start form 1):%2BX\n", (gRadioData.StationSum - gRadioData.Area1StationSum)));                               
                      DBG(("当前频道(start form 0):%2BX\n", gRadioData.CurrStation));
                      
                      DBG(("频道列表(760~874):\n"));
                      for(i = 0; i < gRadioData.Area1StationSum; i++)
                      {
                              DBG(("频道%2BX  %u\n", (i + 1), (gRadioData.Stations[i] + RADIO_FREQ_BASE_760)));
                      }       
              
                      DBG(("频道列表(875~1080):\n")); 
                      for(i = gRadioData.Area1StationSum; i < gRadioData.StationSum; i++)
                      {
                              DBG(("频道%2BX  %u\n", (i + 1), (gRadioData.Stations[i] + RADIO_FREQ_BASE_875)));
                      }       
              }
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 21:03:22 PAGE 3   

              #endif
 117          
 118          
 119          //进入FM前初始化函数
 120          //利用内部FM模块时，底层会在切入通道(DAC_CH_ONCHIP_FM、DAC_CH_ONCHIP_FM_L、DAC_CH_ONCHIP_FM_R)过程中调用此
             -函数
 121          VOID RadioCtrlInit(VOID)
 122          {
 123   1              DBG((">>RadioCtrlInit()\n"));
 124   1      #ifndef FUNC_SPI_KEY_SOUND_EN           
                      RadioSetFreq();
                      RadioMute(FALSE);
                      RadioSetVolume(gSys.Volume);    
              #endif
 129   1      }
 130          
 131          
 132          //离开FM前初始化函数
 133          //利用内部FM模块时，底层会在切离通道(DAC_CH_ONCHIP_FM、DAC_CH_ONCHIP_FM_L、DAC_CH_ONCHIP_FM_R)过程中调用此
             -函数
 134          VOID RadioCtrlDeinit(VOID)
 135          {
 136   1              CancelSearch();
 137   1              MuteOn(TRUE, TRUE);
 138   1              RadioMute(TRUE);
 139   1              RadioPowerDown();
 140   1      #ifdef FUNC_POWER_AMPLIFIER_EN
                      ABPowerAmplifierOn();   //在其它模式下选择AB 类功放
              #endif  
 143   1      }
 144          
 145          
 146          //进入FM 后初始化函数
 147          VOID RadioEnterInit(VOID)
 148          {       
 149   1      #ifdef FUNC_SPI_KEY_SOUND_EN
 150   1              RadioSetFreq();
 151   1              RadioMute(FALSE);
 152   1              RadioSetVolume(gSys.Volume);    
 153   1      #endif
 154   1      
 155   1              gRadioCtrl.State = RADIO_IDLE;
 156   1              UnMute();       
 157   1      
 158   1      #ifdef FUNC_POWER_AMPLIFIER_EN
                      ABPowerAmplifierOff();  //在FM模式下选择D 类功放
              #endif
 161   1              
 162   1      #ifdef FUNC_BREAK_POINT_EN
 163   1              BP_SaveInfo(&gBreakPointInfo.PowerMemory.SystemMode,sizeof(gBreakPointInfo.PowerMemory.SystemMode));
 164   1      #endif
 165   1      
 166   1      #ifdef FUNC_RADIO_ESD_AUTO_RESUME
 167   1              RadioStateCheckCount = 0;
 168   1              TimeOutSet(&RadioStateCheckTimer, 250);
 169   1      #endif
 170   1      }
 171          
 172          
 173          //FM通用功能，和具体的FM型号没有关系
 174          //正在搜台时候中途停止搜台
 175          VOID CancelSearch(VOID)
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 21:03:22 PAGE 4   

 176          {
 177   1              if((gRadioCtrl.State > RADIO_IDLE) && (gRadioCtrl.SeekMode != SEEK_NONE))
 178   1              {
 179   2                      RadioDisFlag = RadioDisCurFreNum;
 180   2                      
 181   2                      if(gRadioData.StationSum > 0)
 182   2                      {
 183   3                              gRadioData.CurrStation = 0;
 184   3                              if(gRadioData.Area1StationSum > 0)
 185   3                              {
 186   4                                      gRadioData.CurrFreq = gRadioData.Stations[gRadioData.CurrStation] + RADIO_FREQ_BASE_760;
 187   4                              }
 188   3                              else
 189   3                              {
 190   4                                      gRadioData.CurrFreq = gRadioData.Stations[gRadioData.CurrStation] + RADIO_FREQ_BASE_875;
 191   4                              }
 192   3                              RadioSetFreq(); 
 193   3                              RadioShowDebug(RadioShowCancelSearch);
 194   3                              RadioWriteData();                       
 195   3                      }
 196   2                      else
 197   2                      {
 198   3                              DBG(("Error:empty\n"));
 199   3                      }
 200   2                      RadioMute(FALSE);               
 201   2                      UnMute();
 202   2                      gRadioCtrl.State = RADIO_IDLE;
 203   2      #ifdef FUNC_SINGLE_LED_EN  
 204   2                      DispDev();
 205   2      #endif
 206   2              }
 207   1      }
 208          
 209          
 210          VOID RadioArrayInsert(VOID)
 211          {
 212   1      #ifdef  FUNC_NUMBER_KEY_EN
 213   1              BYTE i;
 214   1      
 215   1              if(gRecvNum > MAX_RADIO_STATION_NUM)
 216   1              {
 217   2                      return;
 218   2              }
 219   1              
 220   1              if(gRadioData.CurrFreq >= RADIO_FREQ_BASE_875)
 221   1              {
 222   2                      if(gRecvNum > gRadioData.StationSum)//追加到后面
 223   2                      {               
 224   3                              gRadioData.CurrStation = gRadioData.StationSum;                                                 
 225   3                              gRadioData.StationSum++;                                                
 226   3                      }
 227   2                      else//替换
 228   2                      {
 229   3                              gRadioData.CurrStation = gRecvNum - 1;
 230   3                      }
 231   2                      gRadioData.Stations[gRadioData.CurrStation] = (gRadioData.CurrFreq - RADIO_FREQ_BASE_875);
 232   2              }
 233   1              else //760~874
 234   1              {
 235   2                      if(gRecvNum > gRadioData.Area1StationSum)//追加
 236   2                      {
 237   3                              for(i = gRadioData.StationSum; i > gRadioData.Area1StationSum; i--)
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 21:03:22 PAGE 5   

 238   3                              {
 239   4                                      gRadioData.Stations[i] = gRadioData.Stations[i-1];
 240   4                              }
 241   3                                                              
 242   3                              gRadioData.CurrStation = gRadioData.Area1StationSum;
 243   3                              gRadioData.Area1StationSum++;
 244   3                              gRadioData.StationSum++;
 245   3                      }
 246   2                      else//替换
 247   2                      {
 248   3                              gRadioData.CurrStation = gRecvNum - 1;                  
 249   3                      }
 250   2                      gRadioData.Stations[gRadioData.CurrStation] = (gRadioData.CurrFreq - RADIO_FREQ_BASE_760);
 251   2              }
 252   1      #endif
 253   1      }
 254          
 255          
 256          static VOID RadioChannelChange(VOID)
 257          {
 258   1              if((gRadioData.CurrStation + 1) <= gRadioData.Area1StationSum)
 259   1              {
 260   2                      gRadioData.CurrFreq = gRadioData.Stations[gRadioData.CurrStation] + RADIO_FREQ_BASE_760;
 261   2                      DBG(("CH 760+:%u\n", (gRadioData.Stations[gRadioData.CurrStation] + RADIO_FREQ_BASE_760)));
 262   2              }
 263   1              else
 264   1              {
 265   2                      gRadioData.CurrFreq = gRadioData.Stations[gRadioData.CurrStation] + RADIO_FREQ_BASE_875;
 266   2                      DBG(("CH 875+:%u\n", (gRadioData.Stations[gRadioData.CurrStation] + RADIO_FREQ_BASE_875)));
 267   2              }
 268   1      
 269   1              RadioSetFreq();
 270   1              RadioMute(FALSE);                               
 271   1              RadioWriteData();
 272   1              RadioShowDebug(RadioShowCurStationChange);
 273   1      }
 274          
 275                  
 276          //读取有效的预存台号
 277          #ifdef AU6210K_BOOMBOX_DEMO
              static BOOL RadioGetValidPresetNum(BYTE CurrStationNum, BYTE Direction)
              {
                      BYTE Temp;
              
                      if(Direction == UP)
                      {
                              for(Temp = CurrStationNum + 1; Temp < (MAX_RADIO_STATION_NUM / 2); Temp++)
                              {
                                      if(gRadioData.Stations[Temp + (MAX_RADIO_STATION_NUM / 2)])
                                      {
                                              gRadioData.CurrStation = Temp;
                                              return TRUE;
                                      }
                              }
                              for(Temp = 0; Temp < CurrStationNum; Temp++)
                              {
                                      if(gRadioData.Stations[Temp + (MAX_RADIO_STATION_NUM / 2)])
                                      {
                                              gRadioData.CurrStation = Temp;
                                              return TRUE;
                                      }
                              }       
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 21:03:22 PAGE 6   

                      }
                      else 
                      {
                              for(Temp = CurrStationNum; Temp > 0; Temp--)
                              {
                                      if(gRadioData.Stations[Temp + (MAX_RADIO_STATION_NUM / 2)] && (Temp != CurrStationNum))
                                      {
                                              gRadioData.CurrStation = Temp;
                                              return TRUE;
                                      }
                              }
                              for(Temp = ((MAX_RADIO_STATION_NUM / 2) - 1); Temp > CurrStationNum; Temp--)
                              {
                                      if(gRadioData.Stations[Temp + (MAX_RADIO_STATION_NUM / 2)])
                                      {
                                              gRadioData.CurrStation = Temp;
                                              return TRUE;
                                      }
                              }       
                      }
                      
                      if(gRadioData.StationSum == 1)  //只有一个预存台
                      {
                              return TRUE;
                      }
                      
                      return FALSE;   //没有预存台存在
              }
              #endif
 329          
 330                  
 331          //按键响应
 332          VOID RadioEventProcess(VOID)
 333          {
 334   1              MESSAGE Event = MessageGet(MSG_FIFO_KEY);
 335   1              
 336   1              switch(Event)
 337   1              {
 338   2                      case MSG_POWER:
 339   2                      case MSG_MODE_SW:
 340   2                              //DBG(("Exit FM, Event:%bx\n", Event));
 341   2                              CancelSearch();
 342   2                              MessageSend(MSG_FIFO_DEV_CTRL, Event);
 343   2                              break;
 344   2                              
 345   2                      case MSG_SCAN://启动自动全频段搜台
 346   2                      case MSG_INTRO:
 347   2                      case MSG_PLAY_1CP:
 348   2      #if !defined(AU6210K_HXX_B002)                  
 349   2                      case MSG_PLAY_PAUSE:
 350   2      #endif                  
 351   2      #ifdef FUNC_DEVICE_FORCEPAUSE_EN
                                      if(gDevicePlayForcePauseFlag == TRUE)
                                      {
                                              gDevicePlayForcePauseFlag = FALSE;
                                              UnMute();
                                              break;
                                      }
              #endif
 359   2                              DBG(("SCAN\n"));
 360   2      #ifdef FUNC_BEEP_SOUND_EN       
                                      PushKeyBeep(1);
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 21:03:22 PAGE 7   

              #endif
 363   2                              if(gRadioCtrl.State == RADIO_IDLE)
 364   2                              {
 365   3                                      gRadioCtrl.State = RADIO_READ;
 366   3                                      
 367   3                                      gRadioCtrl.SeekMode = SEEK_AUTOSCAN;
 368   3      #ifdef FUNC_SLAVE_UART_EN
                                          gRadioData.CurrFreq = gRadioCtrl.RadioLowerBound;
              #else
 371   3                                      gRadioData.CurrFreq = RADIO_LOWER_BOUND;
 372   3      #endif
 373   3                                      gRadioData.CurrStation = 0;     
 374   3                                      gRadioData.Area1StationSum = 0;
 375   3                                      gRadioData.StationSum = 0;                                      
 376   3                                      memset(&gRadioData.Stations, 0, sizeof(gRadioData.Stations));
 377   3                                      
 378   3                                      MuteOn(TRUE, TRUE);                             
 379   3                                      RadioSetFreq();         
 380   3      #ifdef FUNC_SLAVE_UART_EN
              #ifdef  FUNC_RADIO_AUTOSEEK_EN
                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, gRadioCtrl.RadioUpperBound, gRadioCtrl.RadioSeekStep, 1, 1);
              #else
                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, gRadioCtrl.RadioUpperBound, gRadioCtrl.RadioSeekStep, 0, 1);
              #endif
              
              #else
 388   3      #ifdef  FUNC_RADIO_AUTOSEEK_EN
 389   3                                      MVFM_AutoSeekConfig(gRadioData.CurrFreq, RADIO_UPPER_BOUND, RADIO_SEEK_STEP, 1, 1);
 390   3      #else
                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, RADIO_UPPER_BOUND, RADIO_SEEK_STEP, 0, 1);
              #endif
 393   3      #endif                          
 394   3                                      RadioMute(TRUE);
 395   3                                      TimeOutSet(&gRadioCtrl.SeekPreviewTimer, RadioSeekTimeValue);
 396   3                              }
 397   2                              else
 398   2                              {
 399   3                                      CancelSearch();
 400   3                              }
 401   2                              break;
 402   2      
 403   2                      case MSG_SAVE_STATION:  //保存当前的频率到当前的频道
 404   2                              if(gRadioCtrl.State == RADIO_IDLE)
 405   2                              {               
 406   3                                      if(gRadioData.StationSum < MAX_RADIO_STATION_NUM)
 407   3                                      {               
 408   4                                              if((gRadioData.CurrFreq < RADIO_FREQ_BASE_875) && ((gRadioData.CurrStation + 1) <= gRadioData.Area1St
             -ationSum))
 409   4                                              {
 410   5                                                      gRadioData.Stations[gRadioData.CurrStation] = (gRadioData.CurrFreq - RADIO_FREQ_BASE_760);
 411   5                                              }
 412   4                                              else if((gRadioData.CurrFreq > RADIO_FREQ_BASE_875) && ((gRadioData.CurrStation + 1) > gRadioData.Are
             -a1StationSum))
 413   4                                              {
 414   5                                                      gRadioData.Stations[gRadioData.CurrStation] = (gRadioData.CurrFreq - RADIO_FREQ_BASE_875);
 415   5                                              }                               
 416   4                                              RadioShowDebug(RadioShowSaveCurFreToCurChannle);
 417   4                                              RadioWriteData();
 418   4                                              RadioDisFlag = RadioDisCurFreBlink;
 419   4                                              RadioDisCount = 6;
 420   4                                              TimeOutSet(&gRadioCtrl.SeekPreviewTimer,RadioBlinkTime);
 421   4      #ifdef FUNC_SLAVE_UART_EN
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 21:03:22 PAGE 8   

                                                      SlaveRadioRetCurrentStatus();
              #endif
 424   4      
 425   4                                      }
 426   3                              }
 427   2                              break;
 428   2                      
 429   2                      case MSG_NEXT://下一个台
 430   2                      case MSG_PLAY_1:
 431   2      #ifdef  FUNC_DEVICE_FORCEPAUSE_EN
                                      if(gDevicePlayForcePauseFlag == TRUE) 
                                      {
                                              break;
                                      }                                       
              #endif
 437   2      
 438   2      #ifdef AU6210K_BOOMBOX_DEMO
                                      if(gRadioCtrl.State == RADIO_PROG)
                                      {
                                              if(gRadioData.CurrStation < (MAX_RADIO_STATION_NUM / 2))
                                              {
                                                      gRadioData.CurrStation++;
                                              }
                                              else
                                              {
                                                      gRadioData.CurrStation = 0;
                                              }
                                              break;
                                      }
                                      
                                      if(gRadioCtrl.State == RADIO_IDLE)
                                      {
                                              if(RadioGetValidPresetNum(gRadioData.CurrStation, UP) == TRUE)
                                              {
                                                      RadioDisFlag = RadioDisCurChChange;
                                                      TimeOutSet(&gRadioCtrl.SeekPreviewTimer, RadioPreVimeTimerValue);
                                                      RadioChannelChange();
                                                      UnMute();
                                                      gSys.MuteFg = FALSE;
                                              }
                                              break;
                                      }
              #endif
 465   2      
 466   2                              if((gRadioData.StationSum > 0) && (gRadioCtrl.State == RADIO_IDLE))
 467   2                              {
 468   3      #ifdef FUNC_BEEP_SOUND_EN       
                                              PushKeyBeep(1);
              #endif
 471   3                                      if(gRadioData.CurrStation < (gRadioData.StationSum - 1))
 472   3                                      {
 473   4                                              gRadioData.CurrStation++;
 474   4                                      }
 475   3                                      else
 476   3                                      {
 477   4                                              gRadioData.CurrStation = 0;
 478   4                                      }
 479   3                                      RadioDisFlag = RadioDisCurChChange;                             
 480   3                                      RadioChannelChange();
 481   3                                      UnMute();
 482   3                                      TimeOutSet(&gRadioCtrl.SeekPreviewTimer, RadioPreVimeTimerValue);
 483   3                                      gSys.MuteFg = FALSE;
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 21:03:22 PAGE 9   

 484   3      #ifdef FUNC_SLAVE_UART_EN
                                              SlaveRadioRetCurrentStatus();
              #endif
 487   3                              }
 488   2                              break;
 489   2                              
 490   2                      case MSG_PRE://上一个台
 491   2                      case MSG_EQ_CH_SUB:
 492   2      #ifdef  FUNC_DEVICE_FORCEPAUSE_EN
                                      if(gDevicePlayForcePauseFlag == TRUE) 
                                      {
                                              break;
                                      }                                       
              #endif
 498   2      
 499   2      #ifdef AU6210K_BOOMBOX_DEMO
                                      if(gRadioCtrl.State == RADIO_PROG)
                                      {
                                              if(gRadioData.CurrStation < (MAX_RADIO_STATION_NUM / 2))
                                              {
                                                      gRadioData.CurrStation++;
                                              }
                                              else
                                              {
                                                      gRadioData.CurrStation = 0;
                                              }
                                              break;
                                      }
                                      
                                      if(gRadioCtrl.State == RADIO_IDLE)
                                      {
                                              if(RadioGetValidPresetNum(gRadioData.CurrStation, DOWN) == TRUE)
                                              {
                                                      RadioDisFlag = RadioDisCurChChange;
                                                      TimeOutSet(&gRadioCtrl.SeekPreviewTimer, RadioPreVimeTimerValue);
                                                      RadioChannelChange();
                                                      UnMute();
                                                      gSys.MuteFg = FALSE;
                                                      break;
                                              }
                                      }
              #endif
 526   2      
 527   2                              if((gRadioData.StationSum >  0) && (gRadioCtrl.State == RADIO_IDLE)) 
 528   2                              {
 529   3      #ifdef FUNC_BEEP_SOUND_EN       
                                              PushKeyBeep(1);
              #endif
 532   3                                      if(gRadioData.CurrStation > 0)
 533   3                                      {
 534   4                                              gRadioData.CurrStation--;
 535   4                                      }
 536   3                                      else
 537   3                                      {
 538   4                                              gRadioData.CurrStation = gRadioData.StationSum - 1;
 539   4                                      }
 540   3                                      RadioDisFlag = RadioDisCurChChange;                             
 541   3                                      RadioChannelChange();
 542   3                                      UnMute();
 543   3                                      TimeOutSet(&gRadioCtrl.SeekPreviewTimer, RadioPreVimeTimerValue);
 544   3                                      gSys.MuteFg = FALSE;
 545   3      #ifdef FUNC_SLAVE_UART_EN
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 21:03:22 PAGE 10  

                                              SlaveRadioRetCurrentStatus();
              #endif
 548   3                              }
 549   2                              break;
 550   2                              
 551   2      #ifdef  FUNC_NUMBER_KEY_EN
 552   2                      case MSG_RECV_NUM://选台(输入数值在有效台数内)或设置频率(输入数值在有效频率范围内)      
 553   2                              if(gRadioCtrl.State == RADIO_IDLE)//SeanFu
 554   2                              {
 555   3                                      if((gRecvNum > 0) && (gRecvNum <= gRadioData.StationSum))
 556   3                                      {
 557   4                                              //DBG(("RecvNum合法台号：%d\n", gRecvNum));                             
 558   4                                              gRadioData.CurrStation = gRecvNum - 1;
 559   4                                              if(gRecvNum <= gRadioData.Area1StationSum)
 560   4                                              {
 561   5                                                      gRadioData.CurrFreq = (gRadioData.Stations[gRadioData.CurrStation] + RADIO_FREQ_BASE_760);
 562   5                                              }
 563   4                                              else
 564   4                                              {
 565   5                                                      gRadioData.CurrFreq = (gRadioData.Stations[gRadioData.CurrStation] + RADIO_FREQ_BASE_875);
 566   5                                              }       
 567   4                                              RadioWriteData();
 568   4                                              RadioShowDebug(RadioShowCurStationChange);
 569   4                                      }
 570   3      #ifdef FUNC_SLAVE_UART_EN
                                          else if((gRecvNum >= gRadioCtrl.RadioLowerBound) && (gRecvNum <= gRadioCtrl.Ra
             -dioUpperBound))
              #else
 573   3                                      else if((gRecvNum >= RADIO_LOWER_BOUND) && (gRecvNum <= RADIO_UPPER_BOUND))
 574   3      #endif
 575   3                                      {
 576   4                                              //DBG(("RecvNum合法 频率：%d\n", gRecvNum));
 577   4                                              gRadioData.CurrFreq = gRecvNum;                         
 578   4                                              RadioWriteData();
 579   4                                              RadioShowDebug(RadioShowSaveFre);
 580   4                                      }
 581   3                                      else 
 582   3                                      {
 583   4                                              //DBG(("RecvNum非法：%d\n", gRecvNum)); 
 584   4                                              gRecvNum = 0;                                           
 585   4                                              NumKeyRadioFreqErrorFlag = TRUE;
 586   4                                              NumKeyErrorDispFlag = TRUE;                                     
 587   4      #ifdef FUNC_DISP_EN                                             
 588   4                                              TimeOutSet(&DispTmr, NORMAL_INTERVAL);  //输入错误Err显示保留时间
 589   4      #endif
 590   4                                              return;
 591   4                                      }                       
 592   3                                      RadioSetFreq();
 593   3                                      RadioMute(FALSE);
 594   3                                      gRecvNum = 0;                                   
 595   3      #ifdef FUNC_DISP_EN                                             
 596   3                                      TimeOutSet(&DispTmr, 0);        //退出数值显示
 597   3      #endif
 598   3                              }
 599   2                              break;
 600   2      
 601   2                      case MSG_NUM_SAVE_STAITON:      //将当前频率保存起来
 602   2                              if(gRadioCtrl.State == RADIO_IDLE)
 603   2                              {                               
 604   3                                      //DBG(("RecvNum %d \n", gRecvNum));
 605   3                                      RadioArrayInsert();
 606   3                                      gRecvNum = 0;
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 21:03:22 PAGE 11  

 607   3                                      RadioWriteData();
 608   3                                      RadioShowDebug(RadioShowSaveFre);
 609   3                                      RadioDisFlag = RadioDisCurFreBlink;
 610   3                                      RadioDisCount = 4;
 611   3                                      TimeOutSet(&gRadioCtrl.SeekPreviewTimer, RadioBlinkTime);
 612   3                              }
 613   2                              break;
 614   2      #endif
 615   2                              
 616   2      #ifdef  FUNC_RADIO_STEPOVER_EN          
                              case MSG_NEXT1:
                              case MSG_FREQ_UP:
                              case MSG_FREQUP_10TRK://循环递增微调频率(+100KHZ)       
                                      if(gRadioCtrl.State == RADIO_IDLE)
                                      {
              #ifdef FUNC_SLAVE_UART_EN
                                          if(++gRadioData.CurrFreq > gRadioCtrl.RadioUpperBound)
                                              {
                                                      gRadioData.CurrFreq = gRadioCtrl.RadioLowerBound;
                                              }
              #else
                                              if(++gRadioData.CurrFreq > RADIO_UPPER_BOUND)
                                              {
                                                      gRadioData.CurrFreq = RADIO_LOWER_BOUND;
                                              }
              #endif
                                              RadioSetFreq();
                                              RadioMute(FALSE);               
                                              RadioWriteData();
                                              RadioShowDebug(RadioShowFreChange);
                                      }
                                      break;
                              
                              case MSG_PREV1:
                              case MSG_FREQ_DN:
                              case MSG_FREQDN_10TRK://循环递减微调频率(-100KHZ)               
                                      if(gRadioCtrl.State == RADIO_IDLE)
                                      {
              #ifdef FUNC_SLAVE_UART_EN
                                          if(--gRadioData.CurrFreq < gRadioCtrl.RadioLowerBound)
                                              {
                                                      gRadioData.CurrFreq = gRadioCtrl.RadioUpperBound;
                                              }       
              #else
                                              if(--gRadioData.CurrFreq < RADIO_LOWER_BOUND)
                                              {
                                                      gRadioData.CurrFreq = RADIO_UPPER_BOUND;
                                              }       
              #endif
                                              RadioSetFreq();
                                              RadioMute(FALSE);               
                                              RadioWriteData();
                                              RadioShowDebug(RadioShowFreChange);
                                      }
                                      break;
              #endif
 663   2                      
 664   2      #ifdef  FUNC_RADIO_SEMO_AUTOSEEK_EN             
                              case MSG_FF_START:
                              case MSG_10TRACK_ADD://递增方式搜台，搜到第一个后停止
                                      if(gRadioCtrl.State == RADIO_IDLE)
                                      {
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 21:03:22 PAGE 12  

                                              gRadioCtrl.SeekMode = SEEK_SCANUP;
              #ifdef FUNC_SLAVE_UART_EN
                                          if(gRadioData.CurrFreq >= gRadioCtrl.RadioUpperBound)
                                              {       
                                                      gRadioData.CurrFreq = gRadioCtrl.RadioLowerBound;
                                              }
                                              else
                                              {
                                                      gRadioData.CurrFreq++;
                                              }
              #else
                                              if(gRadioData.CurrFreq >= RADIO_UPPER_BOUND)
                                              {       
                                                      gRadioData.CurrFreq = RADIO_LOWER_BOUND;
                                              }
                                              else
                                              {
                                                      gRadioData.CurrFreq++;
                                              }
              #endif                          
                                              MuteOn(TRUE, TRUE);     
                                              RadioSetFreq();                                         
                                              gRadioCtrl.State = RADIO_READ;
              #ifdef FUNC_SLAVE_UART_EN
              #ifdef  FUNC_RADIO_AUTOSEEK_EN
                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, gRadioCtrl.RadioUpperBound, gRadioCtrl.RadioSeekStep, 1, 1);
              #else
                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, gRadioCtrl.RadioUpperBound, gRadioCtrl.RadioSeekStep, 0, 1);
              #endif
              #else
              #ifdef  FUNC_RADIO_AUTOSEEK_EN
                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, RADIO_UPPER_BOUND, RADIO_SEEK_STEP, 1, 1);
              #else
                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, RADIO_UPPER_BOUND, RADIO_SEEK_STEP, 0, 1);
              #endif
              #endif
                                              RadioMute(TRUE);
                                              TimeOutSet(&gRadioCtrl.SeekPreviewTimer, RadioSeekTimeValue);
                                                      
                                      }
                                      break;
                              
                              case MSG_FB_START:
                              case MSG_10TRACK_SUB://递减方式搜台，搜到第一个后停止
                                      if(gRadioCtrl.State == RADIO_IDLE)
                                      {
                                              gRadioCtrl.SeekMode = SEEK_SCANDOWN;
              #ifdef FUNC_SLAVE_UART_EN
                                          if(gRadioData.CurrFreq <= gRadioCtrl.RadioLowerBound)
                                              {
                                                      gRadioData.CurrFreq = gRadioCtrl.RadioUpperBound;
                                              }
                                              else
                                              {
                                                      gRadioData.CurrFreq--;
                                              }
              #else                           
                                              if(gRadioData.CurrFreq <= RADIO_LOWER_BOUND)
                                              {
                                                      gRadioData.CurrFreq = RADIO_UPPER_BOUND;
                                              }
                                              else
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 21:03:22 PAGE 13  

                                              {
                                                      gRadioData.CurrFreq--;
                                              }
              #endif                          
                                              MuteOn(TRUE, TRUE);     
                                              RadioSetFreq();                                         
                                              gRadioCtrl.State = RADIO_READ;
              #ifdef FUNC_SLAVE_UART_EN
              #ifdef  FUNC_RADIO_AUTOSEEK_EN
                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, gRadioCtrl.RadioLowerBound, gRadioCtrl.RadioSeekStep, 1, 1);
              #else
                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, gRadioCtrl.RadioLowerBound, gRadioCtrl.RadioSeekStep, 0, 1);
              #endif
              #else
              #ifdef  FUNC_RADIO_AUTOSEEK_EN
                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, RADIO_LOWER_BOUND, RADIO_SEEK_STEP, 1, 1);
              #else
                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, RADIO_LOWER_BOUND, RADIO_SEEK_STEP, 0, 1);
              #endif
              #endif
                                              RadioMute(TRUE);
                                              TimeOutSet(&gRadioCtrl.SeekPreviewTimer, RadioSeekTimeValue);
                                                      
                                      }
                                      break;
              #endif
 757   2      
 758   2                      case MSG_VOL_ADD://音量加                                       
 759   2      #if defined(AU6210K_NR_D_9X)||defined(AU6210K_NR_D_9X_XJ_HTS)
                                      if (gSys.Volume >= VOLUME_MAX)
                                      {
                                              SPI_PlaySelectNum(SPIPLAY_SONG_MAX_VOLUME, 0);
                                              InDacChannelSel(DAC_CH_ONCHIP_FM);
                                              RadioSetFreq();
                                              UnMute();
                                              SysClkDivSet(CLK_DIV_RATE);
                                      }
              #endif
 769   2      
 770   2      #ifdef FUNC_POWER_AMPLIFIER_EN
                                      ABPowerAmplifierOff();                  
              #endif
 773   2      
 774   2      #ifdef FUNC_OTP_KEY_SOUND_EN
                                      OTP_PlaySelNum(OTPPLAY_NUM_VOLUP, 0);
                                      InDacChannelSel(DAC_CH_ONCHIP_FM);
                                      RadioSetFreq();
                                      UnMute();
                                      SysClkDivSet(CLK_DIV_RATE);
              #endif
 781   2      #ifdef FUNC_PT231X_EN
                          VolType = VOL_MAIN;
                          PT2313VolAdd();
              #else
 785   2                              VolumeAdjust(UP);
 786   2                      #ifdef AU6210K_MINI503
 787   2                              if (gSys.Volume >= VOLUME_MAX)
 788   2                              {
 789   3                                      if(SPI_PlaySelectNum(SPIPLAY_SONG_MAX_VOLUME, 0))
 790   3                                      {
 791   4                                              InDacChannelSel(DAC_CH_ONCHIP_FM);
 792   4                                              RadioSetFreq();
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 21:03:22 PAGE 14  

 793   4                                              RadioMute(FALSE);
 794   4                                              UnMute();
 795   4                                              SysClkDivSet(CLK_DIV_RATE);
 796   4                                      }
 797   3                              }
 798   2                      #endif
 799   2      #endif
 800   2                              break;
 801   2                      
 802   2                      case MSG_VOL_SUB://音量减                       
 803   2      #if defined(AU6210K_NR_D_9X)||defined(AU6210K_NR_D_9X_XJ_HTS)
                                      if (gSys.Volume <= VOLUME_MIN)
                                      {
                                              SPI_PlaySelectNum(SPIPLAY_SONG_MIN_VOLUME, 0);
                                              InDacChannelSel(DAC_CH_ONCHIP_FM);
                                              RadioSetFreq();
                                              SysClkDivSet(CLK_DIV_RATE);
                                      }
              #endif
 812   2      
 813   2      #ifdef FUNC_POWER_AMPLIFIER_EN
                                      ABPowerAmplifierOff();                  
              #endif
 816   2      
 817   2      #ifdef FUNC_OTP_KEY_SOUND_EN
                                      OTP_PlaySelNum(OTPPLAY_NUM_VOLDN, 0);
                                      InDacChannelSel(DAC_CH_ONCHIP_FM);
                                      RadioSetFreq();
                                      UnMute();
                                      SysClkDivSet(CLK_DIV_RATE);
              #endif
 824   2      #ifdef FUNC_PT231X_EN
                                  VolType = VOL_MAIN;
                                  PT2313VolSub();
              #else
 828   2                              VolumeAdjust(DOWN);
 829   2                      #ifdef AU6210K_MINI503
 830   2                              if (gSys.Volume <= VOLUME_MIN)
 831   2                              {
 832   3                                      if(SPI_PlaySelectNum(SPIPLAY_SONG_MIN_VOLUME, 0))
 833   3                                      {
 834   4                                              RadioMute(FALSE);
 835   4                                              InDacChannelSel(DAC_CH_ONCHIP_FM);
 836   4                                              RadioSetFreq();
 837   4                                              SysClkDivSet(CLK_DIV_RATE);
 838   4                                      }
 839   3                              }
 840   2                      #endif
 841   2      #endif
 842   2                              break;
 843   2      #ifdef FUNC_PT231X_EN
                            case MSG_TREBUP:
                                      VolType = VOL_TREB;
                                   PT2313VolAdd();    
                                      break;          
                              case MSG_TREBDN:
                                      VolType = VOL_TREB;
                                   PT2313VolSub();    
                                      break;          
                              case MSG_BASSUP:
                                      VolType = VOL_BASS;
                                   PT2313VolAdd();    
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 21:03:22 PAGE 15  

                                      break;          
                              case MSG_BASSDN:
                                      VolType = VOL_BASS;
                                   PT2313VolSub();    
                                      break;          
                              case MSG_DEFAULT:
                                      PT2313TrebBassSetDefault();
                                      break;          
              #endif
 864   2      #if defined(AU6210K_HXX_B002)
                              case MSG_PLAY_PAUSE:
              #endif
 867   2                      case MSG_MUTE:
 868   2                              if(gRadioCtrl.State == RADIO_IDLE)
 869   2                              {                       
 870   3      #if 0//def FUNC_SPI_KEY_SOUND_EN
                                              if(gSys.MuteFg)
                                              {
                                                      SPI_PlaySelectNum(SPIPLAY_SONG_UNMUTE, 0);
                                              }
                                              else
                                              {       
                                                      SPI_PlaySelectNum(SPIPLAY_SONG_MUTE, 0);
                                              }                               
                                              InDacChannelSel(DAC_CH_ONCHIP_FM);
                                              if(gSys.MuteFg)
                                              {
                                                      RadioSetFreq();
                                                      gSys.MuteFg = TRUE;
                                              }
                                              SysClkDivSet(CLK_DIV_RATE);
              #endif
 887   3                                      MuteStatusChange();                     
 888   3                              }
 889   2                              break;  
 890   2                      
 891   2      #if (defined(AU6210K_BOOMBOX_DEMO))
                              case MSG_CLOCK:                 
                                      if(gRadioCtrl.State == RADIO_IDLE)
                                      {
                                              gRadioCtrl.State = RADIO_PROG;
                                              RadioDisFlag = RadioDisCurProgramNum;
                                              TimeOutSet(&gRadioCtrl.SeekPreviewTimer, RadioProgramWaitTime);
                                              break;
                                      }       
              
                                      if(gRadioCtrl.State == RADIO_PROG)
                                      {               
                                              if(gRadioData.CurrFreq < RADIO_FREQ_BASE_875) 
                                              {
                                                      gRadioData.Stations[gRadioData.CurrStation] = (gRadioData.CurrFreq - RADIO_FREQ_BASE_760);
                                              }
                                              else if(gRadioData.CurrFreq > RADIO_FREQ_BASE_875)
                                              {
                                                      gRadioData.Stations[gRadioData.CurrStation] = (gRadioData.CurrFreq - RADIO_FREQ_BASE_875);
                                              }                               
                                              gRadioData.Stations[gRadioData.CurrStation + (MAX_RADIO_STATION_NUM / 2)] = gRadioData.CurrStation + 1
             -;
                                              gRadioData.StationSum = (MAX_RADIO_STATION_NUM / 2);            
                                                      
                                              RadioShowDebug(RadioShowSaveCurFreToCurChannle);
              #ifdef FUNC_BREAK_POINT_EN
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 21:03:22 PAGE 16  

                                              RadioWriteData();
              #endif
                                              RadioDisFlag = RadioDisCurFreNum;
                                              gRadioCtrl.State = RADIO_IDLE;
                                      }
                                      break;
              
                              case MSG_FM_STERO_SW:
                                      if(gRadioCtrl.State == RADIO_IDLE)
                                      {
                                              gRadioMonoEnableFlag ^= 1;
                                              RadioMonoModeSet(gRadioMonoEnableFlag);                 
                                      }
                                      break;
              #endif
 931   2      
 932   2                      default:        
 933   2                              break;
 934   2              }//switch(Event)
 935   1      
 936   1      #ifdef FUN_SYSTEM_POWEROFF_WAIT_TIME
                      SystemOffTimeMsgPro(Event);
              #endif
 939   1      }
 940          
 941          
 942          #ifdef FUNC_DISP_EN     
 943          #ifdef  FUNC_NUMBER_KEY_EN
 944          //数字输入频点保存闪烁显示
 945          VOID RadioDisBlink(VOID)
 946          {
 947   1              switch(gDisplayMode)
 948   1              {
 949   2      #ifdef FUNC_SINGLE_LED_EN       
 950   2                      case DISP_DEV_SLED:
 951   2                              //add code
 952   2                              break;
 953   2      #endif
 954   2      
 955   2      #ifdef FUNC_SEG_LED_EN
                              case DISP_DEV_LED1888:          
                              case DISP_DEV_LED8888:          
                              case DISP_DEV_LED57:
                                      if(RadioDisCount % 2)
                                      {       
                                              DispString("    ");             
                                              DispIcon(ICON_DP_FM_MHZ, LIGHT_OFF);                                    
                                      }
                                      else
                                      {
                                              Num2Char(gRadioData.CurrFreq, FALSE);
                                              DispIcon(ICON_DP_FM_MHZ, LIGHT_ON);     
                                      }                               
                                      break;
              #endif
 971   2      
 972   2      #ifdef FUNC_SEG_LCD_EN
                              case DISP_DEV_LCD58:
                                      //add code
                                      break;
              #endif
 977   2                      
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 21:03:22 PAGE 17  

 978   2                      default:
 979   2                              break;                  
 980   2              }
 981   1      }
 982          #endif
 983          #endif
 984          
 985          
 986          // Seek tuning will search up or down for a valid channel.
 987          VOID RadioStationSearch(VOID)
 988          {
 989   1              BYTE SearchState; 
 990   1                      
 991   1              switch(gRadioCtrl.State)
 992   1              {       
 993   2                      case RADIO_SEEK:        
 994   2                              if(IsTimeOut(&gRadioCtrl.SeekPreviewTimer))
 995   2                              {       
 996   3                                      MuteOn(TRUE, TRUE);     //解决FM信号源从DAC直接输出时，自动搜台过程中会有较大低噪声
 997   3                                      RadioMute(TRUE);
 998   3                                      RadioDisFlag = RadioDisCurFreNum;
 999   3      
1000   3      #ifdef  FUNC_RADIO_AUTOSEEK_EN
1001   3                                      if((gRadioCtrl.SeekMode == SEEK_AUTOSCAN) ||(gRadioCtrl.SeekMode == SEEK_SCANUP))
1002   3                                      {
1003   4      #ifdef FUNC_SLAVE_UART_EN
                                                 MVFM_AutoSeekConfig(gRadioData.CurrFreq, gRadioCtrl.RadioUpperBound, gR
             -adioCtrl.RadioSeekStep, 1, 0);
              #else
1006   4                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, RADIO_UPPER_BOUND, RADIO_SEEK_STEP, 1, 0);
1007   4      #endif
1008   4                                      }
1009   3                                      else
1010   3                                      {
1011   4      #ifdef FUNC_SLAVE_UART_EN
                                                 MVFM_AutoSeekConfig(gRadioData.CurrFreq, gRadioCtrl.RadioLowerBound, gR
             -adioCtrl.RadioSeekStep, 1, 0);
              #else                           
1014   4                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, RADIO_LOWER_BOUND, RADIO_SEEK_STEP, 1, 0);
1015   4      #endif
1016   4                                      }
1017   3                                      DBG(("Auto Seek Start Freq %d\n", gRadioData.CurrFreq));        
1018   3      #else
                                              if((gRadioCtrl.SeekMode == SEEK_AUTOSCAN) ||(gRadioCtrl.SeekMode == SEEK_SCANUP))
                                              {
                                                      gRadioData.CurrFreq++;
                                              }
                                              else
                                              {
                                                      gRadioData.CurrFreq--;
                                              }
                                              //DBG(("Search  Freq %d\n",gRadioData.CurrFreq));                                       
                                              //RadioSearchSet(gRadioData.CurrFreq);
              #ifdef FUNC_SLAVE_UART_EN
                                          MVFM_AutoSeekConfig(gRadioData.CurrFreq, gRadioCtrl.RadioUpperBound, gRadioCtr
             -l.RadioSeekStep, 0, 0);
                                          gRadioCtrl.RadioSeekResult =0;
              #else                                                           
                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, RADIO_UPPER_BOUND, RADIO_SEEK_STEP, 0, 0);
              #endif
              #endif
1036   3                                      gRadioCtrl.State = RADIO_READ;
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 21:03:22 PAGE 18  

1037   3                                      TimeOutSet(&gRadioCtrl.SeekPreviewTimer, RadioSeekTimeValue);
1038   3                                      
1039   3      #ifdef FUNC_RADIO_ESD_AUTO_RESUME
1040   3                                      gRadioCurrFreqBack = gRadioData.CurrFreq;
1041   3      #endif
1042   3      #ifdef FUNC_SLAVE_UART_EN
                                              SlaveRadioRetCurrentStatus();
              #endif
1045   3                              }
1046   2                              break;
1047   2                                                      
1048   2                      case RADIO_READ:
1049   2                              if(IsTimeOut(&gRadioCtrl.SeekPreviewTimer))
1050   2                              {
1051   3      #ifdef  FUNC_RADIO_AUTOSEEK_EN
1052   3                                      if(SearchState = RadioRSSIRead(TRUE)) 
1053   3      #else
                                              if(SearchState = RadioRSSIRead(FALSE)) 
              #endif
1056   3                                      {       
1057   4      #ifdef FUNC_SLAVE_UART_EN
                                                 gRadioCtrl.RadioSeekResult =1;
              #endif
1060   4      #ifdef  FUNC_RADIO_AUTOSEEK_EN
1061   4      #ifdef FUNC_DISP_EN
1062   4                                              DispResume();
1063   4      #endif
1064   4      #endif
1065   4                                              if(SearchState == 3) 
1066   4                                              {
1067   5                                                      //DBG(("Search Freq %d\n",gRadioData.CurrFreq));                                                
1068   5                                                      TimeOutSet(&gRadioCtrl.SeekPreviewTimer, RadioSeekTimeValue);
1069   5                                                      break;
1070   5                                              }
1071   4                                              
1072   4                                              if(gRadioCtrl.SeekMode == SEEK_AUTOSCAN)
1073   4                                              {
1074   5                                                      if(gRadioData.StationSum < MAX_RADIO_STATION_NUM)
1075   5                                                      {
1076   6                                                              if(gRadioData.CurrFreq < RADIO_FREQ_BASE_875)
1077   6                                                              {
1078   7                                                                      gRadioData.Stations[gRadioData.StationSum] = (gRadioData.CurrFreq - RADIO_FREQ_BASE_760);
1079   7                                                                      gRadioData.Area1StationSum++;
1080   7                                                              }
1081   6                                                              else
1082   6                                                              {
1083   7                                                                      //DBG(("~~~~~~~~~~~~~%u\n",gRadioData.CurrFreq));                                                       
1084   7                                                                      gRadioData.Stations[gRadioData.StationSum] = (gRadioData.CurrFreq - RADIO_FREQ_BASE_875);
1085   7                                                              }                                               
1086   6                                                              gRadioData.StationSum++;
1087   6      
1088   6      //#if (defined(FUNC_SINGLE_LED_EN))     //单个LED显示需要搜台预览功能
1089   6      #ifdef RADIO_SEEK_WAIT_EN
1090   6                                                              RadioMute(FALSE);
1091   6                                                              UnMute();
1092   6      #endif
1093   6      //#endif
1094   6                                                              RadioDisFlag = RadioDisCurChAutoscan;
1095   6                                                              TimeOutSet(&gRadioCtrl.SeekPreviewTimer, RadioPreVimeTimerValue);
1096   6      #ifdef FUNC_SINGLE_LED_EN  
1097   6                                                              DispDev();
1098   6      #endif
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 21:03:22 PAGE 19  

1099   6      #ifdef FUNC_SLAVE_UART_EN
                                                                      SlaveRadioRetCurrentStatus();
              #endif
1102   6                                                      }
1103   5                                                      else
1104   5                                                      {                                       
1105   6                                                              //DBG(("FM Buffer Over\n"));
1106   6                                                              gRadioData.CurrStation = 0;
1107   6                                                              if(gRadioData.Area1StationSum > 0)
1108   6                                                              {
1109   7                                                                      gRadioData.CurrFreq = gRadioData.Stations[gRadioData.CurrStation] + RADIO_FREQ_BASE_760;
1110   7                                                              }
1111   6                                                              else
1112   6                                                              {
1113   7                                                                      gRadioData.CurrFreq = gRadioData.Stations[gRadioData.CurrStation] + RADIO_FREQ_BASE_875;
1114   7                                                              }
1115   6                                                              RadioMute(FALSE);
1116   6                                                              UnMute();
1117   6                                                              gRadioCtrl.State = RADIO_IDLE;                                                                                                                                                  
1118   6                                                              RadioWriteData();                                                       
1119   6                                                              RadioShowDebug(RadioShowSearchEndOverflow);
1120   6      #ifdef FUNC_SINGLE_LED_EN 
1121   6                                                              DispDev();
1122   6      #endif
1123   6      #ifdef FUNC_SLAVE_UART_EN
                                                                      SlaveRadioRetCurrentStatus();
              #endif
1126   6                                                              return;                                                         
1127   6                                                      }
1128   5                                              }
1129   4                                              else
1130   4                                              {
1131   5                                                      gRadioCtrl.State = RADIO_IDLE;                                          
1132   5                                                      RadioMute(FALSE);
1133   5                                                      UnMute();
1134   5                                                      RadioWriteData();                                               
1135   5                                                      RadioShowDebug(RadioShowSearchUpDown);                                          
1136   5      #ifdef FUNC_SINGLE_LED_EN 
1137   5                                                      DispDev();
1138   5      #endif
1139   5      #ifdef FUNC_SLAVE_UART_EN
                                                              SlaveRadioRetCurrentStatus();
              #endif
1142   5                                                      return;
1143   5                                              }
1144   4                                      }
1145   3      #ifdef FUNC_SLAVE_UART_EN
                                          if(((gRadioCtrl.SeekMode == SEEK_SCANDOWN) && (gRadioData.CurrFreq <= gRadioCt
             -rl.RadioLowerBound))
                                              || (((gRadioCtrl.SeekMode == SEEK_SCANUP) || (gRadioCtrl.SeekMode == SEEK_AUTOSCAN)) && (gRadioData.Cu
             -rrFreq >= gRadioCtrl.RadioUpperBound)))
              #else
1149   3                                      if(((gRadioCtrl.SeekMode == SEEK_SCANDOWN) && (gRadioData.CurrFreq <= RADIO_LOWER_BOUND))
1150   3                                      || (((gRadioCtrl.SeekMode == SEEK_SCANUP) || (gRadioCtrl.SeekMode == SEEK_AUTOSCAN)) && (gRadioData.Cu
             -rrFreq >= RADIO_UPPER_BOUND)))
1151   3      #endif
1152   3                                      { 
1153   4                                              gRadioCtrl.State = RADIO_IDLE;
1154   4                                              if((gRadioData.StationSum > 0) && (gRadioCtrl.SeekMode == SEEK_AUTOSCAN))
1155   4                                              {                                               
1156   5      #ifdef  FUNC_RADIO_AUTOSEEK_EN
1157   5      #ifdef FUNC_DISP_EN
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 21:03:22 PAGE 20  

1158   5                                                      DispResume();
1159   5      #endif
1160   5      #endif
1161   5                                                      gRadioData.CurrStation = 0;
1162   5      
1163   5                                                      if(gRadioData.Area1StationSum > 0)
1164   5                                                      {
1165   6                                                              gRadioData.CurrFreq = gRadioData.Stations[gRadioData.CurrStation] + RADIO_FREQ_BASE_760;
1166   6                                                      }
1167   5                                                      else
1168   5                                                      {
1169   6                                                              gRadioData.CurrFreq = gRadioData.Stations[gRadioData.CurrStation] + RADIO_FREQ_BASE_875;
1170   6                                                      }
1171   5                                                      
1172   5                                                      RadioSetFreq();                                                 
1173   5                                                      RadioWriteData();                                               
1174   5                                                      RadioShowDebug(RadioShowSearchEndBufferEnough); 
1175   5                                              }
1176   4                                              else
1177   4                                              {
1178   5                                                      DBG(("Error:empty\n"));
1179   5                                                      RadioSetFreq();
1180   5                                              }
1181   4                                              
1182   4                                              RadioMute(FALSE);       
1183   4                                              UnMute();
1184   4      #ifdef FUNC_SINGLE_LED_EN 
1185   4                                              DispDev();
1186   4      #endif
1187   4      #ifdef FUNC_SLAVE_UART_EN
                                                      SlaveRadioRetCurrentStatus();
              #endif
1190   4                                      }
1191   3                                      else
1192   3                                      {
1193   4                                              gRadioCtrl.State = RADIO_SEEK;
1194   4                                              
1195   4      #ifdef  FUNC_RADIO_AUTOSEEK_EN
1196   4                                              if(gRadioCtrl.SeekMode == SEEK_SCANDOWN)
1197   4                                              {
1198   5                                                      gRadioData.CurrFreq--;                                          
1199   5                                              }
1200   4                                              else
1201   4                                              {
1202   5                                                      gRadioData.CurrFreq++;
1203   5                                              }                                       
1204   4      #endif
1205   4                                      }               
1206   3                              }               
1207   2                              break;
1208   2                              
1209   2                      case RADIO_IDLE:
1210   2                              if(IsTimeOut(&gRadioCtrl.SeekPreviewTimer))
1211   2                              {       
1212   3                                      if(RadioDisFlag == RadioDisCurChChange)
1213   3                                      {
1214   4      #ifdef AU6210K_BOOMBOX_DEMO
                                                      RadioDisFlag = RadioDisCurPresetCh;
              #else
1217   4                                              RadioDisFlag = RadioDisCurFreNum;
1218   4      #endif
1219   4                                      }
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 21:03:22 PAGE 21  

1220   3                                      else if(RadioDisFlag == RadioDisCurChAutoscan)
1221   3                                      {
1222   4                                              RadioDisFlag = RadioDisCurFreNum;
1223   4                                      }                               
1224   3      #ifdef  FUNC_NUMBER_KEY_EN
1225   3                                      else if(RadioDisFlag == RadioDisCurFreBlink)
1226   3                                      {               
1227   4      #ifdef FUNC_DISP_EN             
1228   4                                              RadioDisBlink();
1229   4      #endif
1230   4                                              if(RadioDisCount > 0)
1231   4                                              {
1232   5                                                      RadioDisCount--;
1233   5                                              }
1234   4                                              else
1235   4                                              {
1236   5                                                      RadioDisFlag = RadioDisCurFreNum;
1237   5                                              }
1238   4                                              TimeOutSet(&gRadioCtrl.SeekPreviewTimer, RadioBlinkTime);                               
1239   4                                      }
1240   3      #endif
1241   3                              }
1242   2                              break;
1243   2                              
1244   2      #ifdef AU6210K_BOOMBOX_DEMO
                              case RADIO_PROG:
                                      if(IsTimeOut(&gRadioCtrl.SeekPreviewTimer))
                                      {
                                              gRadioCtrl.State = RADIO_IDLE;  
                                              RadioDisFlag = RadioDisCurFreNum;
                                      }
                                      break;
              #endif
1253   2                              
1254   2                      default:
1255   2                              break;  
1256   2              }
1257   1      }
1258          
1259          
1260          //按键响应
1261          //状态处理
1262          VOID RadioStateCtrl(VOID)
1263          {       
1264   1              RadioEventProcess();
1265   1              RadioStationSearch();
1266   1      
1267   1      #ifdef FUNC_RADIO_ESD_AUTO_RESUME
1268   1              if(gRadioCtrl.State == RADIO_IDLE)
1269   1              {
1270   2                      if(IsTimeOut(&RadioStateCheckTimer))
1271   2                      {               
1272   3                              if((MVFM_ReadReg(0x00) & 0x20) || (MVFM_GetCh() != gRadioCurrFreqBack))
1273   3                              {
1274   4                                      RadioStateCheckCount++;
1275   4                                      if(RadioStateCheckCount > 2)    
1276   4                                      {
1277   5                                              RadioSetFreq(); 
1278   5                                              RadioMute(FALSE);       
1279   5                                      }
1280   4                              }
1281   3                              else
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 21:03:22 PAGE 22  

1282   3                              {
1283   4                                      RadioStateCheckCount = 0;
1284   4                              }
1285   3                              TimeOutSet(&RadioStateCheckTimer, 250);
1286   3                      }                       
1287   2              }
1288   1      #endif
1289   1      }
1290          
1291          #endif


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2234    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     18       2
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
