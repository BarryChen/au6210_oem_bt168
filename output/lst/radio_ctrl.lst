C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 13:58:50 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE RADIO_CTRL
OBJECT MODULE PLACED IN .\output\obj\radio_ctrl.obj
COMPILER INVOKED BY: d:\Keil\C51\BIN\C51.EXE radio\radio_ctrl.c LARGE OBJECTADVANCED OPTIMIZE(9,SIZE) BROWSE INCDIR(.\co
                    -nfig;.\device;.\display;.\fs;.\key;.\lib_if;.\play;.\system;.\library;.\power;.\radio;.\eeprom;.\spi_flash;.\slave;.\blu
                    -etooth;.\i2c) DEBUG PRINT(.\output\lst\radio_ctrl.lst) OBJECT(.\output\obj\radio_ctrl.obj)

line level    source

   1          #include <string.h>
   2          #include "syscfg.h"
   3          #include "utility.h"
   4          #include "sysctrl.h"
   5          #include "radio_ctrl.h"
   6          #include "mv_fm.h"
   7          #include "radio_app_interface.h"
   8          #include "message.h"
   9          #include "key.h"
  10          #include "gpio.h"
  11          #include "display.h"
  12          #include "24cxx.h"
  13          #include "breakpoint.h"
  14          #include "user_interface.h"
  15          #include "seg_panel.h"
  16          #include "sys_on_off.h"
  17          #include "rtc_ctrl.h"
  18          #include "debug.h"
  19          #include "otp_play.h"
  20          #include "slave_ctrl.h"
  21          #include "pt231x.h"
  22          
  23          #ifdef FUNC_RADIO_EN
  24          
  25          RADIO_CTRL      gRadioCtrl;
  26          BYTE RadioDisFlag;
  27          static BYTE RadioDisCount = 0;
  28          
  29          #ifndef FUNC_BREAK_POINT_EN
              RADIO_DATA        gRadioData2Store;
              #endif
  32          
  33          #ifdef FUNC_RADIO_ESD_AUTO_RESUME
  34          static TIMER RadioStateCheckTimer;
  35          static BYTE RadioStateCheckCount;
  36          WORD gRadioCurrFreqBack;
  37          #endif
  38          
  39          //区分FM的型号
  40          RADIO_NAME      Radio_Name = RADIO_NONE;
  41          #ifdef  FUNC_NUMBER_KEY_EN
  42          extern WORD     gRecvNum;
  43          extern BOOL NumKeyRadioFreqErrorFlag;
  44          extern BOOL NumKeyErrorDispFlag;
  45          #endif
  46          
  47          #ifdef AU6210K_BOOMBOX_DEMO
              BOOL gRadioMonoEnableFlag = FALSE;      
              #endif
  50          
  51          #ifdef  FUNC_DEVICE_FORCEPAUSE_EN
              extern BOOL gDevicePlayForcePauseFlag;
              #endif
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 13:58:50 PAGE 2   

  54          
  55          
  56          #ifdef __RADIOCTRL_DEBUG__
              VOID RadioShowDebug(BYTE Index)
              {
                      BYTE i = 0;
              
                      switch(Index)
                      {
                              case RadioShowPowerOn:
                                      DBG(("Read Data Form EEPROM\n"));
                                      break;  
                                                      
                              case RadioShowCancelSearch:
                                      DBG(("搜台中途退出\n"));        
                                      break;
                      
                              case RadioShowSearchEndOverflow:
                                      DBG(("搜到台数量大于MAX_RADIO_STATION_NUM\n"));
                                      break;
                      
                              case RadioShowSearchEndBufferEnough:
                                      DBG(("0<搜到台数量<buffer长度\n"));
                                      break;
                      
                              case RadioShowSearchUpDown:
                                      DBG(("SCANUP,SCANDOWN:find a channel\n"));
                                      break;
                      
                              case RadioShowSaveCurFreToCurChannle:
                                      DBG(("当前频率保存到当前通道\n"));
                                      break;
                      
                              case RadioShowSaveFre:
                                      DBG(("当前频率保存到某个频道\n"));
                                      break;
                      
                              case RadioShowCurStationChange:
                                      DBG(("通道切换\n"));
                                      break;
                      
                              case RadioShowFreChange:        
                                      DBG(("当前频率改变\n"));
                                      break;
                      }
                      
                      DBG(("频道760~874(start form 1):%2BX\n", gRadioData.Area1StationSum));  
                      DBG(("频道875~1080(start form 1):%2BX\n", (gRadioData.StationSum - gRadioData.Area1StationSum)));                               
                      DBG(("当前频道(start form 0):%2BX\n", gRadioData.CurrStation));
                      
                      DBG(("频道列表(760~874):\n"));
                      for(i = 0; i < gRadioData.Area1StationSum; i++)
                      {
                              DBG(("频道%2BX  %u\n", (i + 1), (gRadioData.Stations[i] + RADIO_FREQ_BASE_760)));
                      }       
              
                      DBG(("频道列表(875~1080):\n")); 
                      for(i = gRadioData.Area1StationSum; i < gRadioData.StationSum; i++)
                      {
                              DBG(("频道%2BX  %u\n", (i + 1), (gRadioData.Stations[i] + RADIO_FREQ_BASE_875)));
                      }       
              }
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 13:58:50 PAGE 3   

              #endif
 117          
 118          
 119          //进入FM前初始化函数
 120          //利用内部FM模块时，底层会在切入通道(DAC_CH_ONCHIP_FM、DAC_CH_ONCHIP_FM_L、DAC_CH_ONCHIP_FM_R)过程中调用此
             -函数
 121          VOID RadioCtrlInit(VOID)
 122          {
 123   1              DBG((">>RadioCtrlInit()\n"));
 124   1      #ifndef FUNC_SPI_KEY_SOUND_EN           
                      RadioSetFreq();
                      RadioMute(FALSE);
                      RadioSetVolume(gSys.Volume);    
              #endif
 129   1      }
 130          
 131          
 132          //离开FM前初始化函数
 133          //利用内部FM模块时，底层会在切离通道(DAC_CH_ONCHIP_FM、DAC_CH_ONCHIP_FM_L、DAC_CH_ONCHIP_FM_R)过程中调用此
             -函数
 134          VOID RadioCtrlDeinit(VOID)
 135          {
 136   1              CancelSearch();
 137   1              MuteOn(TRUE, TRUE);
 138   1              RadioMute(TRUE);
 139   1              RadioPowerDown();
 140   1      #ifdef FUNC_POWER_AMPLIFIER_EN
                      ABPowerAmplifierOn();   //在其它模式下选择AB 类功放
              #endif  
 143   1      }
 144          
 145          
 146          //进入FM 后初始化函数
 147          VOID RadioEnterInit(VOID)
 148          {       
 149   1      #ifdef FUNC_SPI_KEY_SOUND_EN
 150   1              RadioSetFreq();
 151   1              RadioMute(FALSE);
 152   1              RadioSetVolume(gSys.Volume);    
 153   1      #endif
 154   1      
 155   1              gRadioCtrl.State = RADIO_IDLE;
 156   1              UnMute();       
 157   1      
 158   1      #ifdef FUNC_POWER_AMPLIFIER_EN
                      ABPowerAmplifierOff();  //在FM模式下选择D 类功放
              #endif
 161   1              
 162   1      #ifdef FUNC_BREAK_POINT_EN
 163   1              BP_SaveInfo(&gBreakPointInfo.PowerMemory.SystemMode,sizeof(gBreakPointInfo.PowerMemory.SystemMode));
 164   1      #endif
 165   1      
 166   1      #ifdef FUNC_RADIO_ESD_AUTO_RESUME
 167   1              RadioStateCheckCount = 0;
 168   1              TimeOutSet(&RadioStateCheckTimer, 250);
 169   1      #endif
 170   1      }
 171          
 172          
 173          //FM通用功能，和具体的FM型号没有关系
 174          //正在搜台时候中途停止搜台
 175          VOID CancelSearch(VOID)
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 13:58:50 PAGE 4   

 176          {
 177   1              if((gRadioCtrl.State > RADIO_IDLE) && (gRadioCtrl.SeekMode != SEEK_NONE))
 178   1              {
 179   2                      RadioDisFlag = RadioDisCurFreNum;
 180   2                      
 181   2                      if(gRadioData.StationSum > 0)
 182   2                      {
 183   3                              gRadioData.CurrStation = 0;
 184   3                              if(gRadioData.Area1StationSum > 0)
 185   3                              {
 186   4                                      gRadioData.CurrFreq = gRadioData.Stations[gRadioData.CurrStation] + RADIO_FREQ_BASE_760;
 187   4                              }
 188   3                              else
 189   3                              {
 190   4                                      gRadioData.CurrFreq = gRadioData.Stations[gRadioData.CurrStation] + RADIO_FREQ_BASE_875;
 191   4                              }
 192   3                              RadioSetFreq(); 
 193   3                              RadioShowDebug(RadioShowCancelSearch);
 194   3                              RadioWriteData();                       
 195   3                      }
 196   2                      else
 197   2                      {
 198   3                              DBG(("Error:empty\n"));
 199   3                      }
 200   2                      RadioMute(FALSE);               
 201   2                      UnMute();
 202   2                      gRadioCtrl.State = RADIO_IDLE;
 203   2      #ifdef FUNC_SINGLE_LED_EN  
 204   2                      DispDev();
 205   2      #endif
 206   2              }
 207   1      }
 208          
 209          
 210          VOID RadioArrayInsert(VOID)
 211          {
 212   1      #ifdef  FUNC_NUMBER_KEY_EN
 213   1              BYTE i;
 214   1      
 215   1              if(gRecvNum > MAX_RADIO_STATION_NUM)
 216   1              {
 217   2                      return;
 218   2              }
 219   1              
 220   1              if(gRadioData.CurrFreq >= RADIO_FREQ_BASE_875)
 221   1              {
 222   2                      if(gRecvNum > gRadioData.StationSum)//追加到后面
 223   2                      {               
 224   3                              gRadioData.CurrStation = gRadioData.StationSum;                                                 
 225   3                              gRadioData.StationSum++;                                                
 226   3                      }
 227   2                      else//替换
 228   2                      {
 229   3                              gRadioData.CurrStation = gRecvNum - 1;
 230   3                      }
 231   2                      gRadioData.Stations[gRadioData.CurrStation] = (gRadioData.CurrFreq - RADIO_FREQ_BASE_875);
 232   2              }
 233   1              else //760~874
 234   1              {
 235   2                      if(gRecvNum > gRadioData.Area1StationSum)//追加
 236   2                      {
 237   3                              for(i = gRadioData.StationSum; i > gRadioData.Area1StationSum; i--)
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 13:58:50 PAGE 5   

 238   3                              {
 239   4                                      gRadioData.Stations[i] = gRadioData.Stations[i-1];
 240   4                              }
 241   3                                                              
 242   3                              gRadioData.CurrStation = gRadioData.Area1StationSum;
 243   3                              gRadioData.Area1StationSum++;
 244   3                              gRadioData.StationSum++;
 245   3                      }
 246   2                      else//替换
 247   2                      {
 248   3                              gRadioData.CurrStation = gRecvNum - 1;                  
 249   3                      }
 250   2                      gRadioData.Stations[gRadioData.CurrStation] = (gRadioData.CurrFreq - RADIO_FREQ_BASE_760);
 251   2              }
 252   1      #endif
 253   1      }
 254          
 255          
 256          static VOID RadioChannelChange(VOID)
 257          {
 258   1              if((gRadioData.CurrStation + 1) <= gRadioData.Area1StationSum)
 259   1              {
 260   2                      gRadioData.CurrFreq = gRadioData.Stations[gRadioData.CurrStation] + RADIO_FREQ_BASE_760;
 261   2                      DBG(("CH 760+:%u\n", (gRadioData.Stations[gRadioData.CurrStation] + RADIO_FREQ_BASE_760)));
 262   2              }
 263   1              else
 264   1              {
 265   2                      gRadioData.CurrFreq = gRadioData.Stations[gRadioData.CurrStation] + RADIO_FREQ_BASE_875;
 266   2                      DBG(("CH 875+:%u\n", (gRadioData.Stations[gRadioData.CurrStation] + RADIO_FREQ_BASE_875)));
 267   2              }
 268   1      
 269   1              RadioSetFreq();
 270   1              RadioMute(FALSE);                               
 271   1              RadioWriteData();
 272   1              RadioShowDebug(RadioShowCurStationChange);
 273   1      }
 274          
 275                  
 276          //读取有效的预存台号
 277          #ifdef AU6210K_BOOMBOX_DEMO
              static BOOL RadioGetValidPresetNum(BYTE CurrStationNum, BYTE Direction)
              {
                      BYTE Temp;
              
                      if(Direction == UP)
                      {
                              for(Temp = CurrStationNum + 1; Temp < (MAX_RADIO_STATION_NUM / 2); Temp++)
                              {
                                      if(gRadioData.Stations[Temp + (MAX_RADIO_STATION_NUM / 2)])
                                      {
                                              gRadioData.CurrStation = Temp;
                                              return TRUE;
                                      }
                              }
                              for(Temp = 0; Temp < CurrStationNum; Temp++)
                              {
                                      if(gRadioData.Stations[Temp + (MAX_RADIO_STATION_NUM / 2)])
                                      {
                                              gRadioData.CurrStation = Temp;
                                              return TRUE;
                                      }
                              }       
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 13:58:50 PAGE 6   

                      }
                      else 
                      {
                              for(Temp = CurrStationNum; Temp > 0; Temp--)
                              {
                                      if(gRadioData.Stations[Temp + (MAX_RADIO_STATION_NUM / 2)] && (Temp != CurrStationNum))
                                      {
                                              gRadioData.CurrStation = Temp;
                                              return TRUE;
                                      }
                              }
                              for(Temp = ((MAX_RADIO_STATION_NUM / 2) - 1); Temp > CurrStationNum; Temp--)
                              {
                                      if(gRadioData.Stations[Temp + (MAX_RADIO_STATION_NUM / 2)])
                                      {
                                              gRadioData.CurrStation = Temp;
                                              return TRUE;
                                      }
                              }       
                      }
                      
                      if(gRadioData.StationSum == 1)  //只有一个预存台
                      {
                              return TRUE;
                      }
                      
                      return FALSE;   //没有预存台存在
              }
              #endif
 329          
 330                  
 331          //按键响应
 332          VOID RadioEventProcess(VOID)
 333          {
 334   1              MESSAGE Event = MessageGet(MSG_FIFO_KEY);
 335   1              
 336   1              switch(Event)
 337   1              {
 338   2                      case MSG_POWER:
 339   2                      case MSG_MODE_SW:
 340   2                              //DBG(("Exit FM, Event:%bx\n", Event));
 341   2                              CancelSearch();
 342   2                              MessageSend(MSG_FIFO_DEV_CTRL, Event);
 343   2                              break;
 344   2                              
 345   2                      case MSG_SCAN://启动自动全频段搜台
 346   2                      case MSG_INTRO:
 347   2                      case MSG_PLAY_1CP:
 348   2      #if !defined(AU6210K_HXX_B002)                  
 349   2                      case MSG_PLAY_PAUSE:
 350   2      #endif                  
 351   2      #ifdef FUNC_DEVICE_FORCEPAUSE_EN
                                      if(gDevicePlayForcePauseFlag == TRUE)
                                      {
                                              gDevicePlayForcePauseFlag = FALSE;
                                              UnMute();
                                              break;
                                      }
              #endif
 359   2                              DBG(("SCAN\n"));
 360   2      #ifdef FUNC_BEEP_SOUND_EN       
                                      PushKeyBeep(1);
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 13:58:50 PAGE 7   

              #endif
 363   2                              if(gRadioCtrl.State == RADIO_IDLE)
 364   2                              {
 365   3                                      gRadioCtrl.State = RADIO_READ;
 366   3                                      
 367   3                                      gRadioCtrl.SeekMode = SEEK_AUTOSCAN;
 368   3      #ifdef FUNC_SLAVE_UART_EN
                                          gRadioData.CurrFreq = gRadioCtrl.RadioLowerBound;
              #else
 371   3                                      gRadioData.CurrFreq = RADIO_LOWER_BOUND;
 372   3      #endif
 373   3                                      gRadioData.CurrStation = 0;     
 374   3                                      gRadioData.Area1StationSum = 0;
 375   3                                      gRadioData.StationSum = 0;                                      
 376   3                                      memset(&gRadioData.Stations, 0, sizeof(gRadioData.Stations));
 377   3                                      
 378   3                                      MuteOn(TRUE, TRUE);                             
 379   3                                      RadioSetFreq();         
 380   3      #ifdef FUNC_SLAVE_UART_EN
              #ifdef  FUNC_RADIO_AUTOSEEK_EN
                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, gRadioCtrl.RadioUpperBound, gRadioCtrl.RadioSeekStep, 1, 1);
              #else
                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, gRadioCtrl.RadioUpperBound, gRadioCtrl.RadioSeekStep, 0, 1);
              #endif
              
              #else
 388   3      #ifdef  FUNC_RADIO_AUTOSEEK_EN
 389   3                                      MVFM_AutoSeekConfig(gRadioData.CurrFreq, RADIO_UPPER_BOUND, RADIO_SEEK_STEP, 1, 1);
 390   3      #else
                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, RADIO_UPPER_BOUND, RADIO_SEEK_STEP, 0, 1);
              #endif
 393   3      #endif                          
 394   3                                      RadioMute(TRUE);
 395   3                                      TimeOutSet(&gRadioCtrl.SeekPreviewTimer, RadioSeekTimeValue);
 396   3                              }
 397   2                              else
 398   2                              {
 399   3                                      CancelSearch();
 400   3                              }
 401   2                              break;
 402   2      
 403   2                      case MSG_SAVE_STATION:  //保存当前的频率到当前的频道
 404   2                              if(gRadioCtrl.State == RADIO_IDLE)
 405   2                              {               
 406   3                                      if(gRadioData.StationSum < MAX_RADIO_STATION_NUM)
 407   3                                      {               
 408   4                                              if((gRadioData.CurrFreq < RADIO_FREQ_BASE_875) && ((gRadioData.CurrStation + 1) <= gRadioData.Area1St
             -ationSum))
 409   4                                              {
 410   5                                                      gRadioData.Stations[gRadioData.CurrStation] = (gRadioData.CurrFreq - RADIO_FREQ_BASE_760);
 411   5                                              }
 412   4                                              else if((gRadioData.CurrFreq > RADIO_FREQ_BASE_875) && ((gRadioData.CurrStation + 1) > gRadioData.Are
             -a1StationSum))
 413   4                                              {
 414   5                                                      gRadioData.Stations[gRadioData.CurrStation] = (gRadioData.CurrFreq - RADIO_FREQ_BASE_875);
 415   5                                              }                               
 416   4                                              RadioShowDebug(RadioShowSaveCurFreToCurChannle);
 417   4                                              RadioWriteData();
 418   4                                              RadioDisFlag = RadioDisCurFreBlink;
 419   4                                              RadioDisCount = 6;
 420   4                                              TimeOutSet(&gRadioCtrl.SeekPreviewTimer,RadioBlinkTime);
 421   4      #ifdef FUNC_SLAVE_UART_EN
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 13:58:50 PAGE 8   

                                                      SlaveRadioRetCurrentStatus();
              #endif
 424   4      
 425   4                                      }
 426   3                              }
 427   2                              break;
 428   2                      
 429   2                      case MSG_NEXT://下一个台
 430   2                      case MSG_PLAY_1:
 431   2      #ifdef  FUNC_DEVICE_FORCEPAUSE_EN
                                      if(gDevicePlayForcePauseFlag == TRUE) 
                                      {
                                              break;
                                      }                                       
              #endif
 437   2      
 438   2      #ifdef AU6210K_BOOMBOX_DEMO
                                      if(gRadioCtrl.State == RADIO_PROG)
                                      {
                                              if(gRadioData.CurrStation < (MAX_RADIO_STATION_NUM / 2))
                                              {
                                                      gRadioData.CurrStation++;
                                              }
                                              else
                                              {
                                                      gRadioData.CurrStation = 0;
                                              }
                                              break;
                                      }
                                      
                                      if(gRadioCtrl.State == RADIO_IDLE)
                                      {
                                              if(RadioGetValidPresetNum(gRadioData.CurrStation, UP) == TRUE)
                                              {
                                                      RadioDisFlag = RadioDisCurChChange;
                                                      TimeOutSet(&gRadioCtrl.SeekPreviewTimer, RadioPreVimeTimerValue);
                                                      RadioChannelChange();
                                                      UnMute();
                                                      gSys.MuteFg = FALSE;
                                              }
                                              break;
                                      }
              #endif
 465   2      
 466   2                              if((gRadioData.StationSum > 0) && (gRadioCtrl.State == RADIO_IDLE))
 467   2                              {
 468   3      #ifdef FUNC_BEEP_SOUND_EN       
                                              PushKeyBeep(1);
              #endif
 471   3                                      if(gRadioData.CurrStation < (gRadioData.StationSum - 1))
 472   3                                      {
 473   4                                              gRadioData.CurrStation++;
 474   4                                      }
 475   3                                      else
 476   3                                      {
 477   4                                              gRadioData.CurrStation = 0;
 478   4                                      }
 479   3                                      RadioDisFlag = RadioDisCurChChange;                             
 480   3                                      RadioChannelChange();
 481   3                                      UnMute();
 482   3                                      TimeOutSet(&gRadioCtrl.SeekPreviewTimer, RadioPreVimeTimerValue);
 483   3                                      gSys.MuteFg = FALSE;
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 13:58:50 PAGE 9   

 484   3      #ifdef FUNC_SLAVE_UART_EN
                                              SlaveRadioRetCurrentStatus();
              #endif
 487   3                              }
 488   2                              break;
 489   2                              
 490   2                      case MSG_PRE://上一个台
 491   2                      case MSG_EQ_CH_SUB:
 492   2      #ifdef  FUNC_DEVICE_FORCEPAUSE_EN
                                      if(gDevicePlayForcePauseFlag == TRUE) 
                                      {
                                              break;
                                      }                                       
              #endif
 498   2      
 499   2      #ifdef AU6210K_BOOMBOX_DEMO
                                      if(gRadioCtrl.State == RADIO_PROG)
                                      {
                                              if(gRadioData.CurrStation < (MAX_RADIO_STATION_NUM / 2))
                                              {
                                                      gRadioData.CurrStation++;
                                              }
                                              else
                                              {
                                                      gRadioData.CurrStation = 0;
                                              }
                                              break;
                                      }
                                      
                                      if(gRadioCtrl.State == RADIO_IDLE)
                                      {
                                              if(RadioGetValidPresetNum(gRadioData.CurrStation, DOWN) == TRUE)
                                              {
                                                      RadioDisFlag = RadioDisCurChChange;
                                                      TimeOutSet(&gRadioCtrl.SeekPreviewTimer, RadioPreVimeTimerValue);
                                                      RadioChannelChange();
                                                      UnMute();
                                                      gSys.MuteFg = FALSE;
                                                      break;
                                              }
                                      }
              #endif
 526   2      
 527   2                              if((gRadioData.StationSum >  0) && (gRadioCtrl.State == RADIO_IDLE)) 
 528   2                              {
 529   3      #ifdef FUNC_BEEP_SOUND_EN       
                                              PushKeyBeep(1);
              #endif
 532   3                                      if(gRadioData.CurrStation > 0)
 533   3                                      {
 534   4                                              gRadioData.CurrStation--;
 535   4                                      }
 536   3                                      else
 537   3                                      {
 538   4                                              gRadioData.CurrStation = gRadioData.StationSum - 1;
 539   4                                      }
 540   3                                      RadioDisFlag = RadioDisCurChChange;                             
 541   3                                      RadioChannelChange();
 542   3                                      UnMute();
 543   3                                      TimeOutSet(&gRadioCtrl.SeekPreviewTimer, RadioPreVimeTimerValue);
 544   3                                      gSys.MuteFg = FALSE;
 545   3      #ifdef FUNC_SLAVE_UART_EN
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 13:58:50 PAGE 10  

                                              SlaveRadioRetCurrentStatus();
              #endif
 548   3                              }
 549   2                              break;
 550   2                              
 551   2      #ifdef  FUNC_NUMBER_KEY_EN
 552   2                      case MSG_RECV_NUM://选台(输入数值在有效台数内)或设置频率(输入数值在有效频率范围内)      
 553   2                              if(gRadioCtrl.State == RADIO_IDLE)//SeanFu
 554   2                              {
 555   3                                      if((gRecvNum > 0) && (gRecvNum <= gRadioData.StationSum))
 556   3                                      {
 557   4                                              //DBG(("RecvNum合法台号：%d\n", gRecvNum));                             
 558   4                                              gRadioData.CurrStation = gRecvNum - 1;
 559   4                                              if(gRecvNum <= gRadioData.Area1StationSum)
 560   4                                              {
 561   5                                                      gRadioData.CurrFreq = (gRadioData.Stations[gRadioData.CurrStation] + RADIO_FREQ_BASE_760);
 562   5                                              }
 563   4                                              else
 564   4                                              {
 565   5                                                      gRadioData.CurrFreq = (gRadioData.Stations[gRadioData.CurrStation] + RADIO_FREQ_BASE_875);
 566   5                                              }       
 567   4                                              RadioWriteData();
 568   4                                              RadioShowDebug(RadioShowCurStationChange);
 569   4                                      }
 570   3      #ifdef FUNC_SLAVE_UART_EN
                                          else if((gRecvNum >= gRadioCtrl.RadioLowerBound) && (gRecvNum <= gRadioCtrl.Ra
             -dioUpperBound))
              #else
 573   3                                      else if((gRecvNum >= RADIO_LOWER_BOUND) && (gRecvNum <= RADIO_UPPER_BOUND))
 574   3      #endif
 575   3                                      {
 576   4                                              //DBG(("RecvNum合法 频率：%d\n", gRecvNum));
 577   4                                              gRadioData.CurrFreq = gRecvNum;                         
 578   4                                              RadioWriteData();
 579   4                                              RadioShowDebug(RadioShowSaveFre);
 580   4                                      }
 581   3                                      else 
 582   3                                      {
 583   4                                              //DBG(("RecvNum非法：%d\n", gRecvNum)); 
 584   4                                              gRecvNum = 0;                                           
 585   4                                              NumKeyRadioFreqErrorFlag = TRUE;
 586   4                                              NumKeyErrorDispFlag = TRUE;                                     
 587   4      #ifdef FUNC_DISP_EN                                             
 588   4                                              TimeOutSet(&DispTmr, NORMAL_INTERVAL);  //输入错误Err显示保留时间
 589   4      #endif
 590   4                                              return;
 591   4                                      }                       
 592   3                                      RadioSetFreq();
 593   3                                      RadioMute(FALSE);
 594   3                                      gRecvNum = 0;                                   
 595   3      #ifdef FUNC_DISP_EN                                             
 596   3                                      TimeOutSet(&DispTmr, 0);        //退出数值显示
 597   3      #endif
 598   3                              }
 599   2                              break;
 600   2      
 601   2                      case MSG_NUM_SAVE_STAITON:      //将当前频率保存起来
 602   2                              if(gRadioCtrl.State == RADIO_IDLE)
 603   2                              {                               
 604   3                                      //DBG(("RecvNum %d \n", gRecvNum));
 605   3                                      RadioArrayInsert();
 606   3                                      gRecvNum = 0;
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 13:58:50 PAGE 11  

 607   3                                      RadioWriteData();
 608   3                                      RadioShowDebug(RadioShowSaveFre);
 609   3                                      RadioDisFlag = RadioDisCurFreBlink;
 610   3                                      RadioDisCount = 4;
 611   3                                      TimeOutSet(&gRadioCtrl.SeekPreviewTimer, RadioBlinkTime);
 612   3                              }
 613   2                              break;
 614   2      #endif
 615   2                              
 616   2      #ifdef  FUNC_RADIO_STEPOVER_EN          
                              case MSG_NEXT1:
                              case MSG_FREQ_UP:
                              case MSG_FREQUP_10TRK://循环递增微调频率(+100KHZ)       
                                      if(gRadioCtrl.State == RADIO_IDLE)
                                      {
              #ifdef FUNC_SLAVE_UART_EN
                                          if(++gRadioData.CurrFreq > gRadioCtrl.RadioUpperBound)
                                              {
                                                      gRadioData.CurrFreq = gRadioCtrl.RadioLowerBound;
                                              }
              #else
                                              if(++gRadioData.CurrFreq > RADIO_UPPER_BOUND)
                                              {
                                                      gRadioData.CurrFreq = RADIO_LOWER_BOUND;
                                              }
              #endif
                                              RadioSetFreq();
                                              RadioMute(FALSE);               
                                              RadioWriteData();
                                              RadioShowDebug(RadioShowFreChange);
                                      }
                                      break;
                              
                              case MSG_PREV1:
                              case MSG_FREQ_DN:
                              case MSG_FREQDN_10TRK://循环递减微调频率(-100KHZ)               
                                      if(gRadioCtrl.State == RADIO_IDLE)
                                      {
              #ifdef FUNC_SLAVE_UART_EN
                                          if(--gRadioData.CurrFreq < gRadioCtrl.RadioLowerBound)
                                              {
                                                      gRadioData.CurrFreq = gRadioCtrl.RadioUpperBound;
                                              }       
              #else
                                              if(--gRadioData.CurrFreq < RADIO_LOWER_BOUND)
                                              {
                                                      gRadioData.CurrFreq = RADIO_UPPER_BOUND;
                                              }       
              #endif
                                              RadioSetFreq();
                                              RadioMute(FALSE);               
                                              RadioWriteData();
                                              RadioShowDebug(RadioShowFreChange);
                                      }
                                      break;
              #endif
 663   2                      
 664   2      #ifdef  FUNC_RADIO_SEMO_AUTOSEEK_EN             
                              case MSG_FF_START:
                              case MSG_10TRACK_ADD://递增方式搜台，搜到第一个后停止
                                      if(gRadioCtrl.State == RADIO_IDLE)
                                      {
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 13:58:50 PAGE 12  

                                              gRadioCtrl.SeekMode = SEEK_SCANUP;
              #ifdef FUNC_SLAVE_UART_EN
                                          if(gRadioData.CurrFreq >= gRadioCtrl.RadioUpperBound)
                                              {       
                                                      gRadioData.CurrFreq = gRadioCtrl.RadioLowerBound;
                                              }
                                              else
                                              {
                                                      gRadioData.CurrFreq++;
                                              }
              #else
                                              if(gRadioData.CurrFreq >= RADIO_UPPER_BOUND)
                                              {       
                                                      gRadioData.CurrFreq = RADIO_LOWER_BOUND;
                                              }
                                              else
                                              {
                                                      gRadioData.CurrFreq++;
                                              }
              #endif                          
                                              MuteOn(TRUE, TRUE);     
                                              RadioSetFreq();                                         
                                              gRadioCtrl.State = RADIO_READ;
              #ifdef FUNC_SLAVE_UART_EN
              #ifdef  FUNC_RADIO_AUTOSEEK_EN
                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, gRadioCtrl.RadioUpperBound, gRadioCtrl.RadioSeekStep, 1, 1);
              #else
                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, gRadioCtrl.RadioUpperBound, gRadioCtrl.RadioSeekStep, 0, 1);
              #endif
              #else
              #ifdef  FUNC_RADIO_AUTOSEEK_EN
                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, RADIO_UPPER_BOUND, RADIO_SEEK_STEP, 1, 1);
              #else
                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, RADIO_UPPER_BOUND, RADIO_SEEK_STEP, 0, 1);
              #endif
              #endif
                                              RadioMute(TRUE);
                                              TimeOutSet(&gRadioCtrl.SeekPreviewTimer, RadioSeekTimeValue);
                                                      
                                      }
                                      break;
                              
                              case MSG_FB_START:
                              case MSG_10TRACK_SUB://递减方式搜台，搜到第一个后停止
                                      if(gRadioCtrl.State == RADIO_IDLE)
                                      {
                                              gRadioCtrl.SeekMode = SEEK_SCANDOWN;
              #ifdef FUNC_SLAVE_UART_EN
                                          if(gRadioData.CurrFreq <= gRadioCtrl.RadioLowerBound)
                                              {
                                                      gRadioData.CurrFreq = gRadioCtrl.RadioUpperBound;
                                              }
                                              else
                                              {
                                                      gRadioData.CurrFreq--;
                                              }
              #else                           
                                              if(gRadioData.CurrFreq <= RADIO_LOWER_BOUND)
                                              {
                                                      gRadioData.CurrFreq = RADIO_UPPER_BOUND;
                                              }
                                              else
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 13:58:50 PAGE 13  

                                              {
                                                      gRadioData.CurrFreq--;
                                              }
              #endif                          
                                              MuteOn(TRUE, TRUE);     
                                              RadioSetFreq();                                         
                                              gRadioCtrl.State = RADIO_READ;
              #ifdef FUNC_SLAVE_UART_EN
              #ifdef  FUNC_RADIO_AUTOSEEK_EN
                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, gRadioCtrl.RadioLowerBound, gRadioCtrl.RadioSeekStep, 1, 1);
              #else
                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, gRadioCtrl.RadioLowerBound, gRadioCtrl.RadioSeekStep, 0, 1);
              #endif
              #else
              #ifdef  FUNC_RADIO_AUTOSEEK_EN
                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, RADIO_LOWER_BOUND, RADIO_SEEK_STEP, 1, 1);
              #else
                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, RADIO_LOWER_BOUND, RADIO_SEEK_STEP, 0, 1);
              #endif
              #endif
                                              RadioMute(TRUE);
                                              TimeOutSet(&gRadioCtrl.SeekPreviewTimer, RadioSeekTimeValue);
                                                      
                                      }
                                      break;
              #endif
 757   2      
 758   2                      case MSG_VOL_ADD://音量加                                       
 759   2      #if defined(AU6210K_NR_D_9X)||defined(AU6210K_NR_D_9X_XJ_HTS)
                                      if (gSys.Volume >= VOLUME_MAX)
                                      {
                                              SPI_PlaySelectNum(SPIPLAY_SONG_MAX_VOLUME, 0);
                                              InDacChannelSel(DAC_CH_ONCHIP_FM);
                                              RadioSetFreq();
                                              UnMute();
                                              SysClkDivSet(CLK_DIV_RATE);
                                      }
              #endif
 769   2      
 770   2      #ifdef FUNC_POWER_AMPLIFIER_EN
                                      ABPowerAmplifierOff();                  
              #endif
 773   2      
 774   2      #ifdef FUNC_OTP_KEY_SOUND_EN
                                      OTP_PlaySelNum(OTPPLAY_NUM_VOLUP, 0);
                                      InDacChannelSel(DAC_CH_ONCHIP_FM);
                                      RadioSetFreq();
                                      UnMute();
                                      SysClkDivSet(CLK_DIV_RATE);
              #endif
 781   2      #ifdef FUNC_PT231X_EN
                          VolType = VOL_MAIN;
                          PT2313VolAdd();
              #else
 785   2                      #ifdef AU6210K_MINI503
 786   2                              if (gSys.Volume >= VOLUME_MAX)
 787   2                              {
 788   3                                      SPI_PlaySelectNum(SPIPLAY_SONG_MAX_VOLUME, 0);
 789   3                                      InDacChannelSel(DAC_CH_ONCHIP_FM);
 790   3                                      RadioSetFreq();
 791   3                                      UnMute();
 792   3                                      SysClkDivSet(CLK_DIV_RATE);
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 13:58:50 PAGE 14  

 793   3                              }
 794   2                      #endif
 795   2                              VolumeAdjust(UP);
 796   2      #endif
 797   2                              break;
 798   2                      
 799   2                      case MSG_VOL_SUB://音量减                       
 800   2      #if defined(AU6210K_NR_D_9X)||defined(AU6210K_NR_D_9X_XJ_HTS)
                                      if (gSys.Volume <= VOLUME_MIN)
                                      {
                                              SPI_PlaySelectNum(SPIPLAY_SONG_MIN_VOLUME, 0);
                                              InDacChannelSel(DAC_CH_ONCHIP_FM);
                                              RadioSetFreq();
                                              SysClkDivSet(CLK_DIV_RATE);
                                      }
              #endif
 809   2      
 810   2      #ifdef FUNC_POWER_AMPLIFIER_EN
                                      ABPowerAmplifierOff();                  
              #endif
 813   2      
 814   2      #ifdef FUNC_OTP_KEY_SOUND_EN
                                      OTP_PlaySelNum(OTPPLAY_NUM_VOLDN, 0);
                                      InDacChannelSel(DAC_CH_ONCHIP_FM);
                                      RadioSetFreq();
                                      UnMute();
                                      SysClkDivSet(CLK_DIV_RATE);
              #endif
 821   2      #ifdef FUNC_PT231X_EN
                                  VolType = VOL_MAIN;
                                  PT2313VolSub();
              #else
 825   2                      #ifdef AU6210K_MINI503
 826   2                              if (gSys.Volume <= VOLUME_MIN)
 827   2                              {
 828   3                                      SPI_PlaySelectNum(SPIPLAY_SONG_MIN_VOLUME, 0);
 829   3                                      InDacChannelSel(DAC_CH_ONCHIP_FM);
 830   3                                      RadioSetFreq();
 831   3                                      SysClkDivSet(CLK_DIV_RATE);
 832   3                              }
 833   2                      #endif
 834   2                              VolumeAdjust(DOWN);
 835   2      #endif
 836   2                              break;
 837   2      #ifdef FUNC_PT231X_EN
                            case MSG_TREBUP:
                                      VolType = VOL_TREB;
                                   PT2313VolAdd();    
                                      break;          
                              case MSG_TREBDN:
                                      VolType = VOL_TREB;
                                   PT2313VolSub();    
                                      break;          
                              case MSG_BASSUP:
                                      VolType = VOL_BASS;
                                   PT2313VolAdd();    
                                      break;          
                              case MSG_BASSDN:
                                      VolType = VOL_BASS;
                                   PT2313VolSub();    
                                      break;          
                              case MSG_DEFAULT:
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 13:58:50 PAGE 15  

                                      PT2313TrebBassSetDefault();
                                      break;          
              #endif
 858   2      #if defined(AU6210K_HXX_B002)
                              case MSG_PLAY_PAUSE:
              #endif
 861   2                      case MSG_MUTE:
 862   2                              if(gRadioCtrl.State == RADIO_IDLE)
 863   2                              {                       
 864   3      #if 0//def FUNC_SPI_KEY_SOUND_EN
                                              if(gSys.MuteFg)
                                              {
                                                      SPI_PlaySelectNum(SPIPLAY_SONG_UNMUTE, 0);
                                              }
                                              else
                                              {       
                                                      SPI_PlaySelectNum(SPIPLAY_SONG_MUTE, 0);
                                              }                               
                                              InDacChannelSel(DAC_CH_ONCHIP_FM);
                                              if(gSys.MuteFg)
                                              {
                                                      RadioSetFreq();
                                                      gSys.MuteFg = TRUE;
                                              }
                                              SysClkDivSet(CLK_DIV_RATE);
              #endif
 881   3                                      MuteStatusChange();                     
 882   3                              }
 883   2                              break;  
 884   2                      
 885   2      #if (defined(AU6210K_BOOMBOX_DEMO))
                              case MSG_CLOCK:                 
                                      if(gRadioCtrl.State == RADIO_IDLE)
                                      {
                                              gRadioCtrl.State = RADIO_PROG;
                                              RadioDisFlag = RadioDisCurProgramNum;
                                              TimeOutSet(&gRadioCtrl.SeekPreviewTimer, RadioProgramWaitTime);
                                              break;
                                      }       
              
                                      if(gRadioCtrl.State == RADIO_PROG)
                                      {               
                                              if(gRadioData.CurrFreq < RADIO_FREQ_BASE_875) 
                                              {
                                                      gRadioData.Stations[gRadioData.CurrStation] = (gRadioData.CurrFreq - RADIO_FREQ_BASE_760);
                                              }
                                              else if(gRadioData.CurrFreq > RADIO_FREQ_BASE_875)
                                              {
                                                      gRadioData.Stations[gRadioData.CurrStation] = (gRadioData.CurrFreq - RADIO_FREQ_BASE_875);
                                              }                               
                                              gRadioData.Stations[gRadioData.CurrStation + (MAX_RADIO_STATION_NUM / 2)] = gRadioData.CurrStation + 1
             -;
                                              gRadioData.StationSum = (MAX_RADIO_STATION_NUM / 2);            
                                                      
                                              RadioShowDebug(RadioShowSaveCurFreToCurChannle);
              #ifdef FUNC_BREAK_POINT_EN
                                              RadioWriteData();
              #endif
                                              RadioDisFlag = RadioDisCurFreNum;
                                              gRadioCtrl.State = RADIO_IDLE;
                                      }
                                      break;
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 13:58:50 PAGE 16  

              
                              case MSG_FM_STERO_SW:
                                      if(gRadioCtrl.State == RADIO_IDLE)
                                      {
                                              gRadioMonoEnableFlag ^= 1;
                                              RadioMonoModeSet(gRadioMonoEnableFlag);                 
                                      }
                                      break;
              #endif
 925   2      
 926   2                      default:        
 927   2                              break;
 928   2              }//switch(Event)
 929   1      
 930   1      #ifdef FUN_SYSTEM_POWEROFF_WAIT_TIME
                      SystemOffTimeMsgPro(Event);
              #endif
 933   1      }
 934          
 935          
 936          #ifdef FUNC_DISP_EN     
 937          #ifdef  FUNC_NUMBER_KEY_EN
 938          //数字输入频点保存闪烁显示
 939          VOID RadioDisBlink(VOID)
 940          {
 941   1              switch(gDisplayMode)
 942   1              {
 943   2      #ifdef FUNC_SINGLE_LED_EN       
 944   2                      case DISP_DEV_SLED:
 945   2                              //add code
 946   2                              break;
 947   2      #endif
 948   2      
 949   2      #ifdef FUNC_SEG_LED_EN
                              case DISP_DEV_LED1888:          
                              case DISP_DEV_LED8888:          
                              case DISP_DEV_LED57:
                                      if(RadioDisCount % 2)
                                      {       
                                              DispString("    ");             
                                              DispIcon(ICON_DP_FM_MHZ, LIGHT_OFF);                                    
                                      }
                                      else
                                      {
                                              Num2Char(gRadioData.CurrFreq, FALSE);
                                              DispIcon(ICON_DP_FM_MHZ, LIGHT_ON);     
                                      }                               
                                      break;
              #endif
 965   2      
 966   2      #ifdef FUNC_SEG_LCD_EN
                              case DISP_DEV_LCD58:
                                      //add code
                                      break;
              #endif
 971   2                      
 972   2                      default:
 973   2                              break;                  
 974   2              }
 975   1      }
 976          #endif
 977          #endif
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 13:58:50 PAGE 17  

 978          
 979          
 980          // Seek tuning will search up or down for a valid channel.
 981          VOID RadioStationSearch(VOID)
 982          {
 983   1              BYTE SearchState; 
 984   1                      
 985   1              switch(gRadioCtrl.State)
 986   1              {       
 987   2                      case RADIO_SEEK:        
 988   2                              if(IsTimeOut(&gRadioCtrl.SeekPreviewTimer))
 989   2                              {       
 990   3                                      MuteOn(TRUE, TRUE);     //解决FM信号源从DAC直接输出时，自动搜台过程中会有较大低噪声
 991   3                                      RadioMute(TRUE);
 992   3                                      RadioDisFlag = RadioDisCurFreNum;
 993   3      
 994   3      #ifdef  FUNC_RADIO_AUTOSEEK_EN
 995   3                                      if((gRadioCtrl.SeekMode == SEEK_AUTOSCAN) ||(gRadioCtrl.SeekMode == SEEK_SCANUP))
 996   3                                      {
 997   4      #ifdef FUNC_SLAVE_UART_EN
                                                 MVFM_AutoSeekConfig(gRadioData.CurrFreq, gRadioCtrl.RadioUpperBound, gR
             -adioCtrl.RadioSeekStep, 1, 0);
              #else
1000   4                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, RADIO_UPPER_BOUND, RADIO_SEEK_STEP, 1, 0);
1001   4      #endif
1002   4                                      }
1003   3                                      else
1004   3                                      {
1005   4      #ifdef FUNC_SLAVE_UART_EN
                                                 MVFM_AutoSeekConfig(gRadioData.CurrFreq, gRadioCtrl.RadioLowerBound, gR
             -adioCtrl.RadioSeekStep, 1, 0);
              #else                           
1008   4                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, RADIO_LOWER_BOUND, RADIO_SEEK_STEP, 1, 0);
1009   4      #endif
1010   4                                      }
1011   3                                      DBG(("Auto Seek Start Freq %d\n", gRadioData.CurrFreq));        
1012   3      #else
                                              if((gRadioCtrl.SeekMode == SEEK_AUTOSCAN) ||(gRadioCtrl.SeekMode == SEEK_SCANUP))
                                              {
                                                      gRadioData.CurrFreq++;
                                              }
                                              else
                                              {
                                                      gRadioData.CurrFreq--;
                                              }
                                              //DBG(("Search  Freq %d\n",gRadioData.CurrFreq));                                       
                                              //RadioSearchSet(gRadioData.CurrFreq);
              #ifdef FUNC_SLAVE_UART_EN
                                          MVFM_AutoSeekConfig(gRadioData.CurrFreq, gRadioCtrl.RadioUpperBound, gRadioCtr
             -l.RadioSeekStep, 0, 0);
                                          gRadioCtrl.RadioSeekResult =0;
              #else                                                           
                                              MVFM_AutoSeekConfig(gRadioData.CurrFreq, RADIO_UPPER_BOUND, RADIO_SEEK_STEP, 0, 0);
              #endif
              #endif
1030   3                                      gRadioCtrl.State = RADIO_READ;
1031   3                                      TimeOutSet(&gRadioCtrl.SeekPreviewTimer, RadioSeekTimeValue);
1032   3                                      
1033   3      #ifdef FUNC_RADIO_ESD_AUTO_RESUME
1034   3                                      gRadioCurrFreqBack = gRadioData.CurrFreq;
1035   3      #endif
1036   3      #ifdef FUNC_SLAVE_UART_EN
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 13:58:50 PAGE 18  

                                              SlaveRadioRetCurrentStatus();
              #endif
1039   3                              }
1040   2                              break;
1041   2                                                      
1042   2                      case RADIO_READ:
1043   2                              if(IsTimeOut(&gRadioCtrl.SeekPreviewTimer))
1044   2                              {
1045   3      #ifdef  FUNC_RADIO_AUTOSEEK_EN
1046   3                                      if(SearchState = RadioRSSIRead(TRUE)) 
1047   3      #else
                                              if(SearchState = RadioRSSIRead(FALSE)) 
              #endif
1050   3                                      {       
1051   4      #ifdef FUNC_SLAVE_UART_EN
                                                 gRadioCtrl.RadioSeekResult =1;
              #endif
1054   4      #ifdef  FUNC_RADIO_AUTOSEEK_EN
1055   4      #ifdef FUNC_DISP_EN
1056   4                                              DispResume();
1057   4      #endif
1058   4      #endif
1059   4                                              if(SearchState == 3) 
1060   4                                              {
1061   5                                                      //DBG(("Search Freq %d\n",gRadioData.CurrFreq));                                                
1062   5                                                      TimeOutSet(&gRadioCtrl.SeekPreviewTimer, RadioSeekTimeValue);
1063   5                                                      break;
1064   5                                              }
1065   4                                              
1066   4                                              if(gRadioCtrl.SeekMode == SEEK_AUTOSCAN)
1067   4                                              {
1068   5                                                      if(gRadioData.StationSum < MAX_RADIO_STATION_NUM)
1069   5                                                      {
1070   6                                                              if(gRadioData.CurrFreq < RADIO_FREQ_BASE_875)
1071   6                                                              {
1072   7                                                                      gRadioData.Stations[gRadioData.StationSum] = (gRadioData.CurrFreq - RADIO_FREQ_BASE_760);
1073   7                                                                      gRadioData.Area1StationSum++;
1074   7                                                              }
1075   6                                                              else
1076   6                                                              {
1077   7                                                                      //DBG(("~~~~~~~~~~~~~%u\n",gRadioData.CurrFreq));                                                       
1078   7                                                                      gRadioData.Stations[gRadioData.StationSum] = (gRadioData.CurrFreq - RADIO_FREQ_BASE_875);
1079   7                                                              }                                               
1080   6                                                              gRadioData.StationSum++;
1081   6      
1082   6      //#if (defined(FUNC_SINGLE_LED_EN))     //单个LED显示需要搜台预览功能
1083   6      #ifdef RADIO_SEEK_WAIT_EN
1084   6                                                              RadioMute(FALSE);
1085   6                                                              UnMute();
1086   6      #endif
1087   6      //#endif
1088   6                                                              RadioDisFlag = RadioDisCurChAutoscan;
1089   6                                                              TimeOutSet(&gRadioCtrl.SeekPreviewTimer, RadioPreVimeTimerValue);
1090   6      #ifdef FUNC_SINGLE_LED_EN  
1091   6                                                              DispDev();
1092   6      #endif
1093   6      #ifdef FUNC_SLAVE_UART_EN
                                                                      SlaveRadioRetCurrentStatus();
              #endif
1096   6                                                      }
1097   5                                                      else
1098   5                                                      {                                       
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 13:58:50 PAGE 19  

1099   6                                                              //DBG(("FM Buffer Over\n"));
1100   6                                                              gRadioData.CurrStation = 0;
1101   6                                                              if(gRadioData.Area1StationSum > 0)
1102   6                                                              {
1103   7                                                                      gRadioData.CurrFreq = gRadioData.Stations[gRadioData.CurrStation] + RADIO_FREQ_BASE_760;
1104   7                                                              }
1105   6                                                              else
1106   6                                                              {
1107   7                                                                      gRadioData.CurrFreq = gRadioData.Stations[gRadioData.CurrStation] + RADIO_FREQ_BASE_875;
1108   7                                                              }
1109   6                                                              RadioMute(FALSE);
1110   6                                                              UnMute();
1111   6                                                              gRadioCtrl.State = RADIO_IDLE;                                                                                                                                                  
1112   6                                                              RadioWriteData();                                                       
1113   6                                                              RadioShowDebug(RadioShowSearchEndOverflow);
1114   6      #ifdef FUNC_SINGLE_LED_EN 
1115   6                                                              DispDev();
1116   6      #endif
1117   6      #ifdef FUNC_SLAVE_UART_EN
                                                                      SlaveRadioRetCurrentStatus();
              #endif
1120   6                                                              return;                                                         
1121   6                                                      }
1122   5                                              }
1123   4                                              else
1124   4                                              {
1125   5                                                      gRadioCtrl.State = RADIO_IDLE;                                          
1126   5                                                      RadioMute(FALSE);
1127   5                                                      UnMute();
1128   5                                                      RadioWriteData();                                               
1129   5                                                      RadioShowDebug(RadioShowSearchUpDown);                                          
1130   5      #ifdef FUNC_SINGLE_LED_EN 
1131   5                                                      DispDev();
1132   5      #endif
1133   5      #ifdef FUNC_SLAVE_UART_EN
                                                              SlaveRadioRetCurrentStatus();
              #endif
1136   5                                                      return;
1137   5                                              }
1138   4                                      }
1139   3      #ifdef FUNC_SLAVE_UART_EN
                                          if(((gRadioCtrl.SeekMode == SEEK_SCANDOWN) && (gRadioData.CurrFreq <= gRadioCt
             -rl.RadioLowerBound))
                                              || (((gRadioCtrl.SeekMode == SEEK_SCANUP) || (gRadioCtrl.SeekMode == SEEK_AUTOSCAN)) && (gRadioData.Cu
             -rrFreq >= gRadioCtrl.RadioUpperBound)))
              #else
1143   3                                      if(((gRadioCtrl.SeekMode == SEEK_SCANDOWN) && (gRadioData.CurrFreq <= RADIO_LOWER_BOUND))
1144   3                                      || (((gRadioCtrl.SeekMode == SEEK_SCANUP) || (gRadioCtrl.SeekMode == SEEK_AUTOSCAN)) && (gRadioData.Cu
             -rrFreq >= RADIO_UPPER_BOUND)))
1145   3      #endif
1146   3                                      { 
1147   4                                              gRadioCtrl.State = RADIO_IDLE;
1148   4                                              if((gRadioData.StationSum > 0) && (gRadioCtrl.SeekMode == SEEK_AUTOSCAN))
1149   4                                              {                                               
1150   5      #ifdef  FUNC_RADIO_AUTOSEEK_EN
1151   5      #ifdef FUNC_DISP_EN
1152   5                                                      DispResume();
1153   5      #endif
1154   5      #endif
1155   5                                                      gRadioData.CurrStation = 0;
1156   5      
1157   5                                                      if(gRadioData.Area1StationSum > 0)
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 13:58:50 PAGE 20  

1158   5                                                      {
1159   6                                                              gRadioData.CurrFreq = gRadioData.Stations[gRadioData.CurrStation] + RADIO_FREQ_BASE_760;
1160   6                                                      }
1161   5                                                      else
1162   5                                                      {
1163   6                                                              gRadioData.CurrFreq = gRadioData.Stations[gRadioData.CurrStation] + RADIO_FREQ_BASE_875;
1164   6                                                      }
1165   5                                                      
1166   5                                                      RadioSetFreq();                                                 
1167   5                                                      RadioWriteData();                                               
1168   5                                                      RadioShowDebug(RadioShowSearchEndBufferEnough); 
1169   5                                              }
1170   4                                              else
1171   4                                              {
1172   5                                                      DBG(("Error:empty\n"));
1173   5                                                      RadioSetFreq();
1174   5                                              }
1175   4                                              
1176   4                                              RadioMute(FALSE);       
1177   4                                              UnMute();
1178   4      #ifdef FUNC_SINGLE_LED_EN 
1179   4                                              DispDev();
1180   4      #endif
1181   4      #ifdef FUNC_SLAVE_UART_EN
                                                      SlaveRadioRetCurrentStatus();
              #endif
1184   4                                      }
1185   3                                      else
1186   3                                      {
1187   4                                              gRadioCtrl.State = RADIO_SEEK;
1188   4                                              
1189   4      #ifdef  FUNC_RADIO_AUTOSEEK_EN
1190   4                                              if(gRadioCtrl.SeekMode == SEEK_SCANDOWN)
1191   4                                              {
1192   5                                                      gRadioData.CurrFreq--;                                          
1193   5                                              }
1194   4                                              else
1195   4                                              {
1196   5                                                      gRadioData.CurrFreq++;
1197   5                                              }                                       
1198   4      #endif
1199   4                                      }               
1200   3                              }               
1201   2                              break;
1202   2                              
1203   2                      case RADIO_IDLE:
1204   2                              if(IsTimeOut(&gRadioCtrl.SeekPreviewTimer))
1205   2                              {       
1206   3                                      if(RadioDisFlag == RadioDisCurChChange)
1207   3                                      {
1208   4      #ifdef AU6210K_BOOMBOX_DEMO
                                                      RadioDisFlag = RadioDisCurPresetCh;
              #else
1211   4                                              RadioDisFlag = RadioDisCurFreNum;
1212   4      #endif
1213   4                                      }
1214   3                                      else if(RadioDisFlag == RadioDisCurChAutoscan)
1215   3                                      {
1216   4                                              RadioDisFlag = RadioDisCurFreNum;
1217   4                                      }                               
1218   3      #ifdef  FUNC_NUMBER_KEY_EN
1219   3                                      else if(RadioDisFlag == RadioDisCurFreBlink)
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 13:58:50 PAGE 21  

1220   3                                      {               
1221   4      #ifdef FUNC_DISP_EN             
1222   4                                              RadioDisBlink();
1223   4      #endif
1224   4                                              if(RadioDisCount > 0)
1225   4                                              {
1226   5                                                      RadioDisCount--;
1227   5                                              }
1228   4                                              else
1229   4                                              {
1230   5                                                      RadioDisFlag = RadioDisCurFreNum;
1231   5                                              }
1232   4                                              TimeOutSet(&gRadioCtrl.SeekPreviewTimer, RadioBlinkTime);                               
1233   4                                      }
1234   3      #endif
1235   3                              }
1236   2                              break;
1237   2                              
1238   2      #ifdef AU6210K_BOOMBOX_DEMO
                              case RADIO_PROG:
                                      if(IsTimeOut(&gRadioCtrl.SeekPreviewTimer))
                                      {
                                              gRadioCtrl.State = RADIO_IDLE;  
                                              RadioDisFlag = RadioDisCurFreNum;
                                      }
                                      break;
              #endif
1247   2                              
1248   2                      default:
1249   2                              break;  
1250   2              }
1251   1      }
1252          
1253          
1254          //按键响应
1255          //状态处理
1256          VOID RadioStateCtrl(VOID)
1257          {       
1258   1              RadioEventProcess();
1259   1              RadioStationSearch();
1260   1      
1261   1      #ifdef FUNC_RADIO_ESD_AUTO_RESUME
1262   1              if(gRadioCtrl.State == RADIO_IDLE)
1263   1              {
1264   2                      if(IsTimeOut(&RadioStateCheckTimer))
1265   2                      {               
1266   3                              if((MVFM_ReadReg(0x00) & 0x20) || (MVFM_GetCh() != gRadioCurrFreqBack))
1267   3                              {
1268   4                                      RadioStateCheckCount++;
1269   4                                      if(RadioStateCheckCount > 2)    
1270   4                                      {
1271   5                                              RadioSetFreq(); 
1272   5                                              RadioMute(FALSE);       
1273   5                                      }
1274   4                              }
1275   3                              else
1276   3                              {
1277   4                                      RadioStateCheckCount = 0;
1278   4                              }
1279   3                              TimeOutSet(&RadioStateCheckTimer, 250);
1280   3                      }                       
1281   2              }
C51 COMPILER V9.00   RADIO_CTRL                                                            12/29/2015 13:58:50 PAGE 22  

1282   1      #endif
1283   1      }
1284          
1285          #endif


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2214    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     18       2
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
