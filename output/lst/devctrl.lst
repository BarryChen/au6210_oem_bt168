C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE DEVCTRL
OBJECT MODULE PLACED IN .\output\obj\devctrl.obj
COMPILER INVOKED BY: d:\Keil\C51\BIN\C51.EXE device\devctrl.c LARGE OBJECTADVANCED OPTIMIZE(9,SIZE) BROWSE INCDIR(.\conf
                    -ig;.\device;.\display;.\fs;.\key;.\lib_if;.\play;.\system;.\library;.\power;.\radio;.\eeprom;.\spi_flash;.\slave;.\bluet
                    -ooth;.\i2c) DEBUG PRINT(.\output\lst\devctrl.lst) OBJECT(.\output\obj\devctrl.obj)

line level    source

   1          #include "syscfg.h"
   2          #include "sysctrl.h"
   3          #include "device_audio.h"
   4          #include "usb_audio_ctrl.h"
   5          #include "card_reader_ctrl.h"
   6          #include "playctrl.h"
   7          #include "device.h"
   8          #include "rtc_ctrl.h"
   9          #include "breakpoint.h"
  10          #include "linein_ctrl.h"
  11          #include "sleep.h"
  12          #include "radio_app_interface.h"
  13          #include "user_interface.h"
  14          #include "debug.h"
  15          #include "sys_on_off.h"
  16          #include "radio_ctrl.h"
  17          #include "display.h"
  18          #include "key.h"
  19          #include "spi_fs.h"
  20          #include "otp_play.h"
  21          #include "touch_key.h"
  22          #include "pt231x.h"
  23          #include "bluetooth_ctrl.h"
  24          #include "slave_ctrl.h"
  25          #include "bt.h"
  26          #include "npca110x.h"
  27          
  28          
  29          #ifdef FUNC_QUICK_RESPONSE_EN 
              BOOL IsSwitchMode;
              BYTE CurMode;
              #endif
  33          #ifdef FUNC_NPCA110X_EN
              extern BOOL isDefaultBass;
              #endif
  36          
  37          #ifdef FUNC_BT_CHAN_AUTO
  38          typedef enum _CHANNEL_TYPE{
  39                  CHANNEL_TYPE_NONE       = 0,
  40                  CHANNEL_TYPE_SD         = 1,
  41                  CHANNEL_TYPE_FM         = 2,
  42                  CHANNEL_TYPE_BT         = 3,
  43          
  44          }CHANNEL_TYPE;
  45          
  46          BYTE ChannelType = CHANNEL_TYPE_NONE;
  47          
  48          #endif
  49          
  50          
  51          BOOL isDealSetBass = FALSE;
  52          static  USHORT i = 0;
  53          
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 2   

  54          #ifdef   FUNC_USB_CHARGE_EN
              //µ±Ç°ÏµÍ³ÖÐÊÇ·ñÁ¬½ÓÁËAppleÉè±¸±êÖ¾
              BOOL     AppleDeviceFlag = FALSE;       
              //gMassStorInvalidVid = 0x05ACÊ±£¬°ÑIpodÉè±¸×÷Îª³äµçÉè±¸
              WORD     gMassStorInvalidVid = 0x05AC;
              #endif
  60          
  61          //#define FUNC_PAUSE_DURING_DEVTRY      //Éè±¸³¢ÊÔÇÐ»»Ê±Í£Ö¹²¥·Å£¬ÏÔÊ¾LOD.
  62          
  63          extern BOOL gDeviceError;
  64          extern SYS_MODE gSysMode;       // define in library.
  65          extern BOOL IsCardLinkFlag; //for audio
  66          extern BOOL gIsUsbRemove;//for usb Reconnect in mode switch 
  67          extern BOOL IsUsbLinkFlag; 
  68          
  69          #define PLAY_WATCH_TIME                         10000
  70          extern VOID SongPlayTimePause(VOID);
  71          extern VOID SongPlayTimeResume(VOID);
  72          extern TIMER gPlayWatchTimer;
  73          //extern TIMER VolumeUpTimer;
  74          extern TIMER CardDctTimer;
  75          extern VOID BassLed_CallBak(VOID);
  76          #define SET_BASS_TIME   1       
  77          TIMER SetBassTimer;
  78          
  79          //#ifdef FUNC_USB_MSC_SN_EN
  80          //BYTE gUDiskSN[MAX_USB_SN_LEN];
  81          //#endif
  82          
  83          #ifdef  FUNC_DEVICE_FORCEPAUSE_EN
              BOOL gDevicePlayForcePauseFlag = FALSE; //Ç¿ÖÆÔÝÍ£Éè±¸²¥·Å×´Ì¬
              #endif
  86          
  87          #ifdef  FUNC_HEADPHONE_DETECT_EN
              static TIMER sHeadPhoneCheckTimer;
              #endif
  90          
  91          #ifdef FUNC_POWER_ON_AUDIO_EN
              BOOL gUSBChargePowerOnFlag = TRUE;      //¹Ø»ú×´Ì¬ÏÂUSB³äµçÆ÷²åÉÏÏµÍ³¿ª»ú±êÖ¾
              #endif
  94          
  95          #ifdef FUNC_STANDBY_EN
              SYS_MODE gSystemExecState;
              #endif
  98          
  99          #ifdef FUNC_SNOOZE_EN
              #define SNOOZE_TIME             300000  // 5mins
              
              static TIMER sSnoozeTimer;
              static BOOL sSnoozeOnFlag = FALSE;
              static BOOL sAlarmPowerOnFlag = FALSE;
              #endif
 106          
 107          #ifdef FUNC_BEEP_SOUND_EN       
              extern  TIMER gPushKeyBeepTimer;
              #endif
 110          
 111          
 112          ////////////////////////////////////////////////////
 113          ///////////////////////////////////////////////////
 114          //Ç¿ÖÆ½øÈëÄ³ÖÖÄ£Ê½
 115          //²¢×öÔ­Ä£Ê½ÍË³öÊ±µÄÉÆºó´¦Àí¹¤×÷
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 3   

 116          static VOID GotoMode(BYTE Mode)
 117          {
 118   1      #ifdef FUNC_TOUCH_KEY_EN
                      TouchKeyScanInit();
              #endif
 121   1      
 122   1              switch(gSys.SystemMode)         //Ô­Ä£Ê½
 123   1              {
 124   2      #ifdef FUNC_USB_EN
                              case SYS_MODE_USB:              //Àë¿ªUSBÄ£Ê½
                                      //Í£Ö¹²¥·Å
                                      PlayCtrlEnd();
                                      break;
              #endif
 130   2      
 131   2      #ifdef FUNC_CARD_EN
 132   2                      case SYS_MODE_SD:               //Àë¿ªSDÄ£Ê½
 133   2                              //Í£Ö¹²¥·Å
 134   2                              PlayCtrlEnd();
 135   2                              break;
 136   2      #endif
 137   2      
 138   2      #ifdef FUNC_SPI_PLAY_EN
                              case SYS_MODE_SPIDEV:           //Àë¿ªSPIÄ£Ê½
                                      //Í£Ö¹²¥·Å
                                      PlayCtrlEnd();
                                      break;
              #endif
 144   2      
 145   2      #ifdef FUNC_RADIO_EN
 146   2                      case SYS_MODE_RADIO:            //Àë¿ªRADIOÄ£Ê½
 147   2                              if(Mode == SYS_MODE_RADIO)
 148   2                              {
 149   3                                      break;
 150   3                              }       
 151   2                              RadioCtrlDeinit();                              
 152   2      //#if (FM_IO_TYPE == DAC_OUT_LR)
 153   2      //                      DBG(("LeaveRad,DacInit\n"));
 154   2      //                      InDacInit(FALSE);
 155   2      //#endif
 156   2                              SysClkDivClr(); 
 157   2                              InDacSetVmid(FALSE);
 158   2                              break;
 159   2      #endif
 160   2      
 161   2      #ifdef FUNC_LINEIN_EN
                              case SYS_MODE_LINEIN:   //Àë¿ªline-inÄ£Ê½
                                      if(Mode == SYS_MODE_LINEIN)
                                      {
                                              break;
                                      }
                                      LineinIODeinit();
                                      //SysClkDivClr();       
                                      break;
              #endif
 171   2      #ifdef FUNC_BLUETOOTH_CSR_EN
 172   2                      case SYS_MODE_BLUETOOTH:        
 173   2                              if(Mode == SYS_MODE_BLUETOOTH)
 174   2                              {
 175   3                                      break;
 176   3                              }
 177   2                              BluetothCtrlEnd();
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 4   

 178   2                              //SysClkDivClr();       
 179   2                              break;
 180   2      #endif
 181   2      #if 0//def FUNC_BLUETOOTH_EN
                              case SYS_MODE_BLUETOOTH:
                                      if (Mode == SYS_MODE_BLUETOOTH)
                                      {
                                              break;
                                      }
                                      BluetothCtrlEnd();
                                      //SysClkDivClr();
                                      break;
              #endif
 191   2      
 192   2                      case SYS_MODE_SLEEP:    //Àë¿ªSLEEPÄ£Ê½
 193   2                              
 194   2                              break;
 195   2      
 196   2      #ifdef FUNC_RTC_EN
                              case SYS_MODE_RTC:              //Àë¿ªRTCÄ£Ê½
              
              #ifdef FUNC_POWER_AMPLIFIER_EN
                                      if (Mode == SYS_MODE_RTC)
                                      {
                                              break;
                                      }
                                      if (Mode != SYS_MODE_RADIO)
                                      {
                                              ABPowerAmplifierOn();
                                      }
              #endif  
              
              #ifdef FUNC_USB_VOLUP_EN
                                      if (Mode == SYS_MODE_RTC)
                                      {
                                              break;
                                      }
                                      if (Mode != SYS_MODE_USB)
                                      {
                                              USB_VOLUP_Off();
                                      }
              #endif          
                                      break;
              #endif
 222   2                              
 223   2      #if (defined(FUNC_AUDIO_EN) || defined(FUNC_READER_EN) || defined(FUNC_AUDIO_READER_EN))
                              case SYS_MODE_AUDIO:    //Àë¿ªUSBÉù¿¨Ä£Ê½
                              case SYS_MODE_READER:           //Àë¿ªUSB¶Á¿¨Æ÷Ä£Ê½
                              case SYS_MODE_AUDIO_READER:     //Àë¿ªUSBÒ»ÏßÍ¨Ä£Ê½
                                      DeviceAudioCtrlEnd();
                                      DeviceStorCtrlEnd();
                                      break;
              #endif
 231   2      
 232   2                      default:
 233   2                              break;
 234   2              }
 235   1              
 236   1      #ifdef FUNC_STANDBY_EN
                      if(Mode != SYS_MODE_STANDBY)
                      {
                              gSystemExecState = Mode;
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 5   

                      }
              #endif
 242   1      
 243   1              gSys.SystemMode = Mode;
 244   1              gSysMode = Mode;                //¶¨ÒåÔÚµ×²ã£¬ÎªÁË±ÜÃâµ×²ãÖ±½ÓÒýÓÃgSys.SystemModeÔö¼Ó(·ÀÖ¹Ó¦ÓÃ²ã´úÂëÐÞ¸ÄgSys½á¹¹ÌåÓ°Ïìµ
             -½µ×²ã)¡£
 245   1              MuteOn(TRUE, TRUE);     //¹Ø±ÕDAC¡¢LineIn¡¢FMInÍ¨µÀÊä³ö¡£
 246   1              gSys.MuteFg = FALSE;
 247   1              
 248   1              MessageInit();
 249   1      
 250   1      #ifdef FUN_SYSTEM_POWEROFF_WAIT_TIME
                      TimeOutSet(&gSysTimeOffState.DisTimer, 0);      
              #endif
 253   1      
 254   1      #ifdef FUNC_DISP_EN
 255   1              DispMute();     //ÕýÈ·»Ö¸´MuteÏÔÊ¾×´Ì¬¡£±ÜÃâ´ÓMute×´Ì¬ÏÂÇÐ»»Éè±¸Ôì³ÉµÄÏÔÊ¾´íÎó¡£
 256   1              DispDev();
 257   1      #endif
 258   1      }  
 259          
 260          
 261          #ifdef FUNC_STANDBY_EN
              //³¢ÊÔÇÐ»»µ½StandbyÄ£Ê½
              static BOOL TryGotoModeStandby(VOID)
              {       
                      DBG(("TryGotoModeStandby()\n"));
              
                      ModuleClkEn(MASK_ALL_CLOCK);
                      SysClkDivClr(); 
                      
                      GotoMode(SYS_MODE_STANDBY);     
                      
                      InDacChannelSel(DAC_CH_NONE);   
                      InDacPowerDown(FALSE);  
              
              #ifdef FUNC_POWER_AMPLIFIER_EN
                      ABPowerAmplifierOff();
              #endif
              
              #ifdef FUNC_SNOOZE_EN
                      sAlarmPowerOnFlag = FALSE;
              #endif
              
                      return TRUE;
              }
              #endif
 286          
 287          
 288          //³¢ÊÔÇÐ»»µ½IDLEÄ£Ê½
 289          static BOOL TryGotoModeIdle(VOID)
 290          {
 291   1              DBG(("TryGotoModeIdle()\n"));
 292   1              GotoMode(SYS_MODE_NONE);
 293   1      
 294   1              InDacChannelSel(DAC_CH_NONE);
 295   1      
 296   1      #ifdef FUNC_POWER_AMPLIFIER_EN
                      ABPowerAmplifierOff();
              #endif
 299   1      
 300   1              return TRUE;
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 6   

 301   1      }
 302          
 303          
 304          #ifdef FUNC_CARD_EN
 305          //³¢ÊÔÇÐ»»µ½SD¿¨Ä£Ê½
 306          static BOOL TryGotoModeSD(VOID)
 307          {
 308   1              BOOL TempFlag = FALSE;
 309   1      
 310   1      #ifdef FUNC_BT_CHAN_AUTO
 311   1              ChannelType = CHANNEL_TYPE_SD;
 312   1      #endif
 313   1                      
 314   1              DBG1(("TryGotoModeSD()\n"));
 315   1              
 316   1      #ifdef FUNC_POWER_ON_AUDIO_EN
                      if(gUSBChargePowerOnFlag == TRUE)
                      {
                              return FALSE;
                      }
              #endif
 322   1              
 323   1              if(IsCardLinkFlag == TRUE)
 324   1              {
 325   2                      MuteOn(TRUE, TRUE); //½â¾öSD»òUSBÖ®¼äÖ±½ÓÇÐ»»»áÍ£Ò»ÏÂÔÙ³öÖ®Ç°Éè±¸¸èÇúÉùÒôÎÊÌâ
 326   2                      TempFlag = TRUE;
 327   2              }
 328   1      
 329   1              //µÈ´ýSD¿¨»òUÅÌÉè±¸Á¬½Ó
 330   1              if(!IsCardLink())
 331   1              {
 332   2                      
 333   2                      DBG1(("IsCardLink() FALSE!\n"));
 334   2                      IsCardLinkFlag = FALSE;
 335   2                      return FALSE;
 336   2              }
 337   1              DBG1(("IsCardLink() OK!\n"));
 338   1      
 339   1              
 340   1      
 341   1              ModuleClkEn(MASK_ALL_CLOCK);
 342   1              SysClkDivClr(); 
 343   1      
 344   1              gPlayCtrl.State = PLAY_STATE_STOP;
 345   1              
 346   1      #ifdef FUNC_DISP_EN
 347   1              DispLoad();
 348   1      #endif
 349   1              if(TempFlag == FALSE)
 350   1              {
 351   2                      MuteOn(TRUE, TRUE); //½â¾öSD»òUSBÖ®¼äÖ±½ÓÇÐ»»»áÍ£Ò»ÏÂÔÙ³öÖ®Ç°Éè±¸¸èÇúÉùÒôÎÊÌâ
 352   2              }
 353   1      
 354   1              //WaitMs(50);
 355   1      
 356   1      //      if(!CardInit()) 
 357   1              {
 358   2                      //WaitMs(50);
 359   2                      if(!CardInit()) 
 360   2                      {
 361   3                              DBG1(("CardInit() error!\n"));
 362   3                              return FALSE;
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 7   

 363   3                      }
 364   2                      
 365   2              }
 366   1              DBG1(("Card OK!\n"));
 367   1      
 368   1              GotoMode(SYS_MODE_SD);
 369   1      #ifdef AU6210K_NR_D_8_CSRBT
                      NPCA110X_ADC_Input_CH_Select(INPUT_CH2);
              #endif
 372   1              InDacChannelSel(DAC_CH_DAC);
 373   1              
 374   1      #ifdef FUNC_SPI_KEY_SOUND_EN    
 375   1              SPI_PlaySelectNum(SPIPLAY_SONG_PLAY_TF, 0);
 376   1      #endif
 377   1              
 378   1              DBG1(("FSInit(DEV_ID_SD)\n"));
 379   1              if(!FSInit(DEV_ID_SD))
 380   1              {
 381   2                      DBG1(("FSInit() error!\n"));
 382   2                      return FALSE;
 383   2              }
 384   1      
 385   1              DBG1(("*******SD MODE********\n"));
 386   1              PlayCtrlInit();  
 387   1      #ifdef FUNC_TOUCH_KEY_EN
                      TR1 = 1;
              #endif
 390   1              return TRUE;
 391   1      }
 392          #endif
 393          
 394          
 395          #ifdef FUNC_USB_EN
              //³¢ÊÔÇÐ»»µ½USBÄ£Ê½
              static BOOL TryGotoModeUSB(VOID)
              {       
                      BOOL TempFlag = FALSE;
                      
                      DBG(("TryGotoModeUSB()\n"));
                      
              #ifdef FUNC_POWER_ON_AUDIO_EN
                      if(gUSBChargePowerOnFlag == TRUE)
                      {
                              return FALSE;
                      }
              #endif  
                      
                      if(IsUsbLinkFlag == TRUE)
                      {
                              MuteOn(TRUE, TRUE); //½â¾öSD»òUSBÖ®¼äÖ±½ÓÇÐ»»»áÍ£Ò»ÏÂÔÙ³öÖ®Ç°Éè±¸¸èÇúÉùÒôÎÊÌâ
                              TempFlag = TRUE;
                      }
                      
                      //UÅÌµçÆøÁ¬½Ó¼ì²é
                      if(!IsUSBLink())
                      {
                              DBG(("IsUSBLink() FALSE!\n"));
                              return FALSE;
                      }
                      DBG(("IsUSBLink() OK!\n"));
              
                      if(TempFlag == FALSE)
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 8   

                      {
                              MuteOn(TRUE, TRUE); //½â¾öSD»òUSBÖ®¼äÖ±½ÓÇÐ»»»áÍ£Ò»ÏÂÔÙ³öÖ®Ç°Éè±¸¸èÇúÉùÒôÎÊÌâ
                      }       
                      
                      ModuleClkEn(MASK_ALL_CLOCK);    
                      SysClkDivClr(); 
              
              #ifdef  FUNC_USB_CHARGE_EN
                      //·ÀÖ¹TryGotoModeUSB()º¯Êý±»¶à´Îµ÷ÓÃÊ±£¬µ¼ÖÂAppleDevice¶à´ÎÌáÊ¾³äµç
                      if(AppleDeviceFlag)
                      {
                              return FALSE;
                      }
              #endif
              
              #ifdef FUNC_DISP_EN
                      DispLoad();
              #endif
              
              //      DBG(("IsUSBLink() OK!\n"));
                      if(!HostStorInit())     
                      {
                              DBG(("HostStorInit() error!\n"));
              #ifdef  FUNC_USB_CHARGE_EN
                              //if(IsInvalidUsbDevice())
                              if(gLibUsbInfo.VID == 0x05AC)
                              {
                                      extern BYTE UsbSetConfiguration(BYTE configuration);
                                      AppleDeviceFlag = TRUE;                                                 
                                      UsbSetConfiguration(1);
                                      DBG(("USB³äµç¿ªÊ¼!\n"));
                              }
              #endif
                              return FALSE;
                      }
                      DBG(("USB OK!\n"));
              
                      GotoMode(SYS_MODE_USB);
                      InDacChannelSel(DAC_CH_DAC);
                      
              #if 0//def FUNC_SPI_KEY_SOUND_EN        
                      SPI_PlaySelectNum(SPIPLAY_SONG_HAVE_CALL, 0);
              #endif
              
                      DBG(("FSInit(DEV_ID_USB)\n"));
                      if(!FSInit(DEV_ID_USB))
                      {
                              DBG(("FSInit() error!\n"));
                              return FALSE;
                      }
              
                      DBG(("*******USB MODE********\n"));
                      PlayCtrlInit();
                      
              #ifdef FUNC_TOUCH_KEY_EN
                      TR1 = 1;
              #endif
                      return TRUE;
              }
              #endif
 485          
 486          
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 9   

 487          #ifdef FUNC_RADIO_EN
 488          //³¢ÊÔÇÐ»»µ½RADIOÄ£Ê½
 489          static BOOL TryGotoModeRADIO(VOID)
 490          {               
 491   1              DBG(("TryGotoModeRADIO()\n"));
 492   1      #ifdef FUNC_BT_CHAN_AUTO
 493   1              ChannelType = CHANNEL_TYPE_FM;
 494   1      #endif
 495   1      
 496   1      
 497   1      
 498   1      #ifdef FUNC_POWER_ON_AUDIO_EN
                      if(gUSBChargePowerOnFlag == TRUE)
                      {
                              return FALSE;
                      }
              #endif
 504   1      
 505   1              //UÅÌµçÆøÁ¬½Ó¼ì²é  
 506   1              if(!IsRadioLink())
 507   1              {
 508   2                      DBG(("IsRadioLink() FALSE!\n"));
 509   2                      return FALSE;
 510   2              }
 511   1              DBG(("IsRadioLink() OK!\n"));
 512   1              
 513   1              GotoMode(SYS_MODE_RADIO);
 514   1              
 515   1      #ifdef FUNC_SPI_KEY_SOUND_EN    
 516   1              SPI_PlaySelectNum(SPIPLAY_SONG_PLAY_FM, 0);
 517   1      #endif
 518   1       
 519   1              RadioPowerOn();
 520   1              InDacSetVmid(TRUE);
 521   1      
 522   1              //FM set
 523   1      #ifdef FM_DAC_OUT_D3D4
                      //Èç¹ûÒªÈÃFMÒôÆµ´ÓD3¡¢D4¿ÚÊä³ö£¬ÔòÐèÒª×öÈçÏÂÅäÖÃ        
                      SetGpioRegBit(GPIO_FMD_OE, 0x04);
                      ClrGpioRegBit(GPIO_FMD_IE, 0x04);
                      SetGpioRegBit(GPIO_FMD_OUT, 0x04);
              
                      ClrGpioRegBit(GPIO_D_PU, 0x18);
                      SetGpioRegBit(GPIO_D_PD, 0x18);
                      SetGpioRegBit(GPIO_FMA_EN, 0x03);       //Æ¬ÄÚFMÄ£¿éµÄÒôÆµÐÅºÅÁ¬½Óµ½D3¡¢D4
              
                      //ÔÙÑ¡ÔñÒôÆµÐÅºÅÊäÈëµ½Ð¾Æ¬ÄÚ²¿£¬È»ºó´Ó DACÊä³ö·½Ê½
                      //´ÓLine inÍ¨µÀÊäÈëµ½Ð¾Æ¬ÄÚ²¿
                      InDacChannelSel(DAC_CH_LINEIN); 
              
                      //´ÓE0 E1ÊäÈëµ½Ð¾Æ¬ÄÚ²¿
                      //SET_E0_ANALOG_IN();   //½«E0E1ÅäÖÃÎªÄ£Äâ¶Ë¿Ú
                      //SET_E1_ANALOG_IN();           
                      //InDacChannelSel(DAC_CH_E0E1);         
              
                      RadioCtrlInit();
              
              #else
 545   1              //Ä¬ÈÏÑ¡ÔñÆ¬ÄÚFMÒôÆµÍ¨Â·
 546   1              InDacChannelSel(DAC_CH_ONCHIP_FM);
 547   1      #endif
 548   1      
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 10  

 549   1      //FM    
 550   1      #ifdef FUNC_PWM_EN
                      ModuleClkDis(MASK_ALL_CLOCK & (~MSK_PWM_CLOCK));
              #else
 553   1              ModuleClkDis(MASK_ALL_CLOCK);
 554   1      #endif
 555   1      // ÇÐ»»µ½FMºó£¬Ê±ÖÓ·ÖÆµº¯Êý
 556   1      // O20ºÍÒÔÇ°Ð¾Æ¬²»Ò»Ñù£¬ÓÐÁ½¸öÊ±ÖÓÔ´£¬Ä¬ÈÏÊÇÅäÖÃÎªRC clk¡£
 557   1      #ifndef FUNC_SLAVE_UART_EN
 558   1              SysClkDivSet(CLK_DIV_RATE);
 559   1      #endif
 560   1      //#if (FM_IO_TYPE != FM_ONCHIP_IP)      
 561   1      //      RadioCtrlInit();
 562   1      //#endif
 563   1      
 564   1              RadioEnterInit();
 565   1      #ifdef FUNC_TOUCH_KEY_EN
                      TR1 = 1;
              #endif
 568   1              return TRUE;
 569   1      }
 570          #endif
 571          
 572          
 573          #ifdef FUNC_LINEIN_EN     
              //³¢ÊÔÇÐ»»µ½line-inÄ£Ê½
              static BOOL TryGotoModeLINEIN(VOID)
              {
                      DBG(("TryGotoModeLINEIN()\n"));
                      
              #ifdef FUNC_POWER_ON_AUDIO_EN
                      if(gUSBChargePowerOnFlag == TRUE)
                      {
                              return FALSE;
                      }
              #endif  
              
                      //UÅÌµçÆøÁ¬½Ó¼ì²é
                      if(!IsLineInLink())
                      {
                              DBG(("IsLineInLink() FALSE!\n"));
                              return FALSE;
                      }
                      ModuleClkEn(MASK_ALL_CLOCK);
                      SysClkDivClr(); 
                      DBG(("IsLineInLink() OK!\n"));
              
                      GotoMode(SYS_MODE_LINEIN);
              
              #ifdef FUNC_SPI_KEY_SOUND_EN    
                      SPI_PlaySelectNum(SPIPLAY_SONG_PLAY_AUX, 0);
              #endif  
              #ifdef AU6210K_NR_D_8_CSRBT
                      NPCA110X_ADC_Input_CH_Select(INPUT_CH0);
                      InDacChannelSel(LINEIN_IO_TYPE);
              #else
              
              
                      //Ä¬ÈÏLINE_INÄ£Ê½µÄÒôÔ´Ñ¡ÔñÆ¬ÍâLINE_INÍ¨Â·
                      //LINE_INÄ£Ê½µÄÒôÔ´Ò²¿ÉÒÔÑ¡ÔñE0¡¢E1Í¨Â·, ÔòÐèÒª×öÈçÏÂÅäÖÃ       
              /*#if (LINEIN_IO_TYPE == DAC_CH_E0_L)
                      SET_E0_ANALOG_IN();     //½«E0ÅäÖÃÎªÄ£Äâ¶Ë¿Ú
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 11  

              #elif (LINEIN_IO_TYPE == DAC_CH_E1_R)
                      SET_E1_ANALOG_IN();     //½«E1ÅäÖÃÎªÄ£Äâ¶Ë¿Ú
              #elif (LINEIN_IO_TYPE == DAC_CH_E0E1)
              */
              #if (LINEIN_IO_TYPE == DAC_CH_E0E1)
                      SET_E0_ANALOG_IN();     //½«E0E1ÅäÖÃÎªÄ£Äâ¶Ë¿Ú
                      SET_E1_ANALOG_IN();     
              #endif
              
                      InDacChannelSel(LINEIN_IO_TYPE);
              
              
              #endif  
                      LineInCtrlInit();
              
              #ifdef FUNC_TOUCH_KEY_EN
                      TR1 = 1;
              #endif
                      return TRUE;
              }
              #endif
 632          
 633          #ifdef FUNC_BLUETOOTH_CSR_EN      
 634          //³¢ÊÔÇÐ»»µ½line-inÄ£Ê½
 635          static BOOL TryGotoBluetooth(VOID)
 636          {
 637   1              DBG(("TryGotoModeLINEIN()\n"));
 638   1      
 639   1              
 640   1      #ifdef FUNC_BT_CHAN_AUTO
 641   1              ChannelType = CHANNEL_TYPE_BT;
 642   1      #endif
 643   1              
 644   1      #ifdef FUNC_POWER_ON_AUDIO_EN
                      if(gUSBChargePowerOnFlag == TRUE)
                      {
                              return FALSE;
                      }
              #endif  
 650   1      
 651   1              ModuleClkEn(MASK_ALL_CLOCK);
 652   1              SysClkDivClr(); 
 653   1              DBG1(("IsLineInLink() OK!\n"));
 654   1      
 655   1              GotoMode(SYS_MODE_BLUETOOTH);
 656   1      
 657   1      #ifdef FUNC_SPI_KEY_SOUND_EN    
 658   1              SPI_PlaySelectNum(SPIPLAY_SONG_PLAY_BT, 0);
 659   1      #endif  
 660   1      #ifndef FUNC_PT231X_EN
 661   1              //Ä¬ÈÏLINE_INÄ£Ê½µÄÒôÔ´Ñ¡ÔñÆ¬ÍâLINE_INÍ¨Â·
 662   1              //LINE_INÄ£Ê½µÄÒôÔ´Ò²¿ÉÒÔÑ¡ÔñE0¡¢E1Í¨Â·, ÔòÐèÒª×öÈçÏÂÅäÖÃ       
 663   1      /*#if (BLUETOOTH_CJ_IO_TYPE == DAC_CH_E0_L)
 664   1              SET_E0_ANALOG_IN();     //½«E0ÅäÖÃÎªÄ£Äâ¶Ë¿Ú
 665   1      #elif (BLUETOOTH_CJ_IO_TYPE == DAC_CH_E1_R)
 666   1              SET_E1_ANALOG_IN();     //½«E1ÅäÖÃÎªÄ£Äâ¶Ë¿Ú
 667   1      #elif (BLUETOOTH_CJ_IO_TYPE == DAC_CH_E0E1)
 668   1              SET_E0_ANALOG_IN();     //½«E0E1ÅäÖÃÎªÄ£Äâ¶Ë¿Ú
 669   1              SET_E1_ANALOG_IN();     
 670   1      #endif*/
 671   1      
 672   1              //InDacChannelSel(BLUETOOTH_CJ_IO_TYPE);
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 12  

 673   1      #endif  
 674   1              BluetoothCtrlInit();
 675   1      
 676   1      #ifdef FUNC_TOUCH_KEY_EN
                      TR1 = 1;
              #endif
 679   1              return TRUE;
 680   1      }
 681          #endif
 682          #if 0//def FUNC_BLUETOOTH_EN
              static BOOL TryGotoBluetooth()
              {
                      DBG(("TryGotoModeBLUETOOTH()\n"));
              #ifdef BLUETOOTH_ALWAYS_OPEN
                      if (!gBTConnected)//À¶ÑÀÎ´Á¬½ÓÉÏÊ±£¬²»½øÈëÀ¶ÑÀ×´Ì¬
                      {
                              DBG(("Bluetooth disconnected, don't entry bluetooth mode.\n"));
                              return FALSE;
                      }
              #endif
                      
                      MuteOn(TRUE, TRUE);//ÏÈ½ûµôÉùÒô£¬È¥POPOÉù£¬BluetoothCtrlInit()ÖÐ»áÔÙ´ÎÆô¶¯ÉùÒô
                      ModuleClkEn(MASK_ALL_CLOCK);
                      SysClkDivClr();//ÖØÖÃÏµÍ³×´Ì¬
                      GotoMode(SYS_MODE_BLUETOOTH);   //½øÈëBLUETOOTHÄ£Ê½
              
              #ifdef RTC_SHOWTIME_ANYMODE
                      DispTimeOnOff(FALSE);
              #endif
              
              #if defined(AU6210K_JLH_JH82B)
                      InDacChannelSel(DAC_CH_NONE);
              #endif
              
              #if defined(AU6210K_NR_D_8_CSRBT)
                      InDacChannelSel(BLUETOOTH_CJ_IO_TYPE);
              #endif
              
                      return BluetoothCtrlInit();
              }
              #endif
 714          
 715          
 716          ////³¢ÊÔÇÐ»»µ½RTCÄ£Ê½
 717          //static BOOL TryGotoModeRTC(VOID)
 718          //{
 719          //      DBG(("TryGotoModeRTC()\n"));
 720          //      GotoMode(SYS_MODE_RTC);
 721          //
 722          //      InDacChannelSel(DAC_CH_NONE);
 723          //#ifdef FUNC_POWER_AMPLIFIER_EN
 724                  //ABPowerAmplifierOff();
 725          //#endif
 726          //      return TRUE;
 727          //}
 728          
 729          
 730          #ifdef FUNC_AUDIO_EN
              //³¢ÊÔÇÐ»»µ½AUDIOÄ£Ê½
              static BOOL TryGotoModeAUDIO(VOID)
              {
              #ifdef FUNC_POWER_ON_AUDIO_EN   
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 13  

                      static TIMER Timer;
              #endif
              
                      DBG(("TryGotoModeAUDIO()\n"));  
                      
              #ifdef FUNC_POWER_ON_AUDIO_EN
                      //Á¬½ÓPC¿ª»úÖ±½Ó½øÈëAudio Ä£Ê½
                      if(gUSBChargePowerOnFlag == TRUE)
                      {
                              TimeOutSet(&Timer, 1500);       //Èç¹û¿Í»§Ï£ÍûÁ¬½ÓPC¿ª»úÐèÒªÖ±½Ó½øÈëAudioÄ£Ê½,´ËÊ±¼ä±ØÐë´óÓÚ1.4s
                              while(!IsTimeOut(&Timer))
                              {
                                      if(IsPcLink())
                                      {
                                              break;
                                      }
                              }                       
                      }
                      gUSBChargePowerOnFlag = FALSE;
              #endif
                      
                      //PCÁ¬½Ó¼ì²é
                      IsPcInsert();   //ÎªÁËPCÁ¬½Ó¿ª»úÇé¿öÏÂ¼ì²éPC ×´Ì¬
                      
                      if(!IsPcLink())
                      {
                              DBG(("Audio,IsPcLink() FALSE!\n"));
                              return FALSE;
                      }
              
              #ifdef FUNC_DISP_EN     
                      DispAudio();
              #endif  
              
                      MuteOn(TRUE, TRUE);     //½â¾öÁ¬½Ó PC¹ý³ÌÖÐ»áÔÙ³öÖ®Ç°Éè±¸¸èÇúÉùÒôÎÊÌâ
              
                      ModuleClkEn(MASK_ALL_CLOCK);            
                      SysClkDivClr();
              
                      GotoMode(SYS_MODE_AUDIO);
                      InDacChannelSel(DAC_CH_DAC);
                      
                      DeviceAudioSetMode(USB_DEVICE_AUDIO);
                      DeviceAudioCtrlInit();
              #ifdef FUNC_TOUCH_KEY_EN
                      TR1 = 1;
              #endif
              
              //      DBG(("Usb audio mode ok!\n"));
                      return TRUE;
              }
              #endif
 787          
 788          
 789          #ifdef FUNC_READER_EN
              //³¢ÊÔÇÐ»»µ½READERÄ£Ê½
              static BOOL TryGotoModeREADER(VOID)
              {       
                      DBG(("TryGotoModeREADER()\n"));
                      //PCÁ¬½Ó¼ì²é
                      if(!IsPcLink())
                      {
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 14  

                              DBG(("Reader,IsPcLink() FALSE!\n"));
                              return FALSE;
                      }
              
                      MuteOn(TRUE, TRUE);     //½â¾öÁ¬½Ó PC¹ý³ÌÖÐ»áÔÙ³öÖ®Ç°Éè±¸¸èÇúÉùÒôÎÊÌâ
              
              #ifdef FUNC_DISP_EN
                      DispLoad();
              #endif
              
                      ModuleClkEn(MASK_ALL_CLOCK);            
                      SysClkDivClr();
              
                      GotoMode(SYS_MODE_READER);
                      InDacChannelSel(DAC_CH_DAC);
              
                      DeviceAudioSetMode(USB_DEVICE_READER);
              #ifdef FUNC_CARD_EN 
                      DeviceStorCtrlInit();
              #endif
              #ifdef FUNC_TOUCH_KEY_EN
                      TR1 = 1;
              #endif
              //      DBG(("Usb reader mode ok!\n"));
                      return TRUE;
              }
              #endif
 824          
 825          
 826          #ifdef FUNC_AUDIO_READER_EN
              //³¢ÊÔÇÐ»»µ½AUDIO_READERÄ£Ê½
              static BOOL TryGotoModeAUDIO_READER(VOID)
              {       
              #ifdef FUNC_POWER_ON_AUDIO_EN   
                      static TIMER Timer;
              #endif
              
                      DBG(("TryGotoModeAUDIO_READER()\n"));   
                      
              #ifdef FUNC_POWER_ON_AUDIO_EN
                      //Á¬½ÓPC¿ª»úÖ±½Ó½øÈëAudio Ä£Ê½
                      if(gUSBChargePowerOnFlag == TRUE)
                      {
                              TimeOutSet(&Timer, 1500);       //Èç¹û¿Í»§Ï£ÍûÁ¬½ÓPC¿ª»úÐèÒªÖ±½Ó½øÈëAudioÄ£Ê½,´ËÊ±¼ä±ØÐë´óÓÚ1.4s
                              while(!IsTimeOut(&Timer))
                              {
                                      if(IsPcLink())
                                      {
                                              break;
                                      }
                              }                       
                      }
                      gUSBChargePowerOnFlag = FALSE;
              #endif
              
                      //PCÁ¬½Ó¼ì²é
                      IsPcInsert();   //ÎªÁËPCÁ¬½Ó¿ª»úÇé¿öÏÂ¼ì²éPC ×´Ì¬
              
                      if(!IsPcLink())
                      {
                              DBG(("Audio,IsPcLink() FALSE!\n"));
                              return FALSE;
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 15  

                      }       
              
              #ifdef FUNC_DISP_EN     
                      DispAudio();
              #endif  
              
                      MuteOn(TRUE, TRUE);     //½â¾öÁ¬½Ó PC¹ý³ÌÖÐ»áÔÙ³öÖ®Ç°Éè±¸¸èÇúÉùÒôÎÊÌâ
                      
                      ModuleClkEn(MASK_ALL_CLOCK);            
                      SysClkDivClr();
              
                      GotoMode(SYS_MODE_AUDIO_READER);
                      InDacChannelSel(DAC_CH_DAC);
                      
                      DeviceAudioSetMode(USB_DEVICE_AUDIO_READER);
                      DeviceAudioCtrlInit();
              #ifdef FUNC_CARD_EN 
                      DeviceStorCtrlInit();
              #endif
              #ifdef FUNC_TOUCH_KEY_EN
                      TR1 = 1;
              #endif
              //      DBG(("Usb audio reader mode ok!\n"));
                      return TRUE;
              }
              #endif
 885          
 886          
 887          #ifdef  FUNC_SPI_UPDATE_EN
              extern BYTE gIsMVFFileFind;
              #endif
 890          #ifdef FUNC_SPI_PLAY_EN
              //³¢ÊÔÇÐ»»µ½spi-devÄ£Ê½
              static BOOL TryGotoModeSpiDev()
              {
                      DBG(("->TryGotoSPIDev!\n"));
              
                      if(!IsSpiFlashHandleGot())
                      {
                              DBG(("No SPI Dev!\n"));
                              return FALSE;
                      }
              #ifdef FUNC_DISP_EN
                      DispLoad();
              #endif
              
                      ModuleClkEn(MASK_ALL_CLOCK);            
                      SysClkDivClr();
              
                      GotoMode(SYS_MODE_SPIDEV);
                      InDacChannelSel(DAC_CH_DAC);
              
              #ifdef  FUNC_SPI_UPDATE_EN
                      gIsMVFFileFind = 0;
              #endif
              
                      FSInit(DEV_ID_SPI);
                      PlayCtrlInit();
                      gSongInfo.SongType = SONG_TYPE_MP3; 
                      gPlayCtrl.File.FileType = FILE_TYPE_MP3;
                      gPlayCtrl.FileNum = 1;
                      DBG(("<-TryGotoSPIDev!\n"));
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 16  

              #ifdef FUNC_TOUCH_KEY_EN
                      TR1 = 1;
              #endif  
                      return TRUE;
              }
              #endif
 927          
 928          
 929          #ifdef FUNC_OTP_PLAY_EN
              static BOOL TryGotoModeOtpDev(VOID)
              {
                      DBG((">>TryGotoModeOtpDev()\n"));
              #ifdef FUNC_DISP_EN
                      DispLoad();
              #endif
              
                      ModuleClkEn(MASK_ALL_CLOCK);            
                      SysClkDivClr();
                              
                      GotoMode(SYS_MODE_OTPDEV);
                      InDacChannelSel(DAC_CH_DAC);
              
                      FSInit(DEV_ID_OTP);
                      PlayCtrlInit();
                      gSongInfo.SongType = SONG_TYPE_MP3; 
                      gPlayCtrl.File.FileType=FILE_TYPE_MP3;
                      gPlayCtrl.FileNum = 1;
              #ifdef FUNC_TOUCH_KEY_EN
                      TR1 = 1;
              #endif
                      return TRUE;
              }
              
              
              //²¥·ÅÑ¡ÔñµÄOTP¸èÇú
              static VOID OTP_PlaySelectNum(BYTE PlayNum)
              {       
                      BYTE SystemMode, Volume;
              
                      SystemMode = gSys.SystemMode;   
                      Volume = gSys.Volume;   
                      
                      DBG(("<-OTPSongPlayStart()\n"));        
                      PlayNum = 1;    
                      gSys.Volume = VOLUME_MAX;
              #ifdef AU6210K_NR_D_8_CSRBT
                      NPCA110X_DAC1_Set_Volume_and_Mute(gSys.Volume);
                      InDacSetVolume(gVolArr[32], gVolArr[32]);
              #else
                      InDacSetVolume(gVolArr[gSys.Volume], gVolArr[gSys.Volume]);
              #endif  
                      TryGotoModeOtpDev();
                      UnMute();       
                      while(1)
                      {    
                              FeedWatchDog(); 
                              if(FileEOF(&gPlayCtrl.File) && IsFifoEmpty())
                              {
                                      DBG(("Song play end!\n"));
                                      //µÈ´ýPCMÊý¾ÝÈ«²¿±»È¡×ß
                                      break;
                              }
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 17  

                              if(!SongPlayDo())
                              {
                                      DBG(("PlayStatePlayOp,!SongPlayDo()\n"));                       
                                      break;
                              }       
                      }
                      DBG(("<-OTPSongPlayStop()\n"));
                      PlayCtrlEnd();  
                      InDacChannelSel(DAC_CH_NONE);
                      gSys.SystemMode = SystemMode;
                      gSys.Volume = Volume;
              }
              #endif
 996          
 997          
 998          //ÏµÍ³ÉÏµç¿ª»úÒôÀÖÉù
 999          VOID SystemPowerOnSound(VOID)
1000          {       
1001   1      #ifdef  FUNC_OTP_KEY_SOUND_EN
                      OTP_PlaySelNum(OTPPLAY_NUM_POWERON, 0);
              #endif
1004   1      
1005   1      #ifdef FUNC_SPI_FLASH_POWERON_SOUND
1006   1              SPI_PlaySelectNum(SPIPLAY_SONG_POWER_ON_SOUND1, 0);
1007   1      #endif
1008   1      }
1009          
1010          
1011          //³¢ÊÔÇÐ»»µ½Ö¸¶¨Éè±¸
1012          static BOOL TryGotoMode(BYTE Mode)
1013          {       
1014   1      #ifdef  FUNC_QUICK_RESPONSE_EN
                      //Èç¹ûÊÇÇ¿ÐÐÇÐ»»Ä£Ê½
                      if(IsSwitchMode)
                      {
                              DBG(("300\n"));
                              return TRUE;
                      }
              
                      CurMode = Mode;
              #endif
1024   1      
1025   1              switch(Mode)
1026   1              {
1027   2      #ifdef FUNC_SLAVE_UART_EN
                              case SYS_MODE_NONE:
                                      return TryGotoModeIdle();
              #endif          
1031   2              
1032   2      #ifdef FUNC_USB_EN
                              case SYS_MODE_USB:
                                      return TryGotoModeUSB();
              #endif
1036   2      
1037   2      #ifdef FUNC_CARD_EN
1038   2                      case SYS_MODE_SD:
1039   2                              return TryGotoModeSD();
1040   2      #endif
1041   2      
1042   2      #ifdef FUNC_LINEIN_EN
                              case SYS_MODE_LINEIN:
                                      return TryGotoModeLINEIN();
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 18  

              #endif
1046   2      #ifdef FUNC_BLUETOOTH_CSR_EN
1047   2                      case SYS_MODE_BLUETOOTH:
1048   2                              return TryGotoBluetooth();
1049   2      #endif
1050   2      #ifdef FUNC_BLUETOOTH_EN
                              case SYS_MODE_BLUETOOTH:
                                      return TryGotoBluetooth();
              #endif
1054   2      
1055   2      
1056   2      #ifdef FUNC_RADIO_EN
1057   2                      case SYS_MODE_RADIO:
1058   2                              DBG(("TryGotoModeRADIO\n"));
1059   2                              return TryGotoModeRADIO();
1060   2      #endif
1061   2      
1062   2      #ifdef FUNC_AUDIO_EN
                              case SYS_MODE_AUDIO:
                                      DBG(("TryGotoModeAUDIO\n"));
                                      return TryGotoModeAUDIO();
              #endif
1067   2      
1068   2      #ifdef FUNC_READER_EN
                              case SYS_MODE_READER:
                                      DBG(("TryGotoModeREADER\n"));
                                      return TryGotoModeREADER();
              #endif
1073   2      
1074   2      #ifdef FUNC_AUDIO_READER_EN
                              case SYS_MODE_AUDIO_READER:
                                      DBG(("TryGotoModeAUDIO_READER\n"));
                                      return TryGotoModeAUDIO_READER();
              #endif
1079   2      
1080   2      #ifdef FUNC_SPI_PLAY_EN
                              case SYS_MODE_SPIDEV:
                                      DBG(("TryGotoModeOtpDevSPI\n"));
                                      return TryGotoModeSpiDev();
                                      break;
              #endif
1086   2      
1087   2      #ifdef FUNC_OTP_PLAY_EN
                              case SYS_MODE_OTPDEV:
                                      DBG(("TryGotoModeOtpDev001\n"));
                                      return TryGotoModeOtpDev();
                                      break;
              #endif
1093   2      
1094   2      #ifdef FUNC_STANDBY_EN
                              case SYS_MODE_STANDBY:
                                      return TryGotoModeStandby();
                                      break;
              #endif
1099   2      
1100   2                      default:
1101   2      #ifdef FUNC_USB_EN
                                      return TryGotoModeUSB();
              #elif defined(FUNC_CARD_EN)
1104   2                              return TryGotoModeSD();
1105   2      #else
                                      return FALSE;
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 19  

              #endif
1108   2              }
1109   1      }
1110          
1111          
1112          //³¢ÊÔÇÐ»»µ½ModeÄ£Ê½£¬Èç¹û²»³É¹¦£¬Ôò½øÈëÏÂÒ»¸öÄ£Ê½¡£
1113          static VOID TryGotoNextMode(BYTE Mode)
1114          {
1115   1              BYTE i;
1116   1              BYTE ModeIndex;
1117   1      
1118   1              //Õâ¸öÊý×é¾ö¶¨Éè±¸ÇÐ»»Ê±µÄË³Ðò£¬¸ÃË³ÐòÊÇÑ­»·µÄ
1119   1              static BYTE ModeOrder[] = 
1120   1              {
1121   1      #ifdef FUNC_BLUETOOTH_EN
                              SYS_MODE_BLUETOOTH, 
              #endif
1124   1              
1125   1      
1126   1      #ifdef FUNC_BLUETOOTH_CSR_EN
1127   1                      SYS_MODE_BLUETOOTH, 
1128   1      #endif
1129   1      
1130   1      #ifdef FUNC_USB_EN
                              SYS_MODE_USB,
              #endif  
1133   1      
1134   1      #ifdef FUNC_CARD_EN
1135   1                      SYS_MODE_SD,
1136   1      #endif
1137   1      
1138   1      
1139   1      #ifdef FUNC_LINEIN_EN
                              SYS_MODE_LINEIN,
              #endif  
1142   1      
1143   1      #ifdef FUNC_RADIO_EN
1144   1                      SYS_MODE_RADIO,
1145   1      #endif
1146   1      
1147   1       
1148   1      #ifdef FUNC_AUDIO_EN
                              SYS_MODE_AUDIO,
              #endif
1151   1      
1152   1      #ifdef FUNC_READER_EN
                              SYS_MODE_READER,
              #endif
1155   1      
1156   1      #ifdef FUNC_AUDIO_READER_EN
                              SYS_MODE_AUDIO_READER,
              #endif
1159   1      
1160   1      #ifdef FUNC_SPI_PLAY_EN
                              SYS_MODE_SPIDEV,
              #endif
1163   1      
1164   1      #ifdef FUNC_OTP_PLAY_EN
                              SYS_MODE_OTPDEV,
              #endif
1167   1              };
1168   1      
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 20  

1169   1              for(ModeIndex = 0; ModeIndex < sizeof(ModeOrder); ModeIndex++)
1170   1              {
1171   2                      if(Mode == ModeOrder[ModeIndex])
1172   2                      {
1173   3                              break;
1174   3                      }
1175   2              }
1176   1      
1177   1              for(i = 0; i < sizeof(ModeOrder); i++)
1178   1              {
1179   2                      FeedWatchDog();
1180   2                      ModeIndex++;
1181   2                      if(ModeIndex >= sizeof(ModeOrder))
1182   2                      {
1183   3                              ModeIndex = 0;
1184   3                      }               
1185   2                      
1186   2      #ifdef AU6210K_XLX_ALD800
                              if(ModeOrder[ModeIndex] == SYS_MODE_LINEIN)
                              {
                                      if(TryGotoMode(SYS_MODE_BLUETOOTH))
                                      {
                                              return;
                                      }
                              }
                                      
              
              #endif
1197   2                      if(TryGotoMode(ModeOrder[ModeIndex]))
1198   2                      {
1199   3                              return;
1200   3                      }
1201   2              }
1202   1      
1203   1              TryGotoModeIdle();
1204   1      }
1205          
1206          
1207          //³¢ÊÔÇÐ»»µ½ModeÄ£Ê½£¬Èç¹û²»³É¹¦£¬Ôò½øÈëÏÂÒ»¸öÄ£Ê½¡£
1208          static VOID TryGotoValidMode(BYTE Mode)
1209          {
1210   1              if(!TryGotoMode(Mode))
1211   1              {
1212   2                      TryGotoNextMode(Mode);
1213   2              }
1214   1      }
1215          
1216          
1217          //³¢ÊÔÇÐ»»µ½ModeÄ£Ê½£¬Èç¹û²»³É¹¦£¬Ôò½øÈëÔ­À´µÄÄ£Ê½¡£
1218          static VOID TryGotoValidModeReturn(BYTE Mode)
1219          {
1220   1              BYTE OldMode = gSys.SystemMode;
1221   1      
1222   1      #ifdef  FUNC_DEVICE_FORCEPAUSE_EN
                      gDevicePlayForcePauseFlag = FALSE;
              #endif
1225   1      
1226   1              if(!TryGotoMode(Mode))
1227   1              {
1228   2                      if(!TryGotoMode(OldMode))
1229   2                      {
1230   3                              TryGotoNextMode(SYS_MODE_USB);
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 21  

1231   3                      }
1232   2              }
1233   1      }
1234          
1235          
1236          VOID DevCtrlInit(VOID)
1237          {
1238   1              static TIMER Timer;
1239   1      
1240   1      //      TimeOutSet(&VolumeUpTimer, 0);
1241   1              TimeOutSet(&gPlayWatchTimer, 0);
1242   1              
1243   1      #ifdef  FUNC_HEADPHONE_DETECT_EN
                      TimeOutSet(&sHeadPhoneCheckTimer, 0);
              #endif
1246   1              
1247   1      #ifdef FUNC_BEEP_SOUND_EN
                      TimeOutSet(&gPushKeyBeepTimer, 0);
              #endif  
1250   1      
1251   1      #ifdef FUNC_SNOOZE_EN
                      TimeOutSet(&sSnoozeTimer, 0);
              #endif  
1254   1      
1255   1      #ifdef FUNC_LED_LINEIN_MULTIPLE_EN
                      TimeOutSet(&gLineInCheckWaitTimer, 0);
              #endif
1258   1      
1259   1      #ifndef FUNC_BREAK_POINT_EN
                      gSys.SystemMode = SYS_MODE_NONE;
                      gSys.Volume = VOLUME_INIT;
                      gPlayCtrl.Eq = DECD_EQ_NORMAL;
                      gPlayCtrl.RepeatMode = REPEAT_ALL;
              #ifdef FUNC_FOLDER_EN
                      gPlayCtrl.FolderEnable = TRUE;
              #else
                      gPlayCtrl.FolderEnable = FALSE;
              #endif
              #endif
1270   1      
1271   1      #ifdef FUNC_QUICK_RESPONSE_EN
                      IsSwitchMode = FALSE;
              #endif
1274   1      
1275   1      #ifdef FUNC_USB_EN
                      DBG(("InitUsb()\n"));
                      HostInit();
              #endif
1279   1      
1280   1      #ifdef FUNC_CARD_EN
1281   1      #ifdef CARD_BUS_A3A4A5_EN
1282   1              SET_CARD_TO_A3A4A5();
1283   1      #endif
1284   1      #ifdef  CARD_BUS_A0E2E3_EN
                      SET_CARD_TO_A0E2E3();
              #endif
1287   1      #ifdef  CARD_BUS_D5D6D7_EN
                      SET_CARD_TO_D5D6D7();
              #endif
1290   1              DBG(("CardOpen()\n"));
1291   1              CardOpen();
1292   1              TimeOutSet(&CardDctTimer, 0);
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 22  

1293   1      #endif
1294   1      
1295   1      #ifdef FUNC_RADIO_EN
1296   1      #ifdef FUNC_SLAVE_UART_EN
                     gRadioCtrl.RadioUpperBound = RADIO_UPPER_BOUND;
                     gRadioCtrl.RadioLowerBound = RADIO_LOWER_BOUND;
                      gRadioCtrl.RadioFreqBase = gRadioCtrl.RadioLowerBound;   
                      gRadioCtrl.RadioSeekStep = RADIO_SEEK_STEP_100KHZ;
              #endif
1302   1      
1303   1              RadioInit();
1304   1              RadioPowerDown();
1305   1      #endif
1306   1      
1307   1      #ifdef FUNC_POWER_AMPLIFIER_EN
                              ABPowerAmplifierOn();   //ÔÚÆäËüÄ£Ê½ÏÂÑ¡ÔñAB Àà¹¦·Å
              #endif  
1310   1      
1311   1      
1312   1              //µÈ´ý300ºÁÃë£¬µÚÒ»´Î¼ì²âËùÓÐÉè±¸µÄÁ¬½Ó×´Ì¬
1313   1              //Ïû³ýÏµÍ³¸´Î»ºóµÚÒ»´ÎµÄºó²åÏÈ²¥
1314   1              TimeOutSet(&Timer, 300);
1315   1              while(!IsTimeOut(&Timer))
1316   1              {       
1317   2      #ifdef FUNC_HEADPHONE_ADC_DETECT_EN
                              KeyEventGet();  
              #endif
1320   2              
1321   2      #ifdef FUNC_USB_EN
                              IsUsbInsert();
              #endif
1324   2      #ifdef AU6210K_NR_D_8_CSRBT
              #ifdef FUNC_LINEIN_EN
                              IsLineInInsert();
              #endif
              #ifdef FUNC_CARD_EN
                              IsCardInsert();
              #endif
              
              #else
1333   2      #ifdef FUNC_CARD_EN
1334   2                      IsCardInsert();
1335   2      #endif
1336   2      
1337   2      #ifdef FUNC_LINEIN_EN
                              IsLineInInsert();
              #endif
1340   2      #endif
1341   2              }
1342   1      
1343   1      #ifdef  FUNC_HEADPHONE_DETECT_EN
                      IsHeadPhonInsert();
              #endif
1346   1      
1347   1      #ifdef OPTION_CHARGER_DETECT
                      IsChargerInsert();
                      
                      if(IsChargerLinkFlag == TRUE)  
                      {
              #ifdef  FUNC_DEVICE_FORCEPAUSE_EN
                              gDevicePlayForcePauseFlag = TRUE;
              #endif
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 23  

                      }       
                      else
                      {                       
              #ifdef FUNC_POWER_ON_AUDIO_EN
                              gUSBChargePowerOnFlag = FALSE;                                  
              #endif
                      }
              #endif   
1363   1      
1364   1      #if (defined(FUNC_OTP_KEY_SOUND_EN) || defined(FUNC_SPI_FLASH_POWERON_SOUND))
1365   1              SystemPowerOnSound();   //ÏµÍ³¿ª»úÒôÀÖ²¥·Å
1366   1      #endif
1367   1      
1368   1      #if (defined(FUNC_AUDIO_EN) || defined(FUNC_AUDIO_READER_EN))
              //Á¬½ÓPC¿ª»úÖ±½Ó½øÈëAudio Ä£Ê½
              #ifdef FUNC_POWER_ON_AUDIO_EN
              #ifdef FUNC_AUDIO_EN
                      gSys.SystemMode = SYS_MODE_AUDIO;
              #else
                      gSys.SystemMode = SYS_MODE_AUDIO_READER;
              #endif
              #endif
              #endif
1378   1      
1379   1      #ifdef FUNC_STANDBY_EN
                      gSys.SystemMode = SYS_MODE_STANDBY;
              #endif
1382   1      #ifdef FUNC_PT231X_EN
                     gSys.Volume =VOLUME_INIT;
                     PT2313Init();
              #endif
1386   1      
1387   1      #if 0//defined(AU6210K_NR_D_9X_XJ_HTS)
                      if (IsUsbLinkFlag == TRUE)
                      {
                              gSys.SystemMode = SYS_MODE_USB;
                      }
                      else if (IsCardLinkFlag == TRUE)
                      {
                              gSys.SystemMode = SYS_MODE_SD;
                      }
                      else
                      {
                              gSys.SystemMode = SYS_MODE_BLUETOOTH;
                      }
              #endif
1401   1      
1402   1      #if defined(AU6210K_NR_D_8_CSRBT)|| defined(AU6210K_ZB_BT007_CSR)
1403   1      #ifdef FUNC_LINEIN_EN
                      if (IsLineInLinkFlag == TRUE)
                      {
                              gSys.SystemMode = SYS_MODE_LINEIN;
                      }
                      else 
              #endif
1410   1      
1411   1      #ifdef FUNC_CARD_EN
1412   1              if(IsCardLinkFlag == TRUE)
1413   1              {
1414   2                      gSys.SystemMode = SYS_MODE_SD;
1415   2              }
1416   1              else
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 24  

1417   1      #endif
1418   1              {
1419   2                      gSys.SystemMode = SYS_MODE_BLUETOOTH;
1420   2              }
1421   1      #endif
1422   1      
1423   1      
1424   1      #if 0// defined(AU6210K_HXX_B002)
                      if (IsCardLinkFlag == TRUE)
                      {
                              gSys.SystemMode = SYS_MODE_SD;
                      }
                      else
                      {
                              gSys.SystemMode = SYS_MODE_BLUETOOTH;
                      }
              #endif
1434   1      
1435   1      #if defined(AU6210K_JLH_JH82B)
                              gSys.SystemMode = SYS_MODE_BLUETOOTH;
              #endif
1438   1              if(!TryGotoMode(gSys.SystemMode))
1439   1              {
1440   2      #ifndef FUNC_QUICK_RESPONSE_EN
1441   2      #ifdef FUNC_BLUETOOTH_EN
                              TryGotoValidMode(SYS_MODE_BLUETOOTH);
              #else
1444   2      #ifdef AU6210K_NR_D_8_CSRBT
                              TryGotoValidMode(SYS_MODE_SD);
              #else
1447   2                      TryGotoValidMode(SYS_MODE_BLUETOOTH);
1448   2      #endif
1449   2      #endif
1450   2      #else
                              //½øÈë¶ÏµãÐÅÏ¢ÖÐµÄÄ£Ê½Ê±Ê§°Ü£¬Ôò³¢ÊÔ½øÈëµÚÒ»¸öÓÐÐ§Ä£Ê½
                              if(!IsSwitchMode)
                              {
                                      TryGotoValidMode(SYS_MODE_USB);
                              }
              
                              //ÓÐÄ£Ê½°´¼ü£¬Ôò³¢ÊÔÇÐ»»Ä£Ê½
                              while(IsSwitchMode)
                              {
                                      IsSwitchMode = FALSE;
                                      DBG(("CurMode: %d\n", (WORD)CurMode));
                                      TryGotoNextMode(CurMode);
                              }
              #endif
1465   2              }
1466   1      }
1467          
1468          #ifdef FUNC_BT_CHAN_AUTO
1469          BOOL DacMute_Save = TRUE;
1470          
1471          static VOID ChannelSwitchBT_and_Unmute()
1472          {
1473   1              InDacChannelSel(BLUETOOTH_CH_TYPE);
1474   1              SetBluetoothVolume(gSys.Volume);
1475   1              
1476   1              ChannelType = CHANNEL_TYPE_BT;
1477   1              InDacMuteDis();
1478   1              IsDacMute = FALSE;
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 25  

1479   1      }
1480          
1481          static VOID DacUnmute()
1482          {
1483   1              if(DacMute_Save)
1484   1                      return;
1485   1              InDacMuteDis();
1486   1              IsDacMute = FALSE;
1487   1      }
1488          
1489          static VOID ChannelSwitch_and_Unmute()
1490          {
1491   1      
1492   1              if(gSys.SystemMode == SYS_MODE_SD)
1493   1              {
1494   2                      //if(ChannelType == CHANNEL_TYPE_SD)
1495   2                      //      return;
1496   2                      //else if(ChannelType == CHANNEL_TYPE_BT)
1497   2                      {
1498   3                              InDacChannelSel(DAC_CH_DAC);
1499   3                              PlayVol2Decd();
1500   3                              ChannelType = CHANNEL_TYPE_SD;
1501   3                              DacUnmute();
1502   3                      }
1503   2              }
1504   1              else if(gSys.SystemMode == SYS_MODE_RADIO)
1505   1              {
1506   2                      //if(ChannelType == CHANNEL_TYPE_FM)
1507   2                      //      return;
1508   2                      //else if(ChannelType == CHANNEL_TYPE_BT)
1509   2                      {
1510   3                              InDacChannelSel(DAC_CH_ONCHIP_FM);
1511   3                              RadioSetVolume(gSys.Volume);
1512   3                              ChannelType = CHANNEL_TYPE_FM;
1513   3                              DacUnmute();
1514   3                      }
1515   2              }
1516   1      
1517   1              
1518   1      }
1519          
1520          #endif
1521          
1522          extern BOOL gBtCallIsHigh_Flag;
1523          // Device state control.
1524          VOID DevStateCtrl(VOID)
1525          {
1526   1              static MESSAGE Event;   //Îª½â¾öEventÖµ±»ÐÞ¸Äbug½«±äÁ¿ÉùÃ÷ÎªstaticÀàÐÍ. 
1527   1              BYTE TempMode = gSys.SystemMode;
1528   1      
1529   1              Event = MessageGet(MSG_FIFO_DEV_CTRL);   
1530   1      
1531   1      
1532   1      #ifdef FUNC_BT_CHAN_AUTO
1533   1              if(IsBtCallComing())
1534   1              {
1535   2                      if(gSys.SystemMode != SYS_MODE_BLUETOOTH)
1536   2                      {
1537   3                              if(IsDacMute)
1538   3                                      DacMute_Save = TRUE;
1539   3                              else
1540   3                                      DacMute_Save = FALSE;
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 26  

1541   3                              MuteOn(TRUE, TRUE);
1542   3                              ChannelSwitchBT_and_Unmute();
1543   3                      }
1544   2              }
1545   1      
1546   1               
1547   1              if(IsBtCallEnd())
1548   1              {
1549   2                      
1550   2                              ChannelSwitch_and_Unmute();
1551   2                      
1552   2              }
1553   1      #endif
1554   1      
1555   1              
1556   1      //      DBG(("DevStateCtrl\nevent:%bx\n", Event));
1557   1      //DBG1(("vol = %x\n",gSys.Volume));
1558   1      #if 0//def AU6210K_NR_D_8_CSRBT
              #if defined(FUNC_NPCA110X_EN) 
                      if(Event == MSG_DEFAULT)
                      {
                              DBG1(("msg_default\n"));
                              if(!isDealSetBass)
                              {                       
                                      isDealSetBass = TRUE;
                                      TimeOutSet(&SetBassTimer, 0);
              
                                      if(isDefaultBass)
                                      {
                                              isDefaultBass = FALSE;
                                      }
                                      else
                                      {
                                              isDefaultBass = TRUE;
                                      }
                              }
                      }
              
                      
                      if(IsTimeOut(&SetBassTimer) && isDealSetBass)
                      {
              
                              TimeOutSet(&SetBassTimer, SET_BASS_TIME);
                              if(isDefaultBass)
                              {
                                      NPCA110X_NormalBass(i,BassLed_CallBak);
                              }
                              else
                              {
                                      NPCA110X_SetBass(i,BassLed_CallBak);
                              }
                              i++;
                                              DBG1(("msg_default deal i = %x\n",i));
              
                      }
                      else
                      {
                              i = 0;
                      }
              #endif
              #endif
1602   1      
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 27  

1603   1      #ifdef FUNC_QUICK_RESPONSE_EN
                      IsSwitchMode = FALSE;
              #endif
1606   1      
1607   1      #ifdef FUNC_STANDBY_EN
                      //´ý»ú×´Ì¬ÏÂÖ»ÏìÓ¦´ý»úÍË³öÏûÏ¢
                      if(gSys.SystemMode == SYS_MODE_STANDBY)
                      {
                              if(Event == MSG_POWER)
                              {
                                      DBG(("EXIT STANDBY!\n"));
                                      InDacInit(FALSE);                       
                                      if(!TryGotoMode(gSystemExecState))
                                      {
                                              TryGotoValidMode(SYS_MODE_USB);
                                      }       
                                  #ifdef FUNC_POWER_AMPLIFIER_EN
                                     if(gSystemExecState != SYS_MODE_RADIO)
                                            ABPowerAmplifierOn();
                          #endif
                                      
                                      #ifdef FUNC_USB_VOLUP_EN
                                          if (Mode != SYS_MODE_USB)
                                         {
                                                USB_VOLUP_Off();
                                         }
                          #endif              
                                      
                              }
                              return;
                      }
              #endif
1635   1      
1636   1      #ifdef POWER_SAVING_MODE_OPTION
1637   1              //Èç¹ûÏµÍ³´øÓÐ¹Ø±Õ¹¦ÄÜ(POWERDOWN»òSLEEP)£¬ÊÕµ½ÏµÍ³¹Ø±ÕÏûÏ¢ºó£¬ÔòÖ´ÐÐÏµÍ³¹Ø±Õ²Ù×÷
1638   1              if((Event == MSG_SYS_OFF) || (Event == MSG_POWER))
1639   1              {       
1640   2      #ifdef FUNC_STANDBY_EN
                              TryGotoValidMode(SYS_MODE_STANDBY);
              #else
1643   2                      SystemOff();
1644   2      #endif
1645   2              }
1646   1      #endif
1647   1      
1648   1      #ifdef FUNC_BT_CHAN_AUTO
1649   1              IsBtCallComing();
1650   1      #endif
1651   1      
1652   1      
1653   1      #ifdef FUNC_USB_EN
                      //ºó²åÏÈ²¥¼ì²â
                      //DBG(("gIsUsbReconnect%bx\n",gIsUsbReconnect));
                      if(IsUsbInsert() || ((gIsUsbRemove == TRUE) && (IsUSBLink())))                  //ÓÐUÅÌÐÂ²åÈë
                      {               
                              IsUsbLinkFlag = TRUE;   //usb ¿ìËÙ²å°Î¹ý³ÌÖÐÒ»¸öÂß¼­Â©¶´
                              if((gFsInfo.DevID == DEV_ID_OTP) && (gSys.SystemMode == SYS_MODE_OTPDEV))
                              {
                                      gPlayCtrl.State = PLAY_STATE_STOP;
                              }                               
                              DBG(("IsUsbInsert()\n"));
                              if((gIsUsbRemove == TRUE) && IsUSBLink())
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 28  

                              {
                                      DBG(("**Ins**\n"));
                              }
              #ifdef  FUNC_USB_CHARGE_EN
                              AppleDeviceFlag = FALSE;    
              #endif
                              gIsUsbRemove = FALSE;
                              if(!TryGotoMode(SYS_MODE_USB))
                              {
                                      TryGotoValidMode(TempMode);
                              }                       
                      }
              #endif
1678   1              //DBG1(("IsDacMute = %x\n",IsDacMute));
1679   1      
1680   1      #ifdef FUNC_CARD_EN
1681   1              //ÓÐ¿¨ÐÂ²åÈë£¬²¢ÇÒµ±Ç°²»ÊÇ´¦ÓÚ¶Á¿¨Æ÷»òÒ»ÏßÍ¨Ä£Ê½£¬Ôò×öºó²åÏÈ²¥´¦Àí
1682   1              if(IsCardInsert()               
1683   1              && (gSys.SystemMode != SYS_MODE_READER)
1684   1              && (gSys.SystemMode != SYS_MODE_AUDIO_READER))          
1685   1              {       
1686   2                      if((gFsInfo.DevID == DEV_ID_OTP) && (gSys.SystemMode == SYS_MODE_OTPDEV))
1687   2                      {
1688   3                              gPlayCtrl.State = PLAY_STATE_STOP;
1689   3                      }                               
1690   2                      DBG(("IsCardInsert()\n"));
1691   2                      MuteOn(TRUE,TRUE);
1692   2                      WaitMs(150);//½â¾öinit sd card errorÎÊÌâ
1693   2                      TryGotoValidModeReturn(SYS_MODE_SD);
1694   2              }
1695   1      #endif
1696   1      
1697   1      #ifdef FUNC_LINEIN_EN
                      if(IsLineInInsert())    //ÓÐline-inÐÂ²åÈë
                      {
                              DBG(("IsLineInInsert()\n"));
                              TryGotoValidModeReturn(SYS_MODE_LINEIN);
                      }
              #endif
1704   1      
1705   1      #if ((defined FUNC_AUDIO_EN) || (defined FUNC_READER_EN) || (defined FUNC_AUDIO_READER_EN))
                      if(IsPcInsert())                //ÓÐPCÐÂ²åÈë
                      {
                              DBG(("IsPcInsert()\n"));
              
              #if (defined FUNC_AUDIO_EN)
                              TryGotoValidModeReturn(SYS_MODE_AUDIO);
              #elif (defined FUNC_READER_EN)
                              TryGotoValidModeReturn(SYS_MODE_READER);
              #elif (defined FUNC_AUDIO_READER_EN)
                              TryGotoValidModeReturn(SYS_MODE_AUDIO_READER);
              #endif
                      }
              #endif
1719   1      
1720   1      #ifdef  FUNC_DEVICE_FORCEPAUSE_EN
                      if(IsChargerInsert())   //ÓÐPC»ò³äµçÆ÷ÐÂ²åÈë
                      {
                              gDevicePlayForcePauseFlag = TRUE;
              #ifdef  FUNC_RADIO_EN
                              if((gSys.SystemMode == SYS_MODE_RADIO) && (gRadioCtrl.State != RADIO_IDLE))
                              {
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 29  

                                      gRadioCtrl.State = RADIO_IDLE;  
                              }
              #endif
                              MuteOn(TRUE, TRUE);
                      }
                      else if(gDevicePlayForcePauseFlag == TRUE)
                      {
                              if(!IsInCharge())
                              {
                                      gDevicePlayForcePauseFlag = FALSE;
                                      if((gSys.SystemMode == SYS_MODE_SD) || (gSys.SystemMode == SYS_MODE_USB)) 
                                      {
                                              MessageSend(MSG_FIFO_KEY, MSG_PLAY_PAUSE);
                                      }       
              #ifdef  FUNC_RADIO_EN
                                      else if(gSys.SystemMode == SYS_MODE_RADIO)
                                      {
                                              UnMute();
                                      }
              #endif
                              }
                      }
              #endif
1750   1      
1751   1      #ifdef  FUNC_HEADPHONE_DETECT_EN
                      if(IsTimeOut(&sHeadPhoneCheckTimer))
                      {               
              #ifdef FUNC_HEADPHONE_ADC_DETECT_EN             
                              TimeOutSet(&sHeadPhoneCheckTimer, 0);
                              if(IsHeadphoneLinkFlag == TRUE)
              #else           
                              TimeOutSet(&sHeadPhoneCheckTimer, 100);
                              if(IsHeadPhonInsert())  //ÓÐ¶ú»ú²åÈë
              #endif
                              {
              #ifdef FUNC_EXMUTE_EN
                                      ExMuteOn();     
              #endif                  
                                      //DBG(("HeadPhone insert\n"));
                              }
                              else if((IsHeadphoneLinkFlag == FALSE) && (IsDacMute == FALSE))
                              {
              #ifdef FUNC_EXMUTE_EN
                                      ExMuteOff();
              #endif                  
                                      //DBG(("HeadPhone no insert\n"));
                              }
                      }
              #endif
1776   1      
1777   1              //Éè±¸°Î³ý¼ì²â
1778   1              //cunrrent device is removed.
1779   1              switch(gSys.SystemMode)
1780   1              {
1781   2      #ifdef FUNC_USB_EN
                              case SYS_MODE_USB:                      //current system mode is USB            
                                      if(gDeviceError)                //usb error
                                      {
                                              DBG(("gDeviceError\n"));
                                              gDeviceError = 0;
                                              //Èç¹ûUSB¿¨³öÏÖ´íÎó£¬ÔòÕâÀï»á³¢ÊÔÖØÐÂ½øÈëUSBÄ£Ê½
                                              if(!TryGotoModeUSB())
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 30  

                                              {
              #if 0
                                                      if (!TryGotoModeSD())
                                                      {
                                                              TryGotoValidMode(SYS_MODE_LINEIN);
                                                      }
              #else
                                                      TryGotoValidMode(SYS_MODE_SD);
              #endif
                                              }
                                      }
                                      else if(!IsUSBLink())           //usb removed
                                      {
                                              DBG(("usb removed!\n"));
              #ifdef FUNC_USB_CHARGE_EN                       
                                              AppleDeviceFlag = FALSE;
              #endif
              
              #if 0
                                              if (!TryGotoModeSD())
                                              {
                                                      TryGotoValidMode(SYS_MODE_LINEIN);
                                              }
              #else
                                              TryGotoValidMode(SYS_MODE_SD);
              #endif
                                      }       
                                      break;
              #endif
1818   2      
1819   2      #ifdef FUNC_CARD_EN
1820   2                      case SYS_MODE_SD:                       //current system mode is SD
1821   2                              if(gDeviceError)                //sd-card error
1822   2                              {
1823   3                                      DBG(("gDeviceError\n"));
1824   3                                      //Èç¹ûSD¿¨³öÏÖ´íÎó£¬ÔòÕâÀï»á³¢ÊÔÖØÐÂ½øÈëSDÄ£Ê½
1825   3                                      if(!TryGotoModeSD())
1826   3                                      {
1827   4      #if defined(AU6210K_JLH_JH82B) || defined(AU6210K_NR_D_8_CSRBT)
                                                      if (!TryGotoModeLINEIN())
                                                      {
                                                              TryGotoValidMode(SYS_MODE_BLUETOOTH);
                                                      }
              #elif defined(AU6210K_HXX_B002)
                                                      TryGotoValidMode(SYS_MODE_BLUETOOTH);
              #else
1835   4                                              TryGotoValidMode(SYS_MODE_USB);
1836   4      #endif
1837   4                                      }
1838   3                              }
1839   2                              else if(!IsCardLink())          //sd-card removed
1840   2                              {
1841   3                                      DBG(("card removed!\n"));
1842   3      #if defined(AU6210K_JLH_JH82B) || defined(AU6210K_NR_D_8_CSRBT)
                                              if (!TryGotoModeLINEIN())
                                              {
                                                      TryGotoValidMode(SYS_MODE_BLUETOOTH);
                                              }
              #elif defined(AU6210K_HXX_B002)
                                              TryGotoValidMode(SYS_MODE_BLUETOOTH);
              #else
1850   3                                      TryGotoValidMode(SYS_MODE_USB);
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 31  

1851   3      #endif
1852   3                              }
1853   2                              break;
1854   2      #endif
1855   2      
1856   2      #ifdef FUNC_LINEIN_EN
                              case SYS_MODE_LINEIN:           //current system mode is LINEIN
                                      if(!IsLineInLink())             //line-in removed
                                      {
                                              DBG(("line-in removed!\n"));
                                              TryGotoValidMode(SYS_MODE_BLUETOOTH);
                                      }
                                      break;
              #endif
1865   2      
1866   2      #if (defined(FUNC_AUDIO_EN) || defined(FUNC_READER_EN) || defined(FUNC_AUDIO_READER_EN))
                              case SYS_MODE_AUDIO:            //current system mode is AUDIO
                              case SYS_MODE_READER:           //current system mode is READER
                              case SYS_MODE_AUDIO_READER:     //current system mode is AUDIO_READER
                                      //DBG(("DevStateCtrl->SYS_MODE_AUDIO\n"));
                                      if(!IsPcLink())                 //pc removed
                                      {
                                              DBG(("pc removed 0!\n"));
                                              WaitMs(400);
                                              if(IsPcInsert())
                                              {
                                                      DBG(("pc !rem"));
                                                      break;
                                              }
                                              DBG(("pc removed!\n"));
              #ifdef AU6210K_ZB_BT007_CSR
                                              TryGotoValidMode(SYS_MODE_SD);
              #else
                                              TryGotoValidMode(SYS_MODE_USB);
              #endif
                                      }
                                      break;
              #endif
1889   2      
1890   2      #ifdef  FUNC_RADIO_EN
1891   2                      case SYS_MODE_RADIO:
1892   2                              break;
1893   2      #endif
1894   2      
1895   2                      case SYS_MODE_NONE: 
1896   2      #ifdef FUN_SYSTEM_POWEROFF_WAIT_TIME
                                      SystemOffTimeMsgPro(Event);
              #endif  
1899   2                              break;
1900   2      
1901   2                      default:
1902   2                              break;
1903   2              }
1904   1      
1905   1              //°´¼üÇÐ»»¼ì²â
1906   1              
1907   1              if((Event == MSG_MODE_SW) 
1908   1      #ifdef FUNC_QUICK_RESPONSE_EN
                      || IsSwitchMode
              #endif  
1911   1              )
1912   1              {
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 32  

1913   2                      DBG(("DevStateCtrl,MODE\n"));
1914   2                      if((gFsInfo.DevID == DEV_ID_OTP) && (gSys.SystemMode == SYS_MODE_OTPDEV))
1915   2                      {
1916   3                              gPlayCtrl.State = PLAY_STATE_STOP;
1917   3                      }
1918   2                      
1919   2      #ifdef  FUNC_DEVICE_FORCEPAUSE_EN
                              gDevicePlayForcePauseFlag = FALSE;
              #endif
1922   2      
1923   2      #ifdef FUNC_BEEP_SOUND_EN       
                              PushKeyBeep(1);
              #endif          
1926   2      
1927   2      #ifndef FUNC_QUICK_RESPONSE_EN
1928   2                      TryGotoNextMode(gSys.SystemMode);
1929   2      #else
                              IsSwitchMode = TRUE;
                              while(IsSwitchMode)
                              {
                                      IsSwitchMode = FALSE;
                                      DBG(("CurMode: %d\n", (WORD)CurMode));
                                      TryGotoNextMode(CurMode);
                              }
              #endif
1938   2              } 
1939   1              
1940   1      #if defined(AU6210K_DEMO)
              #ifdef FUNC_USB_EN
                      if((Event == MSG_MODE_USB) && (gSys.SystemMode != SYS_MODE_USB))
                      {
                              if(IsUsbLinkFlag == TRUE)
                              {
                                      //DBG(("DevStateCtrl,USB MODE\n"));
                                      TryGotoValidModeReturn(SYS_MODE_USB);
                              }
                              else
                              {
                                      //DBG(("DevStateCtrl,NO USB\n"));
                              }
                      }
              #endif
              
              #ifdef FUNC_CARD_EN
                      if((Event == MSG_MODE_SD) && (gSys.SystemMode != SYS_MODE_SD))
                      {
                              if(IsCardLinkFlag == TRUE)
                              {
                                      //DBG(("DevStateCtrl,SD MODE\n"));
                                      TryGotoValidModeReturn(SYS_MODE_SD);
                              }
                              else
                              {
                                      //DBG(("DevStateCtrl,NO CARD\n"));
                              }
                      }       
              #endif
              
              #ifdef FUNC_RADIO_EN
                      if((Event == MSG_MODE_FM) && (gSys.SystemMode != SYS_MODE_RADIO))
                      {
                              if(Radio_Name != RADIO_NONE)
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 33  

                              {
                                      //DBG(("DevStateCtrl,FM MODE\n"));
                                      TryGotoValidModeReturn(SYS_MODE_RADIO);
                              }
                              else
                              {
                                      //DBG(("DevStateCtrl, NO FM or FM Error\n"));
                              }
                      }
              #endif
              
              #ifdef FUNC_LINEIN_EN
                      if((Event == MSG_MODE_AUX) && (gSys.SystemMode != SYS_MODE_LINEIN)) 
                      {
                              if(IsLineInLink())
                              {
                                      //DBG(("DevStateCtrl,AUX MODE\n"));
                                      TryGotoValidModeReturn(SYS_MODE_LINEIN);
                              }
                              else
                              {
                                      //DBG(("DevStateCtrl, NO AUX\n"));
                              }
                      }       
              #endif
              #endif
2001   1      
2002   1      #ifdef FUNC_SNOOZE_EN
                      //SNOOZE °´¼ü¼ì²â
                      if((sAlarmPowerOnFlag == TRUE) && (Event == MSG_SNOOZE))
                      {
                              TryGotoValidMode(SYS_MODE_STANDBY);
                              sSnoozeOnFlag = TRUE;
                      }
              #endif
2010   1      }
2011          
2012          
2013          #ifdef FUNC_STANDBY_EN
              VOID StandbyStateCtrl(VOID)
              {       
              #ifdef AU6210K_BOOMBOX_DEMO
              #ifdef FUNC_ALARM_EN
                      if(gAlarm1OnFlag == TRUE)
                      {
                              gAlarm1OnFlag = FALSE;
                              sAlarmPowerOnFlag = TRUE;
                              gSys.Volume = gAlarm1Volume;
                              gSys.SystemMode = gAlarm1Source;
                              InDacInit(FALSE);
                              TryGotoValidMode(gSys.SystemMode);               
                      }
                      else if(gAlarm2OnFlag == TRUE)
                      {
                              gAlarm2OnFlag = FALSE;
                              sAlarmPowerOnFlag = TRUE;
                              gSys.Volume = gAlarm2Volume;
                              gSys.SystemMode = gAlarm2Source;
                              InDacInit(FALSE);
                              TryGotoValidMode(gSys.SystemMode);
                      }       
              #endif
C51 COMPILER V9.00   DEVCTRL                                                               12/25/2015 17:22:44 PAGE 34  

              #endif
              
              #ifdef FUNC_SNOOZE_EN
                      if((sSnoozeOnFlag == TRUE) && (IsTimeOut(&sSnoozeTimer)))
                      {
                              sSnoozeOnFlag = FALSE;
                              TryGotoValidMode(gSystemExecState);
                      }
              #endif
              }
              #endif
2048          
2049          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1085    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     19       7
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
