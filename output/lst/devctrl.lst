C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE DEVCTRL
OBJECT MODULE PLACED IN .\output\obj\devctrl.obj
COMPILER INVOKED BY: d:\Keil\C51\BIN\C51.EXE device\devctrl.c LARGE OBJECTADVANCED OPTIMIZE(9,SIZE) BROWSE INCDIR(.\conf
                    -ig;.\device;.\display;.\fs;.\key;.\lib_if;.\play;.\system;.\library;.\power;.\radio;.\eeprom;.\spi_flash;.\slave;.\bluet
                    -ooth;.\i2c) DEBUG PRINT(.\output\lst\devctrl.lst) OBJECT(.\output\obj\devctrl.obj)

line level    source

   1          #include "syscfg.h"
   2          #include "sysctrl.h"
   3          #include "device_audio.h"
   4          #include "usb_audio_ctrl.h"
   5          #include "card_reader_ctrl.h"
   6          #include "playctrl.h"
   7          #include "device.h"
   8          #include "rtc_ctrl.h"
   9          #include "breakpoint.h"
  10          #include "linein_ctrl.h"
  11          #include "sleep.h"
  12          #include "radio_app_interface.h"
  13          #include "user_interface.h"
  14          #include "debug.h"
  15          #include "sys_on_off.h"
  16          #include "radio_ctrl.h"
  17          #include "display.h"
  18          #include "key.h"
  19          #include "spi_fs.h"
  20          #include "otp_play.h"
  21          #include "touch_key.h"
  22          #include "pt231x.h"
  23          #include "bluetooth_ctrl.h"
  24          #include "slave_ctrl.h"
  25          #include "bt.h"
  26          #include "npca110x.h"
  27          
  28          #ifdef FUNC_QUICK_RESPONSE_EN 
              BOOL IsSwitchMode;
              BYTE CurMode;
              #endif
  32          #ifdef FUNC_NPCA110X_EN
              extern BOOL isDefaultBass;
              #endif
  35          
  36          BOOL isDealSetBass = FALSE;
  37          static  USHORT i = 0;
  38          
  39          #ifdef   FUNC_USB_CHARGE_EN
              //µ±Ç°ÏµÍ³ÖÐÊÇ·ñÁ¬½ÓÁËAppleÉè±¸±êÖ¾
              BOOL     AppleDeviceFlag = FALSE;       
              //gMassStorInvalidVid = 0x05ACÊ±£¬°ÑIpodÉè±¸×÷Îª³äµçÉè±¸
              WORD     gMassStorInvalidVid = 0x05AC;
              #endif
  45          
  46          //#define FUNC_PAUSE_DURING_DEVTRY      //Éè±¸³¢ÊÔÇÐ»»Ê±Í£Ö¹²¥·Å£¬ÏÔÊ¾LOD.
  47          
  48          extern BOOL gDeviceError;
  49          extern SYS_MODE gSysMode;       // define in library.
  50          extern BOOL IsCardLinkFlag; //for audio
  51          extern BOOL gIsUsbRemove;//for usb Reconnect in mode switch 
  52          extern BOOL IsUsbLinkFlag; 
  53          
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 2   

  54          #define PLAY_WATCH_TIME                         10000
  55          extern VOID SongPlayTimePause(VOID);
  56          extern VOID SongPlayTimeResume(VOID);
  57          extern TIMER gPlayWatchTimer;
  58          //extern TIMER VolumeUpTimer;
  59          extern TIMER CardDctTimer;
  60          extern VOID BassLed_CallBak(VOID);
  61          #define SET_BASS_TIME   1       
  62          TIMER SetBassTimer;
  63          
  64          //#ifdef FUNC_USB_MSC_SN_EN
  65          //BYTE gUDiskSN[MAX_USB_SN_LEN];
  66          //#endif
  67          
  68          #ifdef  FUNC_DEVICE_FORCEPAUSE_EN
              BOOL gDevicePlayForcePauseFlag = FALSE; //Ç¿ÖÆÔÝÍ£Éè±¸²¥·Å×´Ì¬
              #endif
  71          
  72          #ifdef  FUNC_HEADPHONE_DETECT_EN
              static TIMER sHeadPhoneCheckTimer;
              #endif
  75          
  76          #ifdef FUNC_POWER_ON_AUDIO_EN
              BOOL gUSBChargePowerOnFlag = TRUE;      //¹Ø»ú×´Ì¬ÏÂUSB³äµçÆ÷²åÉÏÏµÍ³¿ª»ú±êÖ¾
              #endif
  79          
  80          #ifdef FUNC_STANDBY_EN
              SYS_MODE gSystemExecState;
              #endif
  83          
  84          #ifdef FUNC_SNOOZE_EN
              #define SNOOZE_TIME             300000  // 5mins
              
              static TIMER sSnoozeTimer;
              static BOOL sSnoozeOnFlag = FALSE;
              static BOOL sAlarmPowerOnFlag = FALSE;
              #endif
  91          
  92          #ifdef FUNC_BEEP_SOUND_EN       
              extern  TIMER gPushKeyBeepTimer;
              #endif
  95          
  96          
  97          ////////////////////////////////////////////////////
  98          ///////////////////////////////////////////////////
  99          //Ç¿ÖÆ½øÈëÄ³ÖÖÄ£Ê½
 100          //²¢×öÔ­Ä£Ê½ÍË³öÊ±µÄÉÆºó´¦Àí¹¤×÷
 101          static VOID GotoMode(BYTE Mode)
 102          {
 103   1      #ifdef FUNC_TOUCH_KEY_EN
                      TouchKeyScanInit();
              #endif
 106   1      
 107   1              switch(gSys.SystemMode)         //Ô­Ä£Ê½
 108   1              {
 109   2      #ifdef FUNC_USB_EN
                              case SYS_MODE_USB:              //Àë¿ªUSBÄ£Ê½
                                      //Í£Ö¹²¥·Å
                                      PlayCtrlEnd();
                                      break;
              #endif
 115   2      
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 3   

 116   2      #ifdef FUNC_CARD_EN
                              case SYS_MODE_SD:               //Àë¿ªSDÄ£Ê½
                                      //Í£Ö¹²¥·Å
                                      PlayCtrlEnd();
                                      break;
              #endif
 122   2      
 123   2      #ifdef FUNC_SPI_PLAY_EN
                              case SYS_MODE_SPIDEV:           //Àë¿ªSPIÄ£Ê½
                                      //Í£Ö¹²¥·Å
                                      PlayCtrlEnd();
                                      break;
              #endif
 129   2      
 130   2      #ifdef FUNC_RADIO_EN
 131   2                      case SYS_MODE_RADIO:            //Àë¿ªRADIOÄ£Ê½
 132   2                              if(Mode == SYS_MODE_RADIO)
 133   2                              {
 134   3                                      break;
 135   3                              }       
 136   2                              RadioCtrlDeinit();                              
 137   2      //#if (FM_IO_TYPE == DAC_OUT_LR)
 138   2      //                      DBG(("LeaveRad,DacInit\n"));
 139   2      //                      InDacInit(FALSE);
 140   2      //#endif
 141   2                              SysClkDivClr(); 
 142   2                              InDacSetVmid(FALSE);
 143   2                              break;
 144   2      #endif
 145   2      
 146   2      #ifdef FUNC_LINEIN_EN
 147   2                      case SYS_MODE_LINEIN:   //Àë¿ªline-inÄ£Ê½
 148   2                              if(Mode == SYS_MODE_LINEIN)
 149   2                              {
 150   3                                      break;
 151   3                              }
 152   2                              LineinIODeinit();
 153   2                              //SysClkDivClr();       
 154   2                              break;
 155   2      #endif
 156   2      #ifdef FUNC_BLUETOOTH_CSR_EN
 157   2                      case SYS_MODE_BLUETOOTH:        
 158   2                              if(Mode == SYS_MODE_BLUETOOTH)
 159   2                              {
 160   3                                      break;
 161   3                              }
 162   2                              BluetothCtrlEnd();
 163   2                              //SysClkDivClr();       
 164   2                              break;
 165   2      #endif
 166   2      #if 0//def FUNC_BLUETOOTH_EN
                              case SYS_MODE_BLUETOOTH:
                                      if (Mode == SYS_MODE_BLUETOOTH)
                                      {
                                              break;
                                      }
                                      BluetothCtrlEnd();
                                      //SysClkDivClr();
                                      break;
              #endif
 176   2      
 177   2                      case SYS_MODE_SLEEP:    //Àë¿ªSLEEPÄ£Ê½
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 4   

 178   2                              
 179   2                              break;
 180   2      
 181   2      #ifdef FUNC_RTC_EN
                              case SYS_MODE_RTC:              //Àë¿ªRTCÄ£Ê½
              
              #ifdef FUNC_POWER_AMPLIFIER_EN
                                      if (Mode == SYS_MODE_RTC)
                                      {
                                              break;
                                      }
                                      if (Mode != SYS_MODE_RADIO)
                                      {
                                              ABPowerAmplifierOn();
                                      }
              #endif  
              
              #ifdef FUNC_USB_VOLUP_EN
                                      if (Mode == SYS_MODE_RTC)
                                      {
                                              break;
                                      }
                                      if (Mode != SYS_MODE_USB)
                                      {
                                              USB_VOLUP_Off();
                                      }
              #endif          
                                      break;
              #endif
 207   2                              
 208   2      #if (defined(FUNC_AUDIO_EN) || defined(FUNC_READER_EN) || defined(FUNC_AUDIO_READER_EN))
                              case SYS_MODE_AUDIO:    //Àë¿ªUSBÉù¿¨Ä£Ê½
                              case SYS_MODE_READER:           //Àë¿ªUSB¶Á¿¨Æ÷Ä£Ê½
                              case SYS_MODE_AUDIO_READER:     //Àë¿ªUSBÒ»ÏßÍ¨Ä£Ê½
                                      DeviceAudioCtrlEnd();
                                      DeviceStorCtrlEnd();
                                      break;
              #endif
 216   2      
 217   2                      default:
 218   2                              break;
 219   2              }
 220   1              
 221   1      #ifdef FUNC_STANDBY_EN
                      if(Mode != SYS_MODE_STANDBY)
                      {
                              gSystemExecState = Mode;
                      }
              #endif
 227   1      
 228   1              gSys.SystemMode = Mode;
 229   1              gSysMode = Mode;                //¶¨ÒåÔÚµ×²ã£¬ÎªÁË±ÜÃâµ×²ãÖ±½ÓÒýÓÃgSys.SystemModeÔö¼Ó(·ÀÖ¹Ó¦ÓÃ²ã´úÂëÐÞ¸ÄgSys½á¹¹ÌåÓ°Ïìµ
             -½µ×²ã)¡£
 230   1              MuteOn(TRUE, TRUE);     //¹Ø±ÕDAC¡¢LineIn¡¢FMInÍ¨µÀÊä³ö¡£
 231   1              gSys.MuteFg = FALSE;
 232   1              
 233   1              MessageInit();
 234   1      
 235   1      #ifdef FUN_SYSTEM_POWEROFF_WAIT_TIME
                      TimeOutSet(&gSysTimeOffState.DisTimer, 0);      
              #endif
 238   1      
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 5   

 239   1      #ifdef FUNC_DISP_EN
 240   1              DispMute();     //ÕýÈ·»Ö¸´MuteÏÔÊ¾×´Ì¬¡£±ÜÃâ´ÓMute×´Ì¬ÏÂÇÐ»»Éè±¸Ôì³ÉµÄÏÔÊ¾´íÎó¡£
 241   1              DispDev();
 242   1      #endif
 243   1      }  
 244          
 245          
 246          #ifdef FUNC_STANDBY_EN
              //³¢ÊÔÇÐ»»µ½StandbyÄ£Ê½
              static BOOL TryGotoModeStandby(VOID)
              {       
                      DBG(("TryGotoModeStandby()\n"));
              
                      ModuleClkEn(MASK_ALL_CLOCK);
                      SysClkDivClr(); 
                      
                      GotoMode(SYS_MODE_STANDBY);     
                      
                      InDacChannelSel(DAC_CH_NONE);   
                      InDacPowerDown(FALSE);  
              
              #ifdef FUNC_POWER_AMPLIFIER_EN
                      ABPowerAmplifierOff();
              #endif
              
              #ifdef FUNC_SNOOZE_EN
                      sAlarmPowerOnFlag = FALSE;
              #endif
              
                      return TRUE;
              }
              #endif
 271          
 272          
 273          //³¢ÊÔÇÐ»»µ½IDLEÄ£Ê½
 274          static BOOL TryGotoModeIdle(VOID)
 275          {
 276   1              DBG(("TryGotoModeIdle()\n"));
 277   1              GotoMode(SYS_MODE_NONE);
 278   1      
 279   1              InDacChannelSel(DAC_CH_NONE);
 280   1      
 281   1      #ifdef FUNC_POWER_AMPLIFIER_EN
 282   1              ABPowerAmplifierOff();
 283   1      #endif
 284   1      
 285   1              return TRUE;
 286   1      }
 287          
 288          
 289          #ifdef FUNC_CARD_EN
              //³¢ÊÔÇÐ»»µ½SD¿¨Ä£Ê½
              static BOOL TryGotoModeSD(VOID)
              {
                      BOOL TempFlag = FALSE;
                              
                      DBG1(("TryGotoModeSD()\n"));
                      
              #ifdef FUNC_POWER_ON_AUDIO_EN
                      if(gUSBChargePowerOnFlag == TRUE)
                      {
                              return FALSE;
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 6   

                      }
              #endif
                      
                      if(IsCardLinkFlag == TRUE)
                      {
                              MuteOn(TRUE, TRUE); //½â¾öSD»òUSBÖ®¼äÖ±½ÓÇÐ»»»áÍ£Ò»ÏÂÔÙ³öÖ®Ç°Éè±¸¸èÇúÉùÒôÎÊÌâ
                              TempFlag = TRUE;
                      }
              
                      //µÈ´ýSD¿¨»òUÅÌÉè±¸Á¬½Ó
                      if(!IsCardLink())
                      {
                              
                              DBG1(("IsCardLink() FALSE!\n"));
                              IsCardLinkFlag = FALSE;
                              return FALSE;
                      }
                      DBG1(("IsCardLink() OK!\n"));
              
                      
              
                      ModuleClkEn(MASK_ALL_CLOCK);
                      SysClkDivClr(); 
              
                      gPlayCtrl.State = PLAY_STATE_STOP;
                      
              #ifdef FUNC_DISP_EN
                      DispLoad();
              #endif
                      if(TempFlag == FALSE)
                      {
                              MuteOn(TRUE, TRUE); //½â¾öSD»òUSBÖ®¼äÖ±½ÓÇÐ»»»áÍ£Ò»ÏÂÔÙ³öÖ®Ç°Éè±¸¸èÇúÉùÒôÎÊÌâ
                      }
              
                      //WaitMs(50);
              
              //      if(!CardInit()) 
                      {
                              //WaitMs(50);
                              if(!CardInit()) 
                              {
                                      DBG1(("CardInit() error!\n"));
                                      return FALSE;
                              }
                              
                      }
                      DBG1(("Card OK!\n"));
              
                      GotoMode(SYS_MODE_SD);
              #ifdef AU6210K_NR_D_8_CSRBT
                      NPCA110X_ADC_Input_CH_Select(INPUT_CH2);
              #endif
                      InDacChannelSel(DAC_CH_DAC);
                      
              #ifdef FUNC_SPI_KEY_SOUND_EN    
                      SPI_PlaySelectNum(SPIPLAY_SONG_PLAY_TF, 0);
              #endif
                      
                      DBG1(("FSInit(DEV_ID_SD)\n"));
                      if(!FSInit(DEV_ID_SD))
                      {
                              DBG1(("FSInit() error!\n"));
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 7   

                              return FALSE;
                      }
              
                      DBG1(("*******SD MODE********\n"));
                      PlayCtrlInit();  
              #ifdef FUNC_TOUCH_KEY_EN
                      TR1 = 1;
              #endif
                      return TRUE;
              }
              #endif
 374          
 375          
 376          #ifdef FUNC_USB_EN
              //³¢ÊÔÇÐ»»µ½USBÄ£Ê½
              static BOOL TryGotoModeUSB(VOID)
              {       
                      BOOL TempFlag = FALSE;
                      
                      DBG(("TryGotoModeUSB()\n"));
                      
              #ifdef FUNC_POWER_ON_AUDIO_EN
                      if(gUSBChargePowerOnFlag == TRUE)
                      {
                              return FALSE;
                      }
              #endif  
                      
                      if(IsUsbLinkFlag == TRUE)
                      {
                              MuteOn(TRUE, TRUE); //½â¾öSD»òUSBÖ®¼äÖ±½ÓÇÐ»»»áÍ£Ò»ÏÂÔÙ³öÖ®Ç°Éè±¸¸èÇúÉùÒôÎÊÌâ
                              TempFlag = TRUE;
                      }
                      
                      //UÅÌµçÆøÁ¬½Ó¼ì²é
                      if(!IsUSBLink())
                      {
                              DBG(("IsUSBLink() FALSE!\n"));
                              return FALSE;
                      }
                      DBG(("IsUSBLink() OK!\n"));
              
                      if(TempFlag == FALSE)
                      {
                              MuteOn(TRUE, TRUE); //½â¾öSD»òUSBÖ®¼äÖ±½ÓÇÐ»»»áÍ£Ò»ÏÂÔÙ³öÖ®Ç°Éè±¸¸èÇúÉùÒôÎÊÌâ
                      }       
                      
                      ModuleClkEn(MASK_ALL_CLOCK);    
                      SysClkDivClr(); 
              
              #ifdef  FUNC_USB_CHARGE_EN
                      //·ÀÖ¹TryGotoModeUSB()º¯Êý±»¶à´Îµ÷ÓÃÊ±£¬µ¼ÖÂAppleDevice¶à´ÎÌáÊ¾³äµç
                      if(AppleDeviceFlag)
                      {
                              return FALSE;
                      }
              #endif
              
              #ifdef FUNC_DISP_EN
                      DispLoad();
              #endif
              
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 8   

              //      DBG(("IsUSBLink() OK!\n"));
                      if(!HostStorInit())     
                      {
                              DBG(("HostStorInit() error!\n"));
              #ifdef  FUNC_USB_CHARGE_EN
                              //if(IsInvalidUsbDevice())
                              if(gLibUsbInfo.VID == 0x05AC)
                              {
                                      extern BYTE UsbSetConfiguration(BYTE configuration);
                                      AppleDeviceFlag = TRUE;                                                 
                                      UsbSetConfiguration(1);
                                      DBG(("USB³äµç¿ªÊ¼!\n"));
                              }
              #endif
                              return FALSE;
                      }
                      DBG(("USB OK!\n"));
              
                      GotoMode(SYS_MODE_USB);
                      InDacChannelSel(DAC_CH_DAC);
                      
              #if 0//def FUNC_SPI_KEY_SOUND_EN        
                      SPI_PlaySelectNum(SPIPLAY_SONG_HAVE_CALL, 0);
              #endif
              
                      DBG(("FSInit(DEV_ID_USB)\n"));
                      if(!FSInit(DEV_ID_USB))
                      {
                              DBG(("FSInit() error!\n"));
                              return FALSE;
                      }
              
                      DBG(("*******USB MODE********\n"));
                      PlayCtrlInit();
                      
              #ifdef FUNC_TOUCH_KEY_EN
                      TR1 = 1;
              #endif
                      return TRUE;
              }
              #endif
 466          
 467          
 468          #ifdef FUNC_RADIO_EN
 469          //³¢ÊÔÇÐ»»µ½RADIOÄ£Ê½
 470          static BOOL TryGotoModeRADIO(VOID)
 471          {               
 472   1              DBG(("TryGotoModeRADIO()\n"));
 473   1      
 474   1      #ifdef FUNC_POWER_ON_AUDIO_EN
                      if(gUSBChargePowerOnFlag == TRUE)
                      {
                              return FALSE;
                      }
              #endif
 480   1      
 481   1              //UÅÌµçÆøÁ¬½Ó¼ì²é  
 482   1              if(!IsRadioLink())
 483   1              {
 484   2                      DBG(("IsRadioLink() FALSE!\n"));
 485   2                      return FALSE;
 486   2              }
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 9   

 487   1              DBG(("IsRadioLink() OK!\n"));
 488   1              
 489   1              GotoMode(SYS_MODE_RADIO);
 490   1              
 491   1      #ifdef FUNC_SPI_KEY_SOUND_EN    
 492   1              SPI_PlaySelectNum(SPIPLAY_SONG_PLAY_FM, 0);
 493   1      #endif
 494   1       
 495   1              RadioPowerOn();
 496   1              InDacSetVmid(TRUE);
 497   1      
 498   1              //FM set
 499   1      #ifdef FM_DAC_OUT_D3D4
                      //Èç¹ûÒªÈÃFMÒôÆµ´ÓD3¡¢D4¿ÚÊä³ö£¬ÔòÐèÒª×öÈçÏÂÅäÖÃ        
                      SetGpioRegBit(GPIO_FMD_OE, 0x04);
                      ClrGpioRegBit(GPIO_FMD_IE, 0x04);
                      SetGpioRegBit(GPIO_FMD_OUT, 0x04);
              
                      ClrGpioRegBit(GPIO_D_PU, 0x18);
                      SetGpioRegBit(GPIO_D_PD, 0x18);
                      SetGpioRegBit(GPIO_FMA_EN, 0x03);       //Æ¬ÄÚFMÄ£¿éµÄÒôÆµÐÅºÅÁ¬½Óµ½D3¡¢D4
              
                      //ÔÙÑ¡ÔñÒôÆµÐÅºÅÊäÈëµ½Ð¾Æ¬ÄÚ²¿£¬È»ºó´Ó DACÊä³ö·½Ê½
                      //´ÓLine inÍ¨µÀÊäÈëµ½Ð¾Æ¬ÄÚ²¿
                      InDacChannelSel(DAC_CH_LINEIN); 
              
                      //´ÓE0 E1ÊäÈëµ½Ð¾Æ¬ÄÚ²¿
                      //SET_E0_ANALOG_IN();   //½«E0E1ÅäÖÃÎªÄ£Äâ¶Ë¿Ú
                      //SET_E1_ANALOG_IN();           
                      //InDacChannelSel(DAC_CH_E0E1);         
              
                      RadioCtrlInit();
              
              #else
 521   1              //Ä¬ÈÏÑ¡ÔñÆ¬ÄÚFMÒôÆµÍ¨Â·
 522   1              InDacChannelSel(DAC_CH_ONCHIP_FM);
 523   1      #endif
 524   1      
 525   1      //FM    
 526   1      #ifdef FUNC_PWM_EN
                      ModuleClkDis(MASK_ALL_CLOCK & (~MSK_PWM_CLOCK));
              #else
 529   1              ModuleClkDis(MASK_ALL_CLOCK);
 530   1      #endif
 531   1      // ÇÐ»»µ½FMºó£¬Ê±ÖÓ·ÖÆµº¯Êý
 532   1      // O20ºÍÒÔÇ°Ð¾Æ¬²»Ò»Ñù£¬ÓÐÁ½¸öÊ±ÖÓÔ´£¬Ä¬ÈÏÊÇÅäÖÃÎªRC clk¡£
 533   1      #ifndef FUNC_SLAVE_UART_EN
 534   1              SysClkDivSet(CLK_DIV_RATE);
 535   1      #endif
 536   1      //#if (FM_IO_TYPE != FM_ONCHIP_IP)      
 537   1      //      RadioCtrlInit();
 538   1      //#endif
 539   1      
 540   1              RadioEnterInit();
 541   1      #ifdef FUNC_TOUCH_KEY_EN
                      TR1 = 1;
              #endif
 544   1              return TRUE;
 545   1      }
 546          #endif
 547          
 548          
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 10  

 549          #ifdef FUNC_LINEIN_EN     
 550          //³¢ÊÔÇÐ»»µ½line-inÄ£Ê½
 551          static BOOL TryGotoModeLINEIN(VOID)
 552          {
 553   1              DBG(("TryGotoModeLINEIN()\n"));
 554   1              
 555   1      #ifdef FUNC_POWER_ON_AUDIO_EN
                      if(gUSBChargePowerOnFlag == TRUE)
                      {
                              return FALSE;
                      }
              #endif  
 561   1      
 562   1              //UÅÌµçÆøÁ¬½Ó¼ì²é
 563   1              if(!IsLineInLink())
 564   1              {
 565   2                      DBG(("IsLineInLink() FALSE!\n"));
 566   2                      return FALSE;
 567   2              }
 568   1              ModuleClkEn(MASK_ALL_CLOCK);
 569   1              SysClkDivClr(); 
 570   1              DBG(("IsLineInLink() OK!\n"));
 571   1      
 572   1              GotoMode(SYS_MODE_LINEIN);
 573   1      
 574   1      #ifdef FUNC_SPI_KEY_SOUND_EN    
 575   1              SPI_PlaySelectNum(SPIPLAY_SONG_PLAY_AUX, 0);
 576   1      #endif  
 577   1      #ifdef AU6210K_NR_D_8_CSRBT
                      NPCA110X_ADC_Input_CH_Select(INPUT_CH0);
                      InDacChannelSel(LINEIN_IO_TYPE);
              #else
 581   1      
 582   1      
 583   1              //Ä¬ÈÏLINE_INÄ£Ê½µÄÒôÔ´Ñ¡ÔñÆ¬ÍâLINE_INÍ¨Â·
 584   1              //LINE_INÄ£Ê½µÄÒôÔ´Ò²¿ÉÒÔÑ¡ÔñE0¡¢E1Í¨Â·, ÔòÐèÒª×öÈçÏÂÅäÖÃ       
 585   1      /*#if (LINEIN_IO_TYPE == DAC_CH_E0_L)
 586   1              SET_E0_ANALOG_IN();     //½«E0ÅäÖÃÎªÄ£Äâ¶Ë¿Ú
 587   1      #elif (LINEIN_IO_TYPE == DAC_CH_E1_R)
 588   1              SET_E1_ANALOG_IN();     //½«E1ÅäÖÃÎªÄ£Äâ¶Ë¿Ú
 589   1      #elif (LINEIN_IO_TYPE == DAC_CH_E0E1)
 590   1      */
 591   1      #if (LINEIN_IO_TYPE == DAC_CH_E0E1)
 592   1              SET_E0_ANALOG_IN();     //½«E0E1ÅäÖÃÎªÄ£Äâ¶Ë¿Ú
 593   1              SET_E1_ANALOG_IN();     
 594   1      #endif
 595   1      
 596   1              InDacChannelSel(LINEIN_IO_TYPE);
 597   1      
 598   1      
 599   1      #endif  
 600   1              LineInCtrlInit();
 601   1      
 602   1      #ifdef FUNC_TOUCH_KEY_EN
                      TR1 = 1;
              #endif
 605   1              return TRUE;
 606   1      }
 607          #endif
 608          
 609          #ifdef FUNC_BLUETOOTH_CSR_EN      
 610          //³¢ÊÔÇÐ»»µ½line-inÄ£Ê½
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 11  

 611          static BOOL TryGotoBluetooth(VOID)
 612          {
 613   1              DBG(("TryGotoModeLINEIN()\n"));
 614   1              
 615   1      #ifdef FUNC_POWER_ON_AUDIO_EN
                      if(gUSBChargePowerOnFlag == TRUE)
                      {
                              return FALSE;
                      }
              #endif  
 621   1      
 622   1              ModuleClkEn(MASK_ALL_CLOCK);
 623   1              SysClkDivClr(); 
 624   1              DBG1(("IsLineInLink() OK!\n"));
 625   1      
 626   1              GotoMode(SYS_MODE_BLUETOOTH);
 627   1      
 628   1      #ifdef FUNC_SPI_KEY_SOUND_EN    
 629   1              SPI_PlaySelectNum(SPIPLAY_SONG_PLAY_BT, 0);
 630   1      #endif  
 631   1      #ifndef FUNC_PT231X_EN
 632   1              //Ä¬ÈÏLINE_INÄ£Ê½µÄÒôÔ´Ñ¡ÔñÆ¬ÍâLINE_INÍ¨Â·
 633   1              //LINE_INÄ£Ê½µÄÒôÔ´Ò²¿ÉÒÔÑ¡ÔñE0¡¢E1Í¨Â·, ÔòÐèÒª×öÈçÏÂÅäÖÃ       
 634   1      /*#if (BLUETOOTH_CJ_IO_TYPE == DAC_CH_E0_L)
 635   1              SET_E0_ANALOG_IN();     //½«E0ÅäÖÃÎªÄ£Äâ¶Ë¿Ú
 636   1      #elif (BLUETOOTH_CJ_IO_TYPE == DAC_CH_E1_R)
 637   1              SET_E1_ANALOG_IN();     //½«E1ÅäÖÃÎªÄ£Äâ¶Ë¿Ú
 638   1      #elif (BLUETOOTH_CJ_IO_TYPE == DAC_CH_E0E1)
 639   1              SET_E0_ANALOG_IN();     //½«E0E1ÅäÖÃÎªÄ£Äâ¶Ë¿Ú
 640   1              SET_E1_ANALOG_IN();     
 641   1      #endif*/
 642   1      
 643   1              //InDacChannelSel(BLUETOOTH_CJ_IO_TYPE);
 644   1      #endif  
 645   1              BluetoothCtrlInit();
 646   1      
 647   1      #ifdef FUNC_TOUCH_KEY_EN
                      TR1 = 1;
              #endif
 650   1              return TRUE;
 651   1      }
 652          #endif
 653          #if 0//def FUNC_BLUETOOTH_EN
              static BOOL TryGotoBluetooth()
              {
                      DBG(("TryGotoModeBLUETOOTH()\n"));
              #ifdef BLUETOOTH_ALWAYS_OPEN
                      if (!gBTConnected)//À¶ÑÀÎ´Á¬½ÓÉÏÊ±£¬²»½øÈëÀ¶ÑÀ×´Ì¬
                      {
                              DBG(("Bluetooth disconnected, don't entry bluetooth mode.\n"));
                              return FALSE;
                      }
              #endif
                      
                      MuteOn(TRUE, TRUE);//ÏÈ½ûµôÉùÒô£¬È¥POPOÉù£¬BluetoothCtrlInit()ÖÐ»áÔÙ´ÎÆô¶¯ÉùÒô
                      ModuleClkEn(MASK_ALL_CLOCK);
                      SysClkDivClr();//ÖØÖÃÏµÍ³×´Ì¬
                      GotoMode(SYS_MODE_BLUETOOTH);   //½øÈëBLUETOOTHÄ£Ê½
              
              #ifdef RTC_SHOWTIME_ANYMODE
                      DispTimeOnOff(FALSE);
              #endif
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 12  

              
              #if defined(AU6210K_JLH_JH82B)
                      InDacChannelSel(DAC_CH_NONE);
              #endif
              
              #if defined(AU6210K_NR_D_8_CSRBT)
                      InDacChannelSel(BLUETOOTH_CJ_IO_TYPE);
              #endif
              
                      return BluetoothCtrlInit();
              }
              #endif
 685          
 686          
 687          ////³¢ÊÔÇÐ»»µ½RTCÄ£Ê½
 688          //static BOOL TryGotoModeRTC(VOID)
 689          //{
 690          //      DBG(("TryGotoModeRTC()\n"));
 691          //      GotoMode(SYS_MODE_RTC);
 692          //
 693          //      InDacChannelSel(DAC_CH_NONE);
 694          //#ifdef FUNC_POWER_AMPLIFIER_EN
 695                  //ABPowerAmplifierOff();
 696          //#endif
 697          //      return TRUE;
 698          //}
 699          
 700          
 701          #ifdef FUNC_AUDIO_EN
              //³¢ÊÔÇÐ»»µ½AUDIOÄ£Ê½
              static BOOL TryGotoModeAUDIO(VOID)
              {
              #ifdef FUNC_POWER_ON_AUDIO_EN   
                      static TIMER Timer;
              #endif
              
                      DBG(("TryGotoModeAUDIO()\n"));  
                      
              #ifdef FUNC_POWER_ON_AUDIO_EN
                      //Á¬½ÓPC¿ª»úÖ±½Ó½øÈëAudio Ä£Ê½
                      if(gUSBChargePowerOnFlag == TRUE)
                      {
                              TimeOutSet(&Timer, 1500);       //Èç¹û¿Í»§Ï£ÍûÁ¬½ÓPC¿ª»úÐèÒªÖ±½Ó½øÈëAudioÄ£Ê½,´ËÊ±¼ä±ØÐë´óÓÚ1.4s
                              while(!IsTimeOut(&Timer))
                              {
                                      if(IsPcLink())
                                      {
                                              break;
                                      }
                              }                       
                      }
                      gUSBChargePowerOnFlag = FALSE;
              #endif
                      
                      //PCÁ¬½Ó¼ì²é
                      IsPcInsert();   //ÎªÁËPCÁ¬½Ó¿ª»úÇé¿öÏÂ¼ì²éPC ×´Ì¬
                      
                      if(!IsPcLink())
                      {
                              DBG(("Audio,IsPcLink() FALSE!\n"));
                              return FALSE;
                      }
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 13  

              
              #ifdef FUNC_DISP_EN     
                      DispAudio();
              #endif  
              
                      MuteOn(TRUE, TRUE);     //½â¾öÁ¬½Ó PC¹ý³ÌÖÐ»áÔÙ³öÖ®Ç°Éè±¸¸èÇúÉùÒôÎÊÌâ
              
                      ModuleClkEn(MASK_ALL_CLOCK);            
                      SysClkDivClr();
              
                      GotoMode(SYS_MODE_AUDIO);
                      InDacChannelSel(DAC_CH_DAC);
                      
                      DeviceAudioSetMode(USB_DEVICE_AUDIO);
                      DeviceAudioCtrlInit();
              #ifdef FUNC_TOUCH_KEY_EN
                      TR1 = 1;
              #endif
              
              //      DBG(("Usb audio mode ok!\n"));
                      return TRUE;
              }
              #endif
 758          
 759          
 760          #ifdef FUNC_READER_EN
              //³¢ÊÔÇÐ»»µ½READERÄ£Ê½
              static BOOL TryGotoModeREADER(VOID)
              {       
                      DBG(("TryGotoModeREADER()\n"));
                      //PCÁ¬½Ó¼ì²é
                      if(!IsPcLink())
                      {
                              DBG(("Reader,IsPcLink() FALSE!\n"));
                              return FALSE;
                      }
              
                      MuteOn(TRUE, TRUE);     //½â¾öÁ¬½Ó PC¹ý³ÌÖÐ»áÔÙ³öÖ®Ç°Éè±¸¸èÇúÉùÒôÎÊÌâ
              
              #ifdef FUNC_DISP_EN
                      DispLoad();
              #endif
              
                      ModuleClkEn(MASK_ALL_CLOCK);            
                      SysClkDivClr();
              
                      GotoMode(SYS_MODE_READER);
                      InDacChannelSel(DAC_CH_DAC);
              
                      DeviceAudioSetMode(USB_DEVICE_READER);
              #ifdef FUNC_CARD_EN 
                      DeviceStorCtrlInit();
              #endif
              #ifdef FUNC_TOUCH_KEY_EN
                      TR1 = 1;
              #endif
              //      DBG(("Usb reader mode ok!\n"));
                      return TRUE;
              }
              #endif
 795          
 796          
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 14  

 797          #ifdef FUNC_AUDIO_READER_EN
              //³¢ÊÔÇÐ»»µ½AUDIO_READERÄ£Ê½
              static BOOL TryGotoModeAUDIO_READER(VOID)
              {       
              #ifdef FUNC_POWER_ON_AUDIO_EN   
                      static TIMER Timer;
              #endif
              
                      DBG(("TryGotoModeAUDIO_READER()\n"));   
                      
              #ifdef FUNC_POWER_ON_AUDIO_EN
                      //Á¬½ÓPC¿ª»úÖ±½Ó½øÈëAudio Ä£Ê½
                      if(gUSBChargePowerOnFlag == TRUE)
                      {
                              TimeOutSet(&Timer, 1500);       //Èç¹û¿Í»§Ï£ÍûÁ¬½ÓPC¿ª»úÐèÒªÖ±½Ó½øÈëAudioÄ£Ê½,´ËÊ±¼ä±ØÐë´óÓÚ1.4s
                              while(!IsTimeOut(&Timer))
                              {
                                      if(IsPcLink())
                                      {
                                              break;
                                      }
                              }                       
                      }
                      gUSBChargePowerOnFlag = FALSE;
              #endif
              
                      //PCÁ¬½Ó¼ì²é
                      IsPcInsert();   //ÎªÁËPCÁ¬½Ó¿ª»úÇé¿öÏÂ¼ì²éPC ×´Ì¬
              
                      if(!IsPcLink())
                      {
                              DBG(("Audio,IsPcLink() FALSE!\n"));
                              return FALSE;
                      }       
              
              #ifdef FUNC_DISP_EN     
                      DispAudio();
              #endif  
              
                      MuteOn(TRUE, TRUE);     //½â¾öÁ¬½Ó PC¹ý³ÌÖÐ»áÔÙ³öÖ®Ç°Éè±¸¸èÇúÉùÒôÎÊÌâ
                      
                      ModuleClkEn(MASK_ALL_CLOCK);            
                      SysClkDivClr();
              
                      GotoMode(SYS_MODE_AUDIO_READER);
                      InDacChannelSel(DAC_CH_DAC);
                      
                      DeviceAudioSetMode(USB_DEVICE_AUDIO_READER);
                      DeviceAudioCtrlInit();
              #ifdef FUNC_CARD_EN 
                      DeviceStorCtrlInit();
              #endif
              #ifdef FUNC_TOUCH_KEY_EN
                      TR1 = 1;
              #endif
              //      DBG(("Usb audio reader mode ok!\n"));
                      return TRUE;
              }
              #endif
 856          
 857          
 858          #ifdef  FUNC_SPI_UPDATE_EN
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 15  

 859          extern BYTE gIsMVFFileFind;
 860          #endif
 861          #ifdef FUNC_SPI_PLAY_EN
              //³¢ÊÔÇÐ»»µ½spi-devÄ£Ê½
              static BOOL TryGotoModeSpiDev()
              {
                      DBG(("->TryGotoSPIDev!\n"));
              
                      if(!IsSpiFlashHandleGot())
                      {
                              DBG(("No SPI Dev!\n"));
                              return FALSE;
                      }
              #ifdef FUNC_DISP_EN
                      DispLoad();
              #endif
              
                      ModuleClkEn(MASK_ALL_CLOCK);            
                      SysClkDivClr();
              
                      GotoMode(SYS_MODE_SPIDEV);
                      InDacChannelSel(DAC_CH_DAC);
              
              #ifdef  FUNC_SPI_UPDATE_EN
                      gIsMVFFileFind = 0;
              #endif
              
                      FSInit(DEV_ID_SPI);
                      PlayCtrlInit();
                      gSongInfo.SongType = SONG_TYPE_MP3; 
                      gPlayCtrl.File.FileType = FILE_TYPE_MP3;
                      gPlayCtrl.FileNum = 1;
                      DBG(("<-TryGotoSPIDev!\n"));
              #ifdef FUNC_TOUCH_KEY_EN
                      TR1 = 1;
              #endif  
                      return TRUE;
              }
              #endif
 898          
 899          
 900          #ifdef FUNC_OTP_PLAY_EN
              static BOOL TryGotoModeOtpDev(VOID)
              {
                      DBG((">>TryGotoModeOtpDev()\n"));
              #ifdef FUNC_DISP_EN
                      DispLoad();
              #endif
              
                      ModuleClkEn(MASK_ALL_CLOCK);            
                      SysClkDivClr();
                              
                      GotoMode(SYS_MODE_OTPDEV);
                      InDacChannelSel(DAC_CH_DAC);
              
                      FSInit(DEV_ID_OTP);
                      PlayCtrlInit();
                      gSongInfo.SongType = SONG_TYPE_MP3; 
                      gPlayCtrl.File.FileType=FILE_TYPE_MP3;
                      gPlayCtrl.FileNum = 1;
              #ifdef FUNC_TOUCH_KEY_EN
                      TR1 = 1;
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 16  

              #endif
                      return TRUE;
              }
              
              
              //²¥·ÅÑ¡ÔñµÄOTP¸èÇú
              static VOID OTP_PlaySelectNum(BYTE PlayNum)
              {       
                      BYTE SystemMode, Volume;
              
                      SystemMode = gSys.SystemMode;   
                      Volume = gSys.Volume;   
                      
                      DBG(("<-OTPSongPlayStart()\n"));        
                      PlayNum = 1;    
                      gSys.Volume = VOLUME_MAX;
              #ifdef AU6210K_NR_D_8_CSRBT
                      NPCA110X_DAC1_Set_Volume_and_Mute(gSys.Volume);
                      InDacSetVolume(gVolArr[32], gVolArr[32]);
              #else
                      InDacSetVolume(gVolArr[gSys.Volume], gVolArr[gSys.Volume]);
              #endif  
                      TryGotoModeOtpDev();
                      UnMute();       
                      while(1)
                      {    
                              FeedWatchDog(); 
                              if(FileEOF(&gPlayCtrl.File) && IsFifoEmpty())
                              {
                                      DBG(("Song play end!\n"));
                                      //µÈ´ýPCMÊý¾ÝÈ«²¿±»È¡×ß
                                      break;
                              }
                              if(!SongPlayDo())
                              {
                                      DBG(("PlayStatePlayOp,!SongPlayDo()\n"));                       
                                      break;
                              }       
                      }
                      DBG(("<-OTPSongPlayStop()\n"));
                      PlayCtrlEnd();  
                      InDacChannelSel(DAC_CH_NONE);
                      gSys.SystemMode = SystemMode;
                      gSys.Volume = Volume;
              }
              #endif
 967          
 968          
 969          //ÏµÍ³ÉÏµç¿ª»úÒôÀÖÉù
 970          VOID SystemPowerOnSound(VOID)
 971          {       
 972   1      #ifdef  FUNC_OTP_KEY_SOUND_EN
                      OTP_PlaySelNum(OTPPLAY_NUM_POWERON, 0);
              #endif
 975   1      
 976   1      #ifdef FUNC_SPI_FLASH_POWERON_SOUND
 977   1              SPI_PlaySelectNum(SPIPLAY_SONG_POWER_ON_SOUND1, 0);
 978   1      #endif
 979   1      }
 980          
 981          
 982          //³¢ÊÔÇÐ»»µ½Ö¸¶¨Éè±¸
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 17  

 983          static BOOL TryGotoMode(BYTE Mode)
 984          {       
 985   1      #ifdef  FUNC_QUICK_RESPONSE_EN
                      //Èç¹ûÊÇÇ¿ÐÐÇÐ»»Ä£Ê½
                      if(IsSwitchMode)
                      {
                              DBG(("300\n"));
                              return TRUE;
                      }
              
                      CurMode = Mode;
              #endif
 995   1      
 996   1              switch(Mode)
 997   1              {
 998   2      #ifdef FUNC_SLAVE_UART_EN
                              case SYS_MODE_NONE:
                                      return TryGotoModeIdle();
              #endif          
1002   2              
1003   2      #ifdef FUNC_USB_EN
                              case SYS_MODE_USB:
                                      return TryGotoModeUSB();
              #endif
1007   2      
1008   2      #ifdef FUNC_CARD_EN
                              case SYS_MODE_SD:
                                      return TryGotoModeSD();
              #endif
1012   2      
1013   2      #ifdef FUNC_LINEIN_EN
1014   2                      case SYS_MODE_LINEIN:
1015   2                              return TryGotoModeLINEIN();
1016   2      #endif
1017   2      #ifdef FUNC_BLUETOOTH_CSR_EN
1018   2                      case SYS_MODE_BLUETOOTH:
1019   2                              return TryGotoBluetooth();
1020   2      #endif
1021   2      #ifdef FUNC_BLUETOOTH_EN
                              case SYS_MODE_BLUETOOTH:
                                      return TryGotoBluetooth();
              #endif
1025   2      
1026   2      
1027   2      #ifdef FUNC_RADIO_EN
1028   2                      case SYS_MODE_RADIO:
1029   2                              DBG(("TryGotoModeRADIO\n"));
1030   2                              return TryGotoModeRADIO();
1031   2      #endif
1032   2      
1033   2      #ifdef FUNC_AUDIO_EN
                              case SYS_MODE_AUDIO:
                                      DBG(("TryGotoModeAUDIO\n"));
                                      return TryGotoModeAUDIO();
              #endif
1038   2      
1039   2      #ifdef FUNC_READER_EN
                              case SYS_MODE_READER:
                                      DBG(("TryGotoModeREADER\n"));
                                      return TryGotoModeREADER();
              #endif
1044   2      
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 18  

1045   2      #ifdef FUNC_AUDIO_READER_EN
                              case SYS_MODE_AUDIO_READER:
                                      DBG(("TryGotoModeAUDIO_READER\n"));
                                      return TryGotoModeAUDIO_READER();
              #endif
1050   2      
1051   2      #ifdef FUNC_SPI_PLAY_EN
                              case SYS_MODE_SPIDEV:
                                      DBG(("TryGotoModeOtpDevSPI\n"));
                                      return TryGotoModeSpiDev();
                                      break;
              #endif
1057   2      
1058   2      #ifdef FUNC_OTP_PLAY_EN
                              case SYS_MODE_OTPDEV:
                                      DBG(("TryGotoModeOtpDev001\n"));
                                      return TryGotoModeOtpDev();
                                      break;
              #endif
1064   2      
1065   2      #ifdef FUNC_STANDBY_EN
                              case SYS_MODE_STANDBY:
                                      return TryGotoModeStandby();
                                      break;
              #endif
1070   2      
1071   2                      default:
1072   2      #ifdef FUNC_USB_EN
                                      return TryGotoModeUSB();
              #elif defined(FUNC_CARD_EN)
                                      return TryGotoModeSD();
              #else
1077   2                              return FALSE;
1078   2      #endif
1079   2              }
1080   1      }
1081          
1082          
1083          //³¢ÊÔÇÐ»»µ½ModeÄ£Ê½£¬Èç¹û²»³É¹¦£¬Ôò½øÈëÏÂÒ»¸öÄ£Ê½¡£
1084          static VOID TryGotoNextMode(BYTE Mode)
1085          {
1086   1              BYTE i;
1087   1              BYTE ModeIndex;
1088   1      
1089   1              //Õâ¸öÊý×é¾ö¶¨Éè±¸ÇÐ»»Ê±µÄË³Ðò£¬¸ÃË³ÐòÊÇÑ­»·µÄ
1090   1              static BYTE ModeOrder[] = 
1091   1              {
1092   1      #ifdef FUNC_BLUETOOTH_EN
                              SYS_MODE_BLUETOOTH, 
              #endif
1095   1      
1096   1      #ifdef FUNC_BLUETOOTH_CSR_EN
1097   1                      SYS_MODE_BLUETOOTH, 
1098   1      #endif
1099   1      
1100   1      #ifdef FUNC_USB_EN
                              SYS_MODE_USB,
              #endif  
1103   1      
1104   1      #ifdef FUNC_CARD_EN
                              SYS_MODE_SD,
              #endif
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 19  

1107   1      
1108   1      #ifdef FUNC_RADIO_EN
1109   1                      SYS_MODE_RADIO,
1110   1      #endif  
1111   1      
1112   1      #ifdef FUNC_LINEIN_EN
1113   1                      SYS_MODE_LINEIN,
1114   1      #endif  
1115   1       
1116   1      #ifdef FUNC_AUDIO_EN
                              SYS_MODE_AUDIO,
              #endif
1119   1      
1120   1      #ifdef FUNC_READER_EN
                              SYS_MODE_READER,
              #endif
1123   1      
1124   1      #ifdef FUNC_AUDIO_READER_EN
                              SYS_MODE_AUDIO_READER,
              #endif
1127   1      
1128   1      #ifdef FUNC_SPI_PLAY_EN
                              SYS_MODE_SPIDEV,
              #endif
1131   1      
1132   1      #ifdef FUNC_OTP_PLAY_EN
                              SYS_MODE_OTPDEV,
              #endif
1135   1              };
1136   1      
1137   1              for(ModeIndex = 0; ModeIndex < sizeof(ModeOrder); ModeIndex++)
1138   1              {
1139   2                      if(Mode == ModeOrder[ModeIndex])
1140   2                      {
1141   3                              break;
1142   3                      }
1143   2              }
1144   1      
1145   1              for(i = 0; i < sizeof(ModeOrder); i++)
1146   1              {
1147   2                      FeedWatchDog();
1148   2                      ModeIndex++;
1149   2                      if(ModeIndex >= sizeof(ModeOrder))
1150   2                      {
1151   3                              ModeIndex = 0;
1152   3                      }               
1153   2                      
1154   2      #ifdef AU6210K_XLX_ALD800
1155   2                      if(ModeOrder[ModeIndex] == SYS_MODE_LINEIN)
1156   2                      {
1157   3                              if(TryGotoMode(SYS_MODE_BLUETOOTH))
1158   3                              {
1159   4                                      return;
1160   4                              }
1161   3                      }
1162   2                              
1163   2      
1164   2      #endif
1165   2                      if(TryGotoMode(ModeOrder[ModeIndex]))
1166   2                      {
1167   3                              return;
1168   3                      }
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 20  

1169   2              }
1170   1      
1171   1              TryGotoModeIdle();
1172   1      }
1173          
1174          
1175          //³¢ÊÔÇÐ»»µ½ModeÄ£Ê½£¬Èç¹û²»³É¹¦£¬Ôò½øÈëÏÂÒ»¸öÄ£Ê½¡£
1176          static VOID TryGotoValidMode(BYTE Mode)
1177          {
1178   1              if(!TryGotoMode(Mode))
1179   1              {
1180   2                      TryGotoNextMode(Mode);
1181   2              }
1182   1      }
1183          
1184          
1185          //³¢ÊÔÇÐ»»µ½ModeÄ£Ê½£¬Èç¹û²»³É¹¦£¬Ôò½øÈëÔ­À´µÄÄ£Ê½¡£
1186          static VOID TryGotoValidModeReturn(BYTE Mode)
1187          {
1188   1              BYTE OldMode = gSys.SystemMode;
1189   1      
1190   1      #ifdef  FUNC_DEVICE_FORCEPAUSE_EN
                      gDevicePlayForcePauseFlag = FALSE;
              #endif
1193   1      
1194   1              if(!TryGotoMode(Mode))
1195   1              {
1196   2                      if(!TryGotoMode(OldMode))
1197   2                      {
1198   3                              TryGotoNextMode(SYS_MODE_USB);
1199   3                      }
1200   2              }
1201   1      }
1202          
1203          
1204          VOID DevCtrlInit(VOID)
1205          {
1206   1              static TIMER Timer;
1207   1      
1208   1      //      TimeOutSet(&VolumeUpTimer, 0);
1209   1              TimeOutSet(&gPlayWatchTimer, 0);
1210   1              
1211   1      #ifdef  FUNC_HEADPHONE_DETECT_EN
                      TimeOutSet(&sHeadPhoneCheckTimer, 0);
              #endif
1214   1              
1215   1      #ifdef FUNC_BEEP_SOUND_EN
                      TimeOutSet(&gPushKeyBeepTimer, 0);
              #endif  
1218   1      
1219   1      #ifdef FUNC_SNOOZE_EN
                      TimeOutSet(&sSnoozeTimer, 0);
              #endif  
1222   1      
1223   1      #ifdef FUNC_LED_LINEIN_MULTIPLE_EN
                      TimeOutSet(&gLineInCheckWaitTimer, 0);
              #endif
1226   1      
1227   1      #ifndef FUNC_BREAK_POINT_EN
                      gSys.SystemMode = SYS_MODE_NONE;
                      gSys.Volume = VOLUME_INIT;
                      gPlayCtrl.Eq = DECD_EQ_NORMAL;
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 21  

                      gPlayCtrl.RepeatMode = REPEAT_ALL;
              #ifdef FUNC_FOLDER_EN
                      gPlayCtrl.FolderEnable = TRUE;
              #else
                      gPlayCtrl.FolderEnable = FALSE;
              #endif
              #endif
1238   1      
1239   1      #ifdef FUNC_QUICK_RESPONSE_EN
                      IsSwitchMode = FALSE;
              #endif
1242   1      
1243   1      #ifdef FUNC_USB_EN
                      DBG(("InitUsb()\n"));
                      HostInit();
              #endif
1247   1      
1248   1      #ifdef FUNC_CARD_EN
              #ifdef CARD_BUS_A3A4A5_EN
                      SET_CARD_TO_A3A4A5();
              #endif
              #ifdef  CARD_BUS_A0E2E3_EN
                      SET_CARD_TO_A0E2E3();
              #endif
              #ifdef  CARD_BUS_D5D6D7_EN
                      SET_CARD_TO_D5D6D7();
              #endif
                      DBG(("CardOpen()\n"));
                      CardOpen();
                      TimeOutSet(&CardDctTimer, 0);
              #endif
1262   1      
1263   1      #ifdef FUNC_RADIO_EN
1264   1      #ifdef FUNC_SLAVE_UART_EN
                     gRadioCtrl.RadioUpperBound = RADIO_UPPER_BOUND;
                     gRadioCtrl.RadioLowerBound = RADIO_LOWER_BOUND;
                      gRadioCtrl.RadioFreqBase = gRadioCtrl.RadioLowerBound;   
                      gRadioCtrl.RadioSeekStep = RADIO_SEEK_STEP_100KHZ;
              #endif
1270   1      
1271   1              RadioInit();
1272   1              RadioPowerDown();
1273   1      #endif
1274   1      
1275   1      #ifdef FUNC_POWER_AMPLIFIER_EN
1276   1                      ABPowerAmplifierOn();   //ÔÚÆäËüÄ£Ê½ÏÂÑ¡ÔñAB Àà¹¦·Å
1277   1      #endif  
1278   1      
1279   1      
1280   1              //µÈ´ý300ºÁÃë£¬µÚÒ»´Î¼ì²âËùÓÐÉè±¸µÄÁ¬½Ó×´Ì¬
1281   1              //Ïû³ýÏµÍ³¸´Î»ºóµÚÒ»´ÎµÄºó²åÏÈ²¥
1282   1              TimeOutSet(&Timer, 300);
1283   1              while(!IsTimeOut(&Timer))
1284   1              {       
1285   2      #ifdef FUNC_HEADPHONE_ADC_DETECT_EN
                              KeyEventGet();  
              #endif
1288   2              
1289   2      #ifdef FUNC_USB_EN
                              IsUsbInsert();
              #endif
1292   2      #ifdef AU6210K_NR_D_8_CSRBT
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 22  

              #ifdef FUNC_LINEIN_EN
                              IsLineInInsert();
              #endif
              #ifdef FUNC_CARD_EN
                              IsCardInsert();
              #endif
              
              #else
1301   2      #ifdef FUNC_CARD_EN
                              IsCardInsert();
              #endif
1304   2      
1305   2      #ifdef FUNC_LINEIN_EN
1306   2                      IsLineInInsert();
1307   2      #endif
1308   2      #endif
1309   2              }
1310   1      
1311   1      #ifdef  FUNC_HEADPHONE_DETECT_EN
                      IsHeadPhonInsert();
              #endif
1314   1      
1315   1      #ifdef OPTION_CHARGER_DETECT
                      IsChargerInsert();
                      
                      if(IsChargerLinkFlag == TRUE)  
                      {
              #ifdef  FUNC_DEVICE_FORCEPAUSE_EN
                              gDevicePlayForcePauseFlag = TRUE;
              #endif
                      }       
                      else
                      {                       
              #ifdef FUNC_POWER_ON_AUDIO_EN
                              gUSBChargePowerOnFlag = FALSE;                                  
              #endif
                      }
              #endif   
1331   1      
1332   1      #if (defined(FUNC_OTP_KEY_SOUND_EN) || defined(FUNC_SPI_FLASH_POWERON_SOUND))
1333   1              SystemPowerOnSound();   //ÏµÍ³¿ª»úÒôÀÖ²¥·Å
1334   1      #endif
1335   1      
1336   1      #if (defined(FUNC_AUDIO_EN) || defined(FUNC_AUDIO_READER_EN))
              //Á¬½ÓPC¿ª»úÖ±½Ó½øÈëAudio Ä£Ê½
              #ifdef FUNC_POWER_ON_AUDIO_EN
              #ifdef FUNC_AUDIO_EN
                      gSys.SystemMode = SYS_MODE_AUDIO;
              #else
                      gSys.SystemMode = SYS_MODE_AUDIO_READER;
              #endif
              #endif
              #endif
1346   1      
1347   1      #ifdef FUNC_STANDBY_EN
                      gSys.SystemMode = SYS_MODE_STANDBY;
              #endif
1350   1      #ifdef FUNC_PT231X_EN
                     gSys.Volume =VOLUME_INIT;
                     PT2313Init();
              #endif
1354   1      
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 23  

1355   1      #if 0//defined(AU6210K_NR_D_9X_XJ_HTS)
                      if (IsUsbLinkFlag == TRUE)
                      {
                              gSys.SystemMode = SYS_MODE_USB;
                      }
                      else if (IsCardLinkFlag == TRUE)
                      {
                              gSys.SystemMode = SYS_MODE_SD;
                      }
                      else
                      {
                              gSys.SystemMode = SYS_MODE_BLUETOOTH;
                      }
              #endif
1369   1      
1370   1      #if defined(AU6210K_NR_D_8_CSRBT)|| defined(AU6210K_ZB_BT007_CSR)
1371   1      #ifdef FUNC_LINEIN_EN
1372   1              if (IsLineInLinkFlag == TRUE)
1373   1              {
1374   2                      gSys.SystemMode = SYS_MODE_LINEIN;
1375   2              }
1376   1              else 
1377   1      #endif
1378   1      
1379   1      #ifdef FUNC_CARD_EN
                      if(IsCardLinkFlag == TRUE)
                      {
                              gSys.SystemMode = SYS_MODE_SD;
                      }
                      else
              #endif
1386   1              {
1387   2                      gSys.SystemMode = SYS_MODE_BLUETOOTH;
1388   2              }
1389   1      #endif
1390   1      
1391   1      
1392   1      #if 0// defined(AU6210K_HXX_B002)
                      if (IsCardLinkFlag == TRUE)
                      {
                              gSys.SystemMode = SYS_MODE_SD;
                      }
                      else
                      {
                              gSys.SystemMode = SYS_MODE_BLUETOOTH;
                      }
              #endif
1402   1      
1403   1      #if defined(AU6210K_JLH_JH82B)
                              gSys.SystemMode = SYS_MODE_BLUETOOTH;
              #endif
1406   1              if(!TryGotoMode(gSys.SystemMode))
1407   1              {
1408   2      #ifndef FUNC_QUICK_RESPONSE_EN
1409   2      #ifdef FUNC_BLUETOOTH_EN
                              TryGotoValidMode(SYS_MODE_BLUETOOTH);
              #else
1412   2      #ifdef AU6210K_NR_D_8_CSRBT
                              TryGotoValidMode(SYS_MODE_SD);
              #else
1415   2                      TryGotoValidMode(SYS_MODE_BLUETOOTH);
1416   2      #endif
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 24  

1417   2      #endif
1418   2      #else
                              //½øÈë¶ÏµãÐÅÏ¢ÖÐµÄÄ£Ê½Ê±Ê§°Ü£¬Ôò³¢ÊÔ½øÈëµÚÒ»¸öÓÐÐ§Ä£Ê½
                              if(!IsSwitchMode)
                              {
                                      TryGotoValidMode(SYS_MODE_USB);
                              }
              
                              //ÓÐÄ£Ê½°´¼ü£¬Ôò³¢ÊÔÇÐ»»Ä£Ê½
                              while(IsSwitchMode)
                              {
                                      IsSwitchMode = FALSE;
                                      DBG(("CurMode: %d\n", (WORD)CurMode));
                                      TryGotoNextMode(CurMode);
                              }
              #endif
1433   2              }
1434   1      }
1435          
1436          // Device state control.
1437          VOID DevStateCtrl(VOID)
1438          {
1439   1              static MESSAGE Event;   //Îª½â¾öEventÖµ±»ÐÞ¸Äbug½«±äÁ¿ÉùÃ÷ÎªstaticÀàÐÍ. 
1440   1              BYTE TempMode = gSys.SystemMode;
1441   1      
1442   1              Event = MessageGet(MSG_FIFO_DEV_CTRL);   
1443   1      //      DBG(("DevStateCtrl\nevent:%bx\n", Event));
1444   1      //DBG1(("vol = %x\n",gSys.Volume));
1445   1      #if 0//def AU6210K_NR_D_8_CSRBT
              #if defined(FUNC_NPCA110X_EN) 
                      if(Event == MSG_DEFAULT)
                      {
                              DBG1(("msg_default\n"));
                              if(!isDealSetBass)
                              {                       
                                      isDealSetBass = TRUE;
                                      TimeOutSet(&SetBassTimer, 0);
              
                                      if(isDefaultBass)
                                      {
                                              isDefaultBass = FALSE;
                                      }
                                      else
                                      {
                                              isDefaultBass = TRUE;
                                      }
                              }
                      }
              
                      
                      if(IsTimeOut(&SetBassTimer) && isDealSetBass)
                      {
              
                              TimeOutSet(&SetBassTimer, SET_BASS_TIME);
                              if(isDefaultBass)
                              {
                                      NPCA110X_NormalBass(i,BassLed_CallBak);
                              }
                              else
                              {
                                      NPCA110X_SetBass(i,BassLed_CallBak);
                              }
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 25  

                              i++;
                                              DBG1(("msg_default deal i = %x\n",i));
              
                      }
                      else
                      {
                              i = 0;
                      }
              #endif
              #endif
1489   1      
1490   1      #ifdef FUNC_QUICK_RESPONSE_EN
                      IsSwitchMode = FALSE;
              #endif
1493   1      
1494   1      #ifdef FUNC_STANDBY_EN
                      //´ý»ú×´Ì¬ÏÂÖ»ÏìÓ¦´ý»úÍË³öÏûÏ¢
                      if(gSys.SystemMode == SYS_MODE_STANDBY)
                      {
                              if(Event == MSG_POWER)
                              {
                                      DBG(("EXIT STANDBY!\n"));
                                      InDacInit(FALSE);                       
                                      if(!TryGotoMode(gSystemExecState))
                                      {
                                              TryGotoValidMode(SYS_MODE_USB);
                                      }       
                                  #ifdef FUNC_POWER_AMPLIFIER_EN
                                     if(gSystemExecState != SYS_MODE_RADIO)
                                            ABPowerAmplifierOn();
                          #endif
                                      
                                      #ifdef FUNC_USB_VOLUP_EN
                                          if (Mode != SYS_MODE_USB)
                                         {
                                                USB_VOLUP_Off();
                                         }
                          #endif              
                                      
                              }
                              return;
                      }
              #endif
1522   1      
1523   1      #ifdef POWER_SAVING_MODE_OPTION
1524   1              //Èç¹ûÏµÍ³´øÓÐ¹Ø±Õ¹¦ÄÜ(POWERDOWN»òSLEEP)£¬ÊÕµ½ÏµÍ³¹Ø±ÕÏûÏ¢ºó£¬ÔòÖ´ÐÐÏµÍ³¹Ø±Õ²Ù×÷
1525   1              if((Event == MSG_SYS_OFF) || (Event == MSG_POWER))
1526   1              {       
1527   2      #ifdef FUNC_STANDBY_EN
                              TryGotoValidMode(SYS_MODE_STANDBY);
              #else
1530   2                      SystemOff();
1531   2      #endif
1532   2              }
1533   1      #endif
1534   1              
1535   1      #ifdef FUNC_USB_EN
                      //ºó²åÏÈ²¥¼ì²â
                      //DBG(("gIsUsbReconnect%bx\n",gIsUsbReconnect));
                      if(IsUsbInsert() || ((gIsUsbRemove == TRUE) && (IsUSBLink())))                  //ÓÐUÅÌÐÂ²åÈë
                      {               
                              IsUsbLinkFlag = TRUE;   //usb ¿ìËÙ²å°Î¹ý³ÌÖÐÒ»¸öÂß¼­Â©¶´
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 26  

                              if((gFsInfo.DevID == DEV_ID_OTP) && (gSys.SystemMode == SYS_MODE_OTPDEV))
                              {
                                      gPlayCtrl.State = PLAY_STATE_STOP;
                              }                               
                              DBG(("IsUsbInsert()\n"));
                              if((gIsUsbRemove == TRUE) && IsUSBLink())
                              {
                                      DBG(("**Ins**\n"));
                              }
              #ifdef  FUNC_USB_CHARGE_EN
                              AppleDeviceFlag = FALSE;    
              #endif
                              gIsUsbRemove = FALSE;
                              if(!TryGotoMode(SYS_MODE_USB))
                              {
                                      TryGotoValidMode(TempMode);
                              }                       
                      }
              #endif
1560   1              //DBG1(("IsDacMute = %x\n",IsDacMute));
1561   1      
1562   1      #ifdef FUNC_CARD_EN
                      //ÓÐ¿¨ÐÂ²åÈë£¬²¢ÇÒµ±Ç°²»ÊÇ´¦ÓÚ¶Á¿¨Æ÷»òÒ»ÏßÍ¨Ä£Ê½£¬Ôò×öºó²åÏÈ²¥´¦Àí
                      if(IsCardInsert()               
                      && (gSys.SystemMode != SYS_MODE_READER)
                      && (gSys.SystemMode != SYS_MODE_AUDIO_READER))          
                      {       
                              if((gFsInfo.DevID == DEV_ID_OTP) && (gSys.SystemMode == SYS_MODE_OTPDEV))
                              {
                                      gPlayCtrl.State = PLAY_STATE_STOP;
                              }                               
                              DBG(("IsCardInsert()\n"));
                              MuteOn(TRUE,TRUE);
                              WaitMs(150);//½â¾öinit sd card errorÎÊÌâ
                              TryGotoValidModeReturn(SYS_MODE_SD);
                      }
              #endif
1578   1      
1579   1      #ifdef FUNC_LINEIN_EN
1580   1              if(IsLineInInsert())    //ÓÐline-inÐÂ²åÈë
1581   1              {
1582   2                      DBG(("IsLineInInsert()\n"));
1583   2                      TryGotoValidModeReturn(SYS_MODE_LINEIN);
1584   2              }
1585   1      #endif
1586   1      
1587   1      #if ((defined FUNC_AUDIO_EN) || (defined FUNC_READER_EN) || (defined FUNC_AUDIO_READER_EN))
                      if(IsPcInsert())                //ÓÐPCÐÂ²åÈë
                      {
                              DBG(("IsPcInsert()\n"));
              
              #if (defined FUNC_AUDIO_EN)
                              TryGotoValidModeReturn(SYS_MODE_AUDIO);
              #elif (defined FUNC_READER_EN)
                              TryGotoValidModeReturn(SYS_MODE_READER);
              #elif (defined FUNC_AUDIO_READER_EN)
                              TryGotoValidModeReturn(SYS_MODE_AUDIO_READER);
              #endif
                      }
              #endif
1601   1      
1602   1      #ifdef  FUNC_DEVICE_FORCEPAUSE_EN
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 27  

                      if(IsChargerInsert())   //ÓÐPC»ò³äµçÆ÷ÐÂ²åÈë
                      {
                              gDevicePlayForcePauseFlag = TRUE;
              #ifdef  FUNC_RADIO_EN
                              if((gSys.SystemMode == SYS_MODE_RADIO) && (gRadioCtrl.State != RADIO_IDLE))
                              {
                                      gRadioCtrl.State = RADIO_IDLE;  
                              }
              #endif
                              MuteOn(TRUE, TRUE);
                      }
                      else if(gDevicePlayForcePauseFlag == TRUE)
                      {
                              if(!IsInCharge())
                              {
                                      gDevicePlayForcePauseFlag = FALSE;
                                      if((gSys.SystemMode == SYS_MODE_SD) || (gSys.SystemMode == SYS_MODE_USB)) 
                                      {
                                              MessageSend(MSG_FIFO_KEY, MSG_PLAY_PAUSE);
                                      }       
              #ifdef  FUNC_RADIO_EN
                                      else if(gSys.SystemMode == SYS_MODE_RADIO)
                                      {
                                              UnMute();
                                      }
              #endif
                              }
                      }
              #endif
1632   1      
1633   1      #ifdef  FUNC_HEADPHONE_DETECT_EN
                      if(IsTimeOut(&sHeadPhoneCheckTimer))
                      {               
              #ifdef FUNC_HEADPHONE_ADC_DETECT_EN             
                              TimeOutSet(&sHeadPhoneCheckTimer, 0);
                              if(IsHeadphoneLinkFlag == TRUE)
              #else           
                              TimeOutSet(&sHeadPhoneCheckTimer, 100);
                              if(IsHeadPhonInsert())  //ÓÐ¶ú»ú²åÈë
              #endif
                              {
              #ifdef FUNC_EXMUTE_EN
                                      ExMuteOn();     
              #endif                  
                                      //DBG(("HeadPhone insert\n"));
                              }
                              else if((IsHeadphoneLinkFlag == FALSE) && (IsDacMute == FALSE))
                              {
              #ifdef FUNC_EXMUTE_EN
                                      ExMuteOff();
              #endif                  
                                      //DBG(("HeadPhone no insert\n"));
                              }
                      }
              #endif
1658   1      
1659   1              //Éè±¸°Î³ý¼ì²â
1660   1              //cunrrent device is removed.
1661   1              switch(gSys.SystemMode)
1662   1              {
1663   2      #ifdef FUNC_USB_EN
                              case SYS_MODE_USB:                      //current system mode is USB            
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 28  

                                      if(gDeviceError)                //usb error
                                      {
                                              DBG(("gDeviceError\n"));
                                              gDeviceError = 0;
                                              //Èç¹ûUSB¿¨³öÏÖ´íÎó£¬ÔòÕâÀï»á³¢ÊÔÖØÐÂ½øÈëUSBÄ£Ê½
                                              if(!TryGotoModeUSB())
                                              {
              #if 0
                                                      if (!TryGotoModeSD())
                                                      {
                                                              TryGotoValidMode(SYS_MODE_LINEIN);
                                                      }
              #else
                                                      TryGotoValidMode(SYS_MODE_SD);
              #endif
                                              }
                                      }
                                      else if(!IsUSBLink())           //usb removed
                                      {
                                              DBG(("usb removed!\n"));
              #ifdef FUNC_USB_CHARGE_EN                       
                                              AppleDeviceFlag = FALSE;
              #endif
              
              #if 0
                                              if (!TryGotoModeSD())
                                              {
                                                      TryGotoValidMode(SYS_MODE_LINEIN);
                                              }
              #else
                                              TryGotoValidMode(SYS_MODE_SD);
              #endif
                                      }       
                                      break;
              #endif
1700   2      
1701   2      #ifdef FUNC_CARD_EN
                              case SYS_MODE_SD:                       //current system mode is SD
                                      if(gDeviceError)                //sd-card error
                                      {
                                              DBG(("gDeviceError\n"));
                                              //Èç¹ûSD¿¨³öÏÖ´íÎó£¬ÔòÕâÀï»á³¢ÊÔÖØÐÂ½øÈëSDÄ£Ê½
                                              if(!TryGotoModeSD())
                                              {
              #if defined(AU6210K_JLH_JH82B) || defined(AU6210K_NR_D_8_CSRBT)
                                                      if (!TryGotoModeLINEIN())
                                                      {
                                                              TryGotoValidMode(SYS_MODE_BLUETOOTH);
                                                      }
              #elif defined(AU6210K_HXX_B002)
                                                      TryGotoValidMode(SYS_MODE_BLUETOOTH);
              #else
                                                      TryGotoValidMode(SYS_MODE_USB);
              #endif
                                              }
                                      }
                                      else if(!IsCardLink())          //sd-card removed
                                      {
                                              DBG(("card removed!\n"));
              #if defined(AU6210K_JLH_JH82B) || defined(AU6210K_NR_D_8_CSRBT)
                                              if (!TryGotoModeLINEIN())
                                              {
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 29  

                                                      TryGotoValidMode(SYS_MODE_BLUETOOTH);
                                              }
              #elif defined(AU6210K_HXX_B002)
                                              TryGotoValidMode(SYS_MODE_BLUETOOTH);
              #else
                                              TryGotoValidMode(SYS_MODE_USB);
              #endif
                                      }
                                      break;
              #endif
1737   2      
1738   2      #ifdef FUNC_LINEIN_EN
1739   2                      case SYS_MODE_LINEIN:           //current system mode is LINEIN
1740   2                              if(!IsLineInLink())             //line-in removed
1741   2                              {
1742   3                                      DBG(("line-in removed!\n"));
1743   3                                      TryGotoValidMode(SYS_MODE_BLUETOOTH);
1744   3                              }
1745   2                              break;
1746   2      #endif
1747   2      
1748   2      #if (defined(FUNC_AUDIO_EN) || defined(FUNC_READER_EN) || defined(FUNC_AUDIO_READER_EN))
                              case SYS_MODE_AUDIO:            //current system mode is AUDIO
                              case SYS_MODE_READER:           //current system mode is READER
                              case SYS_MODE_AUDIO_READER:     //current system mode is AUDIO_READER
                                      //DBG(("DevStateCtrl->SYS_MODE_AUDIO\n"));
                                      if(!IsPcLink())                 //pc removed
                                      {
                                              DBG(("pc removed 0!\n"));
                                              WaitMs(400);
                                              if(IsPcInsert())
                                              {
                                                      DBG(("pc !rem"));
                                                      break;
                                              }
                                              DBG(("pc removed!\n"));
              #ifdef AU6210K_ZB_BT007_CSR
                                              TryGotoValidMode(SYS_MODE_SD);
              #else
                                              TryGotoValidMode(SYS_MODE_USB);
              #endif
                                      }
                                      break;
              #endif
1771   2      
1772   2      #ifdef  FUNC_RADIO_EN
1773   2                      case SYS_MODE_RADIO:
1774   2                              break;
1775   2      #endif
1776   2      
1777   2                      case SYS_MODE_NONE: 
1778   2      #ifdef FUN_SYSTEM_POWEROFF_WAIT_TIME
                                      SystemOffTimeMsgPro(Event);
              #endif  
1781   2                              break;
1782   2      
1783   2                      default:
1784   2                              break;
1785   2              }
1786   1      
1787   1              //°´¼üÇÐ»»¼ì²â
1788   1              
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 30  

1789   1              if((Event == MSG_MODE_SW) 
1790   1      #ifdef FUNC_QUICK_RESPONSE_EN
                      || IsSwitchMode
              #endif  
1793   1              )
1794   1              {
1795   2                      DBG(("DevStateCtrl,MODE\n"));
1796   2                      if((gFsInfo.DevID == DEV_ID_OTP) && (gSys.SystemMode == SYS_MODE_OTPDEV))
1797   2                      {
1798   3                              gPlayCtrl.State = PLAY_STATE_STOP;
1799   3                      }
1800   2                      
1801   2      #ifdef  FUNC_DEVICE_FORCEPAUSE_EN
                              gDevicePlayForcePauseFlag = FALSE;
              #endif
1804   2      
1805   2      #ifdef FUNC_BEEP_SOUND_EN       
                              PushKeyBeep(1);
              #endif          
1808   2      
1809   2      #ifndef FUNC_QUICK_RESPONSE_EN
1810   2                      TryGotoNextMode(gSys.SystemMode);
1811   2      #else
                              IsSwitchMode = TRUE;
                              while(IsSwitchMode)
                              {
                                      IsSwitchMode = FALSE;
                                      DBG(("CurMode: %d\n", (WORD)CurMode));
                                      TryGotoNextMode(CurMode);
                              }
              #endif
1820   2              } 
1821   1              
1822   1      #if defined(AU6210K_DEMO)
              #ifdef FUNC_USB_EN
                      if((Event == MSG_MODE_USB) && (gSys.SystemMode != SYS_MODE_USB))
                      {
                              if(IsUsbLinkFlag == TRUE)
                              {
                                      //DBG(("DevStateCtrl,USB MODE\n"));
                                      TryGotoValidModeReturn(SYS_MODE_USB);
                              }
                              else
                              {
                                      //DBG(("DevStateCtrl,NO USB\n"));
                              }
                      }
              #endif
              
              #ifdef FUNC_CARD_EN
                      if((Event == MSG_MODE_SD) && (gSys.SystemMode != SYS_MODE_SD))
                      {
                              if(IsCardLinkFlag == TRUE)
                              {
                                      //DBG(("DevStateCtrl,SD MODE\n"));
                                      TryGotoValidModeReturn(SYS_MODE_SD);
                              }
                              else
                              {
                                      //DBG(("DevStateCtrl,NO CARD\n"));
                              }
                      }       
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 31  

              #endif
              
              #ifdef FUNC_RADIO_EN
                      if((Event == MSG_MODE_FM) && (gSys.SystemMode != SYS_MODE_RADIO))
                      {
                              if(Radio_Name != RADIO_NONE)
                              {
                                      //DBG(("DevStateCtrl,FM MODE\n"));
                                      TryGotoValidModeReturn(SYS_MODE_RADIO);
                              }
                              else
                              {
                                      //DBG(("DevStateCtrl, NO FM or FM Error\n"));
                              }
                      }
              #endif
              
              #ifdef FUNC_LINEIN_EN
                      if((Event == MSG_MODE_AUX) && (gSys.SystemMode != SYS_MODE_LINEIN)) 
                      {
                              if(IsLineInLink())
                              {
                                      //DBG(("DevStateCtrl,AUX MODE\n"));
                                      TryGotoValidModeReturn(SYS_MODE_LINEIN);
                              }
                              else
                              {
                                      //DBG(("DevStateCtrl, NO AUX\n"));
                              }
                      }       
              #endif
              #endif
1883   1      
1884   1      #ifdef FUNC_SNOOZE_EN
                      //SNOOZE °´¼ü¼ì²â
                      if((sAlarmPowerOnFlag == TRUE) && (Event == MSG_SNOOZE))
                      {
                              TryGotoValidMode(SYS_MODE_STANDBY);
                              sSnoozeOnFlag = TRUE;
                      }
              #endif
1892   1      }
1893          
1894          
1895          #ifdef FUNC_STANDBY_EN
              VOID StandbyStateCtrl(VOID)
              {       
              #ifdef AU6210K_BOOMBOX_DEMO
              #ifdef FUNC_ALARM_EN
                      if(gAlarm1OnFlag == TRUE)
                      {
                              gAlarm1OnFlag = FALSE;
                              sAlarmPowerOnFlag = TRUE;
                              gSys.Volume = gAlarm1Volume;
                              gSys.SystemMode = gAlarm1Source;
                              InDacInit(FALSE);
                              TryGotoValidMode(gSys.SystemMode);               
                      }
                      else if(gAlarm2OnFlag == TRUE)
                      {
                              gAlarm2OnFlag = FALSE;
                              sAlarmPowerOnFlag = TRUE;
C51 COMPILER V9.00   DEVCTRL                                                               11/24/2015 14:31:58 PAGE 32  

                              gSys.Volume = gAlarm2Volume;
                              gSys.SystemMode = gAlarm2Source;
                              InDacInit(FALSE);
                              TryGotoValidMode(gSys.SystemMode);
                      }       
              #endif
              #endif
              
              #ifdef FUNC_SNOOZE_EN
                      if((sSnoozeOnFlag == TRUE) && (IsTimeOut(&sSnoozeTimer)))
                      {
                              sSnoozeOnFlag = FALSE;
                              TryGotoValidMode(gSystemExecState);
                      }
              #endif
              }
              #endif
1930          
1931          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    865    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     17       6
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
